<!DOCTYPE html>
<html lang="en" data-theme="light" data-density="default">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Terrarium ‚Äî Agentic Design System</title>
  <link rel="stylesheet" href="terrarium.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Google Fonts ‚Äî Open Source Variable Font Library -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Space+Grotesk:wght@300..700&family=Manrope:wght@200..800&family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&family=Outfit:wght@100..900&family=Rubik:ital,wght@0,300..900;1,300..900&family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Work+Sans:ital,wght@0,100..900;1,100..900&family=Sora:wght@100..800&family=Raleway:ital,wght@0,100..900;1,100..900&family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&family=Fira+Code:wght@300..700&family=IBM+Plex+Sans:ital,wght@0,100..700;1,100..700&family=IBM+Plex+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
  <style>
    /* ========== SHELL LAYOUT ========== */
    .shell { display: grid; grid-template-columns: 240px 1fr 320px; grid-template-rows: auto 1fr; min-height: 100vh; }
    .shell--panel-closed { grid-template-columns: 240px 1fr 0; }
    .shell__header { grid-column: 1 / -1; display: flex; align-items: center; justify-content: space-between; padding: var(--t-space-2) var(--t-space-4); background: var(--t-surface-0); border-bottom: 1px solid var(--t-border-default); position: sticky; top: 0; z-index: 100; }
    .shell__brand { display: flex; align-items: center; gap: var(--t-space-2); }
    .shell__logo { width: 28px; height: 28px; background: linear-gradient(135deg, var(--t-raw-green-500), var(--t-raw-blue-500)); border-radius: var(--t-radius-md); display: flex; align-items: center; justify-content: center; font-size: 16px; }
    .shell__title { font-size: var(--t-text-base); font-weight: var(--t-weight-bold); color: var(--t-fg-primary); }
    .shell__controls { display: flex; align-items: center; gap: var(--t-space-2); }

    /* ========== SIDEBAR NAV ========== */
    .shell__sidebar { padding: var(--t-space-3); background: var(--t-surface-1); border-right: 1px solid var(--t-border-default); overflow-y: auto; height: calc(100vh - 44px); position: sticky; top: 44px; }
    .nav-section { margin-bottom: var(--t-space-4); }
    .nav-section__title { font-size: 10px; font-weight: var(--t-weight-semibold); color: var(--t-fg-tertiary); letter-spacing: 0.08em; text-transform: uppercase; padding: var(--t-space-1) var(--t-space-2); margin-bottom: 2px; }
    .nav-item { display: flex; align-items: center; gap: var(--t-space-2); padding: 6px var(--t-space-2); border-radius: var(--t-radius-sm); font-size: var(--t-text-sm); color: var(--t-fg-secondary); cursor: pointer; border: none; background: none; width: 100%; text-align: left; font-family: var(--t-font-sans); transition: all 0.1s; }
    .nav-item:hover { background: var(--t-bg-secondary); color: var(--t-fg-primary); }
    .nav-item--active { background: var(--t-bg-info); color: var(--t-fg-brand); font-weight: var(--t-weight-medium); }
    .nav-item__dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .nav-item__dot--stable { background: var(--t-raw-green-500); }
    .nav-item__dot--candidate { background: var(--t-raw-blue-500); }
    .nav-item__dot--draft { background: var(--t-raw-amber-500); }

    /* ========== MAIN CONTENT ========== */
    .shell__main { padding: var(--t-space-6); overflow-y: auto; }
    .story { display: none; animation: t-fade-in 0.15s ease; }
    .story--active { display: block; }
    .story__title { font-size: var(--t-text-xl); font-weight: var(--t-weight-bold); color: var(--t-fg-primary); margin-bottom: var(--t-space-1); }
    .story__desc { font-size: var(--t-text-sm); color: var(--t-fg-secondary); line-height: var(--t-leading-normal); max-width: 600px; margin-bottom: var(--t-space-3); }
    .story__meta { display: flex; align-items: center; gap: var(--t-space-2); margin-bottom: var(--t-space-6); }

    /* ========== CANVAS (component preview) ========== */
    .canvas { background: var(--t-surface-0); border: 1px solid var(--t-border-default); border-radius: var(--t-radius-lg); padding: var(--t-space-4); margin-bottom: var(--t-space-4); position: relative; }
    .canvas--dark { background: var(--t-raw-neutral-900); }
    .canvas__label { font-size: 10px; font-weight: var(--t-weight-semibold); color: var(--t-fg-tertiary); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: var(--t-space-2); }
    .canvas__row { display: flex; flex-wrap: wrap; align-items: center; gap: var(--t-space-3); }
    .canvas__edit-hint { position: absolute; top: 8px; right: 12px; font-size: 10px; color: var(--t-fg-tertiary); opacity: 0.6; }

    /* ========== RIGHT PANEL (editor) ========== */
    .shell__panel { background: var(--t-surface-1); border-left: 1px solid var(--t-border-default); overflow-y: auto; height: calc(100vh - 44px); position: sticky; top: 44px; transition: width 0.2s; }
    .shell--panel-closed .shell__panel { overflow: hidden; width: 0; padding: 0; }
    .panel-section { padding: var(--t-space-3) var(--t-space-3); border-bottom: 1px solid var(--t-border-default); }
    .panel-section__title { font-size: 10px; font-weight: var(--t-weight-semibold); color: var(--t-fg-tertiary); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: var(--t-space-2); display: flex; align-items: center; justify-content: space-between; }
    .panel-section__title button { background: none; border: none; color: var(--t-fg-tertiary); cursor: pointer; font-size: 12px; }

    /* Panel controls */
    .ctrl { display: flex; flex-direction: column; gap: 2px; margin-bottom: var(--t-space-2); }
    .ctrl__label { font-size: 11px; font-weight: var(--t-weight-medium); color: var(--t-fg-secondary); display: flex; justify-content: space-between; align-items: center; }
    .ctrl__value { font-family: var(--t-font-mono); font-size: 10px; color: var(--t-fg-tertiary); }
    .ctrl__input { width: 100%; }
    .ctrl__row { display: flex; gap: var(--t-space-2); align-items: center; }
    .ctrl input[type="range"] { width: 100%; height: 4px; -webkit-appearance: none; appearance: none; background: var(--t-border-default); border-radius: 2px; outline: none; }
    .ctrl input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%; background: var(--t-interactive-default); cursor: pointer; }
    .ctrl input[type="color"] { width: 28px; height: 28px; border: 1px solid var(--t-border-default); border-radius: var(--t-radius-sm); cursor: pointer; padding: 0; -webkit-appearance: none; }
    .ctrl input[type="color"]::-webkit-color-swatch-wrapper { padding: 2px; }
    .ctrl input[type="color"]::-webkit-color-swatch { border: none; border-radius: 2px; }
    .ctrl input[type="text"], .ctrl input[type="number"], .ctrl select {
      width: 100%; padding: 4px 8px; font-size: 12px; font-family: var(--t-font-mono);
      background: var(--t-surface-0); border: 1px solid var(--t-border-default); border-radius: var(--t-radius-sm);
      color: var(--t-fg-primary); outline: none;
    }
    .ctrl select { font-family: var(--t-font-sans); }
    .ctrl input:focus, .ctrl select:focus { border-color: var(--t-border-focus); }

    .ctrl-group { display: grid; grid-template-columns: 1fr 1fr; gap: var(--t-space-2); }

    /* Chip buttons for variant selection */
    .chip-row { display: flex; flex-wrap: wrap; gap: 4px; }
    .chip { padding: 3px 10px; font-size: 11px; border-radius: var(--t-radius-full); border: 1px solid var(--t-border-default); background: var(--t-surface-0); color: var(--t-fg-secondary); cursor: pointer; font-family: var(--t-font-sans); transition: all 0.1s; }
    .chip:hover { border-color: var(--t-border-strong); }
    .chip--active { background: var(--t-interactive-default); color: var(--t-fg-inverse); border-color: var(--t-interactive-default); }

    /* ========== TOKEN EDITOR ========== */
    .swatch-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: var(--t-space-2); }
    .swatch { border: 1px solid var(--t-border-default); border-radius: var(--t-radius-sm); overflow: hidden; cursor: pointer; transition: box-shadow 0.1s; }
    .swatch:hover { box-shadow: var(--t-shadow-2); }
    .swatch--editing { box-shadow: 0 0 0 2px var(--t-interactive-default); }
    .swatch__color { height: 36px; position: relative; }
    .swatch__color input[type="color"] { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    .swatch__info { padding: 4px 6px; }
    .swatch__name { font-size: 10px; font-weight: var(--t-weight-medium); color: var(--t-fg-primary); }
    .swatch__value { font-size: 9px; font-family: var(--t-font-mono); color: var(--t-fg-tertiary); }

    /* ========== COMPONENT PIPELINE ========== */
    .pipeline-tabs { display: flex; gap: 0; border-bottom: 2px solid var(--t-border-default); margin-bottom: var(--t-space-4); }
    .pipeline-tab { padding: 10px 20px; font-size: var(--t-text-sm); font-weight: var(--t-weight-semibold); color: var(--t-fg-tertiary); background: none; border: none; border-bottom: 2px solid transparent; margin-bottom: -2px; cursor: pointer; font-family: var(--t-font-sans); transition: all 0.15s; display: flex; align-items: center; gap: var(--t-space-2); }
    .pipeline-tab:hover { color: var(--t-fg-primary); background: var(--t-bg-secondary); }
    .pipeline-tab--active { color: var(--t-fg-brand); border-bottom-color: var(--t-interactive-default); }
    .pipeline-tab__count { display: inline-flex; align-items: center; justify-content: center; min-width: 20px; height: 20px; padding: 0 6px; border-radius: var(--t-radius-full); background: var(--t-bg-secondary); font-size: 11px; font-weight: 600; }
    .pipeline-tab--active .pipeline-tab__count { background: var(--t-interactive-default); color: var(--t-fg-inverse); }
    .pipeline-panel { display: none; }
    .pipeline-panel--active { display: block; }

    .pipeline-empty { text-align: center; padding: var(--t-space-8) var(--t-space-4); color: var(--t-fg-tertiary); }
    .pipeline-empty__icon { font-size: 48px; margin-bottom: var(--t-space-2); opacity: 0.5; }
    .pipeline-empty__text { font-size: var(--t-text-sm); max-width: 360px; margin: 0 auto; line-height: var(--t-leading-relaxed); }

    .comp-card { background: var(--t-surface-0); border: 1px solid var(--t-border-default); border-radius: var(--t-radius-lg); padding: var(--t-space-4); margin-bottom: var(--t-space-3); transition: box-shadow 0.15s; }
    .comp-card:hover { box-shadow: var(--t-shadow-2); }
    .comp-card__header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--t-space-2); }
    .comp-card__name { font-size: var(--t-text-base); font-weight: var(--t-weight-bold); color: var(--t-fg-primary); }
    .comp-card__zone-badge { font-size: 9px; padding: 2px 8px; border-radius: var(--t-radius-full); font-weight: 600; }
    .comp-card__zone-badge--nursery { background: rgba(45,106,79,0.12); color: var(--t-raw-green-700); }
    .comp-card__zone-badge--workshop { background: rgba(34,139,230,0.12); color: var(--t-raw-blue-700); }
    .comp-card__zone-badge--canopy { background: rgba(245,159,0,0.12); color: var(--t-raw-amber-700); }
    .comp-card__desc { font-size: var(--t-text-sm); color: var(--t-fg-secondary); line-height: var(--t-leading-normal); margin-bottom: var(--t-space-3); }
    .comp-card__agents { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: var(--t-space-3); }
    .comp-card__agent-chip { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: var(--t-radius-full); font-size: 10px; font-weight: 600; background: var(--t-surface-1); border: 1px solid var(--t-border-default); }
    .comp-card__agent-chip--approved { background: rgba(45,106,79,0.08); border-color: var(--t-raw-green-300); color: var(--t-raw-green-700); }
    .comp-card__agent-chip--pending { opacity: 0.5; }
    .comp-card__agent-chip__dot { width: 6px; height: 6px; border-radius: 50%; }
    .comp-card__proposals { font-size: 11px; color: var(--t-fg-tertiary); margin-bottom: var(--t-space-2); }
    .comp-card__actions { display: flex; gap: var(--t-space-2); flex-wrap: wrap; }
    .comp-card__preview { margin: var(--t-space-3) 0; padding: var(--t-space-3); background: var(--t-surface-1); border-radius: var(--t-radius-md); border: 1px dashed var(--t-border-default); }

    .new-proposal-form { background: var(--t-surface-1); border: 1px solid var(--t-border-default); border-radius: var(--t-radius-lg); padding: var(--t-space-4); margin-bottom: var(--t-space-4); }
    .new-proposal-form__title { font-size: var(--t-text-sm); font-weight: var(--t-weight-semibold); color: var(--t-fg-primary); margin-bottom: var(--t-space-3); display: flex; align-items: center; gap: var(--t-space-2); }
    .new-proposal-form__row { display: flex; gap: var(--t-space-2); margin-bottom: var(--t-space-2); }
    .new-proposal-form__row > input, .new-proposal-form__row > select, .new-proposal-form__row > textarea { flex: 1; padding: 6px 10px; font-size: 12px; font-family: var(--t-font-sans); background: var(--t-surface-0); border: 1px solid var(--t-border-default); border-radius: var(--t-radius-sm); color: var(--t-fg-primary); outline: none; }
    .new-proposal-form__row > textarea { min-height: 60px; resize: vertical; }
    .new-proposal-form__row > input:focus, .new-proposal-form__row > select:focus, .new-proposal-form__row > textarea:focus { border-color: var(--t-border-focus); }

    /* ========== TYPE SCALE ========== */
    .type-sample { padding: var(--t-space-2) 0; border-bottom: 1px solid var(--t-border-default); }
    .type-sample:last-child { border-bottom: none; }
    .type-sample__label { font-size: 10px; font-family: var(--t-font-mono); color: var(--t-fg-tertiary); margin-bottom: 2px; }

    /* ========== SPACING BARS ========== */
    .space-bar { display: flex; align-items: center; gap: var(--t-space-2); margin-bottom: 4px; }
    .space-bar__label { font-size: 10px; font-family: var(--t-font-mono); color: var(--t-fg-tertiary); min-width: 90px; }
    .space-bar__visual { height: 12px; background: linear-gradient(90deg, var(--t-raw-blue-300), var(--t-raw-blue-500)); border-radius: 2px; transition: width 0.2s; }

    /* ========== PHILOSOPHY CARDS ========== */
    .philosophy-card { background: var(--t-surface-1); border-radius: var(--t-radius-lg); padding: var(--t-space-4); margin-bottom: var(--t-space-3); }
    .philosophy-card__title { font-size: var(--t-text-base); font-weight: var(--t-weight-semibold); color: var(--t-fg-primary); margin-bottom: var(--t-space-1); }
    .philosophy-card__body { font-size: var(--t-text-sm); color: var(--t-fg-secondary); line-height: var(--t-leading-normal); }
    .philosophy-card__num { display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; background: var(--t-bg-brand); color: var(--t-fg-inverse); border-radius: 50%; font-size: 11px; font-weight: var(--t-weight-bold); margin-right: var(--t-space-2); }

    /* ========== AGENT GOVERNANCE SIM ‚Äî Visual Terrarium ========== */
    .agent-sim { border: 1px solid var(--t-border-default); border-radius: var(--t-radius-lg); overflow: hidden; }
    .agent-sim__toolbar { display: flex; gap: var(--t-space-2); padding: var(--t-space-2) var(--t-space-3); background: var(--t-surface-0); border-bottom: 1px solid var(--t-border-default); flex-wrap: wrap; }

    /* ========== TERRARIUM VIEW ‚Äî Live Pipeline Visualization ========== */
    .terrarium { position: relative; display: grid; grid-template-rows: auto 1fr auto; gap: 0; background: var(--t-surface-0); border: 1px solid var(--t-border-default); border-radius: var(--t-radius-lg); overflow: hidden; }

    /* Top row: zone indicator */
    .terrarium__zone { display: flex; align-items: center; justify-content: center; gap: var(--t-space-2); padding: var(--t-space-2) var(--t-space-3); border-bottom: 2px solid var(--t-border-default); transition: border-color 0.4s, background 0.4s; }
    .terrarium__zone--nursery { border-bottom-color: var(--t-raw-green-400); background: rgba(45,106,79,0.04); }
    .terrarium__zone--workshop { border-bottom-color: var(--t-raw-blue-400); background: rgba(0,119,182,0.04); }
    .terrarium__zone--canopy { border-bottom-color: var(--t-raw-amber-400); background: rgba(245,158,11,0.04); }
    [data-theme="dark"] .terrarium__zone--nursery { background: rgba(45,106,79,0.08); }
    [data-theme="dark"] .terrarium__zone--workshop { background: rgba(0,119,182,0.08); }
    [data-theme="dark"] .terrarium__zone--canopy { background: rgba(245,158,11,0.08); }
    .terrarium__zone-label { font-size: var(--t-text-sm); font-weight: var(--t-weight-semibold); color: var(--t-fg-primary); }

    /* Middle row: the stage ‚Äî agents + component */
    .terrarium__stage { display: grid; grid-template-columns: 1fr auto 1fr; gap: var(--t-space-3); padding: var(--t-space-4); align-items: start; min-height: 180px; }

    /* Agent columns ‚Äî 3 agents each side, stacked vertically */
    .terrarium__agent-col { display: flex; flex-direction: column; gap: var(--t-space-2); }
    .terrarium__agent-col--right { align-items: flex-end; }

    .terrarium__agent { display: flex; align-items: center; gap: var(--t-space-2); padding: 6px var(--t-space-2); border-radius: var(--t-radius-md); background: var(--t-surface-1); border: 1px solid transparent; transition: all 0.25s; cursor: default; min-width: 0; }
    .terrarium__agent--right { flex-direction: row-reverse; }
    .terrarium__agent:hover { border-color: var(--t-border-default); box-shadow: var(--t-shadow-1); }
    .terrarium__agent--speaking { border-color: var(--t-border-default); box-shadow: var(--t-shadow-2); }

    .terrarium__avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: var(--t-weight-bold); color: white; flex-shrink: 0; transition: box-shadow 0.3s; }
    .terrarium__avatar--speaking { box-shadow: 0 0 0 2px var(--t-surface-0), 0 0 0 4px currentColor; }

    .terrarium__agent-info { min-width: 0; }
    .terrarium__agent-name { font-size: 10px; font-weight: var(--t-weight-semibold); color: var(--t-fg-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
    .terrarium__agent-status { font-size: 9px; color: var(--t-fg-tertiary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.3; }

    /* Center: component being worked on */
    .terrarium__center { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 160px; max-width: 200px; }
    .terrarium__component { background: var(--t-surface-0); border: 2px solid var(--t-border-default); border-radius: var(--t-radius-lg); padding: var(--t-space-3); text-align: center; box-shadow: var(--t-shadow-1); opacity: 0; transform: scale(0.85); transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); width: 100%; }
    .terrarium__component--visible { opacity: 1; transform: scale(1); }
    .terrarium__component--evolving { animation: terr-pulse 2s ease-in-out infinite; }
    @keyframes terr-pulse { 0%,100% { box-shadow: var(--t-shadow-1); } 50% { box-shadow: 0 0 16px rgba(34,139,230,0.15), var(--t-shadow-2); } }
    .terrarium__component-label { font-size: 10px; color: var(--t-fg-tertiary); margin-top: var(--t-space-1); font-weight: var(--t-weight-medium); }

    /* SVG connections between agents and center */
    .terrarium__connection { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
    .terrarium__connection line { stroke: var(--t-raw-blue-300); stroke-width: 1.5; stroke-dasharray: 6 4; opacity: 0; transition: opacity 0.4s; }
    .terrarium__connection line.active { opacity: 0.4; animation: terr-dash 1s linear infinite; }
    @keyframes terr-dash { to { stroke-dashoffset: -10; } }

    /* Agent speech bubbles ‚Äî positioned next to agents, not absolute on canvas */
    .terrarium__bubble { max-width: 200px; background: var(--t-surface-0); border: 1px solid var(--t-border-default); border-radius: var(--t-radius-md); padding: 6px 8px; font-size: 10px; line-height: 1.4; color: var(--t-fg-primary); box-shadow: var(--t-shadow-1); opacity: 0; transform: translateY(4px); transition: opacity 0.25s, transform 0.25s; margin-top: 2px; }
    .terrarium__bubble--visible { opacity: 1; transform: translateY(0); }
    .terrarium__bubble .cite { font-size: 9px; color: var(--t-fg-tertiary); font-style: italic; display: block; margin-top: 3px; }
    .terrarium__bubble .b-mode { font-size: 8px; font-weight: var(--t-weight-semibold); color: var(--t-fg-brand); text-transform: uppercase; letter-spacing: 0.04em; display: block; margin-bottom: 1px; }

    /* Phase pill ‚Äî centered below the component */
    .terrarium__phase { background: var(--t-surface-1); border: 1px solid var(--t-border-default); border-radius: var(--t-radius-full); padding: 3px 12px; font-size: 11px; font-weight: var(--t-weight-semibold); color: var(--t-fg-primary); opacity: 0; transition: opacity 0.3s; white-space: nowrap; margin-top: var(--t-space-2); }
    .terrarium__phase--visible { opacity: 1; }

    /* Bottom row: mini activity log */
    .terrarium__log-mini { border-top: 1px solid var(--t-border-default); padding: var(--t-space-2) var(--t-space-3); max-height: 100px; overflow-y: auto; font-family: var(--t-font-mono); font-size: 9px; line-height: 1.6; color: var(--t-fg-secondary); background: var(--t-surface-1); scrollbar-width: thin; }
    .terrarium__log-mini::-webkit-scrollbar { width: 3px; }
    .terrarium__log-mini::-webkit-scrollbar-thumb { background: var(--t-border-default); border-radius: 2px; }

    /* ========== EXPORT / CODE PANEL ========== */
    .code-block { background: var(--t-raw-neutral-900); color: var(--t-raw-neutral-200); padding: var(--t-space-3); border-radius: var(--t-radius-md); font-family: var(--t-font-mono); font-size: 11px; line-height: 1.6; overflow-x: auto; margin-bottom: var(--t-space-3); white-space: pre-wrap; word-break: break-all; max-height: 300px; overflow-y: auto; }

    /* ========== THEME BUILDER ========== */
    .theme-preview { display: grid; grid-template-columns: 1fr 1fr; gap: var(--t-space-2); margin-bottom: var(--t-space-3); }
    .theme-preview__card { padding: var(--t-space-3); border-radius: var(--t-radius-md); text-align: center; font-size: 11px; font-weight: var(--t-weight-medium); }

    /* ========== EDITABLE TEXT ========== */
    [contenteditable] { outline: none; border-radius: var(--t-radius-sm); padding: 1px 2px; transition: background 0.1s; }
    [contenteditable]:hover { background: rgba(34, 139, 230, 0.05); }
    [contenteditable]:focus { background: rgba(34, 139, 230, 0.1); box-shadow: 0 0 0 1px var(--t-border-focus); }

    /* ========== GOVERNANCE APPROVAL QUEUE ========== */
    .proposal-card { background: var(--t-surface-0); border: 1px solid var(--t-border-default); border-radius: var(--t-radius-lg); padding: var(--t-space-3); margin-bottom: var(--t-space-3); transition: box-shadow 0.2s; }
    .proposal-card:hover { box-shadow: var(--t-shadow-1); }
    .proposal-card--vetoed { border-left: 3px solid var(--t-raw-red-500); }
    .proposal-card--staged { border-left: 3px solid var(--t-raw-green-500); opacity: 0.85; }
    .proposal-card__header { display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--t-space-2); }
    .proposal-card__agent { display: flex; align-items: center; gap: var(--t-space-2); }
    .proposal-card__avatar { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: var(--t-weight-bold); color: white; }
    .proposal-card__diff { background: var(--t-raw-neutral-900); color: var(--t-raw-neutral-200); padding: var(--t-space-2); border-radius: var(--t-radius-md); font-family: var(--t-font-mono); font-size: 10px; line-height: 1.5; margin: var(--t-space-2) 0; overflow-x: auto; }
    .proposal-card__diff .diff-old { color: var(--t-raw-red-400); }
    .proposal-card__diff .diff-new { color: var(--t-raw-green-400); }
    .proposal-card__approvals { display: flex; gap: 4px; flex-wrap: wrap; margin: var(--t-space-2) 0; }
    .proposal-card__approvals .approval-chip { padding: 1px 6px; font-size: 9px; border-radius: var(--t-radius-full); border: 1px solid var(--t-border-default); }
    .proposal-card__approvals .approval-chip--yes { background: var(--t-raw-green-50); border-color: var(--t-raw-green-300); color: var(--t-raw-green-700); }
    .proposal-card__approvals .approval-chip--no { background: var(--t-raw-red-50); border-color: var(--t-raw-red-300); color: var(--t-raw-red-700); }
    .proposal-card__approvals .approval-chip--pending { background: var(--t-raw-amber-50); border-color: var(--t-raw-amber-300); color: var(--t-raw-amber-700); }
    .proposal-card__actions { display: flex; gap: var(--t-space-2); margin-top: var(--t-space-2); }
    .proposal-card__veto { background: var(--t-raw-red-50); border-left: 3px solid var(--t-raw-red-500); padding: var(--t-space-2); border-radius: var(--t-radius-md); margin: var(--t-space-2) 0; font-size: 11px; }
    .proposal-card__veto b { color: var(--t-raw-red-700); }
    .gov-push-bar { display: flex; align-items: center; justify-content: space-between; padding: var(--t-space-3); background: var(--t-surface-1); border-radius: var(--t-radius-lg); margin-top: var(--t-space-3); border: 1px solid var(--t-border-default); }
    .gov-push-bar__count { font-size: var(--t-text-sm); font-weight: var(--t-weight-semibold); }
    .gov-badge { position: relative; }
    .gov-badge__count { position: absolute; top: -2px; right: -6px; background: var(--t-raw-red-500); color: white; border-radius: 50%; width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: var(--t-weight-bold); }
    .audit-entry { padding: var(--t-space-2); border-bottom: 1px solid var(--t-border-default); font-size: 11px; line-height: 1.5; }
    .audit-entry__time { color: var(--t-fg-tertiary); font-family: var(--t-font-mono); font-size: 10px; }
    .audit-entry__actor { font-weight: var(--t-weight-semibold); }
    .proposal-preview-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 200; }
    .proposal-preview { background: var(--t-surface-0); border-radius: var(--t-radius-lg); padding: var(--t-space-4); max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: var(--t-shadow-4); }
    .proposal-preview__grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--t-space-3); margin: var(--t-space-3) 0; }
    .proposal-preview__side { padding: var(--t-space-3); border-radius: var(--t-radius-md); border: 1px solid var(--t-border-default); }

    /* ========== TOOLTIP SYSTEM ========== */
    [data-tip] { position: relative; border-bottom: 1px dotted var(--t-raw-blue-400); cursor: help; }
    [data-tip]:hover { border-bottom-color: var(--t-interactive-default); }
    .t-tip { position: fixed; z-index: 300; max-width: 320px; padding: 10px 14px; background: var(--t-raw-neutral-900); color: var(--t-raw-neutral-100); border-radius: var(--t-radius-md); font-size: 12px; line-height: 1.5; box-shadow: var(--t-shadow-3); pointer-events: none; opacity: 0; transform: translateY(4px); transition: opacity 0.15s, transform 0.15s; font-family: var(--t-font-sans); font-weight: var(--t-weight-regular); }
    .t-tip--visible { opacity: 1; transform: translateY(0); }
    .t-tip__title { font-weight: var(--t-weight-semibold); margin-bottom: 3px; font-size: 11px; color: var(--t-raw-blue-300); text-transform: uppercase; letter-spacing: 0.04em; }
    .t-tip__source { font-size: 9px; color: var(--t-raw-neutral-500); margin-top: 4px; font-style: italic; }

    /* ========== KNOWLEDGE BASE / WIKI ========== */
    .wiki-search { width: 100%; padding: 8px 12px; font-size: var(--t-text-sm); border: 1px solid var(--t-border-default); border-radius: var(--t-radius-md); background: var(--t-surface-0); color: var(--t-fg-primary); font-family: var(--t-font-sans); outline: none; margin-bottom: var(--t-space-3); }
    .wiki-search:focus { border-color: var(--t-border-focus); box-shadow: 0 0 0 2px var(--t-raw-blue-50); }
    .wiki-entry { padding: var(--t-space-3); border: 1px solid var(--t-border-default); border-radius: var(--t-radius-md); margin-bottom: var(--t-space-2); background: var(--t-surface-0); transition: box-shadow 0.1s; }
    .wiki-entry:hover { box-shadow: var(--t-shadow-1); }
    .wiki-entry__term { font-size: var(--t-text-base); font-weight: var(--t-weight-semibold); color: var(--t-fg-primary); margin-bottom: 4px; display: flex; align-items: center; gap: var(--t-space-2); }
    .wiki-entry__tag { font-size: 9px; padding: 1px 6px; border-radius: var(--t-radius-full); border: 1px solid var(--t-border-default); color: var(--t-fg-tertiary); font-weight: var(--t-weight-medium); }
    .wiki-entry__def { font-size: var(--t-text-sm); color: var(--t-fg-secondary); line-height: 1.5; }
    .wiki-entry__source { font-size: 10px; color: var(--t-fg-tertiary); margin-top: 4px; font-style: italic; }
    .wiki-entry__rule { font-size: 11px; color: var(--t-raw-amber-700); background: var(--t-raw-amber-50); padding: 4px 8px; border-radius: var(--t-radius-sm); margin-top: 6px; border-left: 3px solid var(--t-raw-amber-400); }
    [data-theme="dark"] .wiki-entry__rule { color: var(--t-raw-amber-300); background: rgba(245,159,11,0.1); }
    .wiki-category { margin-bottom: var(--t-space-4); }
    .wiki-category__title { font-size: 11px; font-weight: var(--t-weight-semibold); color: var(--t-fg-tertiary); text-transform: uppercase; letter-spacing: 0.06em; padding-bottom: var(--t-space-1); margin-bottom: var(--t-space-2); border-bottom: 1px solid var(--t-border-default); }

    /* ========== SEED VAULT ========== */
    .vault-item { padding: var(--t-space-3); border: 1px solid var(--t-border-default); border-radius: var(--t-radius-md); margin-bottom: var(--t-space-2); background: var(--t-surface-0); border-left: 3px solid var(--t-raw-neutral-400); position: relative; }
    .vault-item--revivable { border-left-color: var(--t-raw-green-400); }
    .vault-item__header { display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--t-space-1); }
    .vault-item__name { font-weight: var(--t-weight-semibold); color: var(--t-fg-primary); }
    .vault-item__meta { font-size: 11px; color: var(--t-fg-tertiary); line-height: 1.4; }
    .vault-item__reason { font-size: var(--t-text-sm); color: var(--t-fg-secondary); line-height: 1.4; margin-top: 4px; }
    .vault-item__context { font-size: 10px; color: var(--t-fg-tertiary); background: var(--t-surface-1); padding: var(--t-space-2); border-radius: var(--t-radius-sm); margin-top: var(--t-space-2); font-family: var(--t-font-mono); }

    /* ========== FULL SIM LOG ========== */
    .sim-transcript { background: var(--t-raw-neutral-900); color: var(--t-raw-neutral-200); border-radius: var(--t-radius-lg); padding: var(--t-space-3); font-family: var(--t-font-mono); font-size: 11px; line-height: 1.7; max-height: 500px; overflow-y: auto; margin-top: var(--t-space-3); border: 1px solid var(--t-raw-neutral-700); }
    .sim-transcript .tr-phase { color: var(--t-raw-amber-300); font-weight: var(--t-weight-semibold); display: block; margin-top: 8px; border-top: 1px solid var(--t-raw-neutral-700); padding-top: 8px; }
    .sim-transcript .tr-agent { font-weight: var(--t-weight-semibold); }
    .sim-transcript .tr-agent--ds { color: var(--t-raw-blue-400); }
    .sim-transcript .tr-agent--ts { color: var(--t-raw-amber-400); }
    .sim-transcript .tr-agent--ag { color: var(--t-raw-green-400); }
    .sim-transcript .tr-agent--pl { color: var(--t-raw-red-300); }
    .sim-transcript .tr-agent--ca { color: var(--t-raw-neutral-400); }
    .sim-transcript .tr-agent--px { color: var(--t-raw-blue-300); }
    .sim-transcript .tr-cite { color: var(--t-raw-neutral-500); font-style: italic; }
    .sim-transcript .tr-proposal { color: var(--t-raw-green-400); font-style: italic; }
    .sim-transcript-toggle { display: flex; align-items: center; gap: var(--t-space-2); margin-top: var(--t-space-3); cursor: pointer; font-size: 12px; color: var(--t-fg-secondary); border: none; background: none; font-family: var(--t-font-sans); padding: 4px 0; }
    .sim-transcript-toggle:hover { color: var(--t-fg-primary); }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 1024px) { .shell { grid-template-columns: 1fr; } .shell__sidebar, .shell__panel { display: none; } }

    /* ========== MISC ========== */
    .badge-row { display: flex; gap: 4px; flex-wrap: wrap; }
    .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--t-space-2); margin-bottom: var(--t-space-6); }
    .stat-card { background: var(--t-surface-0); border: 1px solid var(--t-border-default); border-radius: var(--t-radius-md); padding: var(--t-space-3); text-align: center; }
    .stat-card__number { font-size: var(--t-text-xl); font-weight: var(--t-weight-bold); }
    .stat-card__label { font-size: 11px; color: var(--t-fg-secondary); }
    .zone-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--t-space-2); }
    .zone-card { border-left: 3px solid; padding: var(--t-space-3); background: var(--t-surface-0); border-radius: var(--t-radius-md); border-top: 1px solid var(--t-border-default); border-right: 1px solid var(--t-border-default); border-bottom: 1px solid var(--t-border-default); }
  </style>
</head>
<body>
<div class="shell" id="shell">
  <!-- ==================== HEADER ==================== -->
  <header class="shell__header">
    <div class="shell__brand">
      <div class="shell__logo">üåø</div>
      <span class="shell__title">Terrarium</span>
    </div>
    <div class="shell__controls">
      <label class="t-toggle" style="transform: scale(0.85);">
        <input type="checkbox" class="t-toggle__input" id="themeToggle">
        <span class="t-toggle__track"><span class="t-toggle__thumb"></span></span>
        <span class="t-toggle__label" style="font-size:11px;">Dark</span>
      </label>
      <select class="ctrl__input" id="densitySelect" style="width:auto;padding:3px 6px;font-size:11px;min-width:90px;">
        <option value="compact">Compact</option>
        <option value="default" selected>Default</option>
        <option value="comfortable">Comfortable</option>
      </select>
      <button class="t-btn t-btn--ghost" style="min-height:28px;padding:2px 8px;font-size:11px;" id="undoBtn" title="Undo (Ctrl+Z)" onclick="undo()" disabled>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M3 8h8a3 3 0 0 1 0 6H9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 5L3 8l3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <button class="t-btn t-btn--ghost" style="min-height:28px;padding:2px 8px;font-size:11px;" id="redoBtn" title="Redo (Ctrl+Shift+Z)" onclick="redo()" disabled>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M13 8H5a3 3 0 0 0 0 6h2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 5l3 3-3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <span id="undoCount" style="font-size:10px;color:var(--t-fg-tertiary);min-width:30px;text-align:center;"></span>
      <button class="t-btn t-btn--ghost" style="min-height:28px;padding:2px 8px;font-size:11px;" id="togglePanel" title="Toggle editor panel">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M10 2v12M2 2h12v12H2z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <button class="t-btn t-btn--ghost" style="min-height:28px;padding:2px 8px;font-size:11px;" id="exportBtn" title="Export tokens">Export</button>
    </div>
  </header>

  <!-- ==================== SIDEBAR ==================== -->
  <nav class="shell__sidebar" aria-label="Navigation">
    <div class="nav-section">
      <div class="nav-section__title">Overview</div>
      <button class="nav-item nav-item--active" data-target="welcome" onclick="nav(this)">Welcome</button>
      <button class="nav-item" data-target="philosophy" onclick="nav(this)">Philosophy</button>
      <button class="nav-item" data-target="designerlog" onclick="nav(this)">Designer's Log</button>
      <button class="nav-item" data-target="agents" onclick="nav(this)">Component Pipeline</button>
      <button class="nav-item gov-badge" data-target="approvals" onclick="nav(this)">Approval Queue <span class="gov-badge__count" id="navApprovalCount" style="display:none;">0</span></button>
      <button class="nav-item" data-target="seedvault" onclick="nav(this)"><span class="nav-item__dot" style="background:var(--t-raw-neutral-400);"></span>Seed Vault</button>
      <button class="nav-item" data-target="wiki" onclick="nav(this)">Knowledge Base</button>
    </div>
    <div class="nav-section">
      <div class="nav-section__title">Foundations</div>
      <button class="nav-item" data-target="colors" onclick="nav(this)"><span class="nav-item__dot nav-item__dot--stable"></span>Colors</button>
      <button class="nav-item" data-target="typography" onclick="nav(this)"><span class="nav-item__dot nav-item__dot--stable"></span>Typography</button>
      <button class="nav-item" data-target="spacing" onclick="nav(this)"><span class="nav-item__dot nav-item__dot--stable"></span>Spacing &amp; Radius</button>
      <button class="nav-item" data-target="elevation" onclick="nav(this)"><span class="nav-item__dot nav-item__dot--stable"></span>Elevation</button>
    </div>
    <div class="nav-section">
      <div class="nav-section__title">Primitives</div>
      <button class="nav-item" data-target="button" onclick="nav(this)"><span class="nav-item__dot nav-item__dot--stable"></span>Button</button>
      <button class="nav-item" data-target="input" onclick="nav(this)"><span class="nav-item__dot nav-item__dot--stable"></span>Input</button>
      <button class="nav-item" data-target="badge" onclick="nav(this)"><span class="nav-item__dot nav-item__dot--stable"></span>Badge</button>
      <button class="nav-item" data-target="avatar" onclick="nav(this)"><span class="nav-item__dot nav-item__dot--stable"></span>Avatar</button>
      <button class="nav-item" data-target="toggle" onclick="nav(this)"><span class="nav-item__dot nav-item__dot--draft"></span>Toggle</button>
    </div>
    <div class="nav-section">
      <div class="nav-section__title">Composites</div>
      <button class="nav-item" data-target="card" onclick="nav(this)"><span class="nav-item__dot nav-item__dot--candidate"></span>Card</button>
      <button class="nav-item" data-target="dialog" onclick="nav(this)"><span class="nav-item__dot nav-item__dot--candidate"></span>Dialog</button>
      <button class="nav-item" data-target="toast" onclick="nav(this)"><span class="nav-item__dot nav-item__dot--candidate"></span>Toast</button>
      <button class="nav-item" data-target="tabs" onclick="nav(this)"><span class="nav-item__dot nav-item__dot--candidate"></span>Tabs</button>
    </div>
    <div class="nav-section">
      <div class="nav-section__title">Theme</div>
      <button class="nav-item" data-target="theme" onclick="nav(this)">Theme Builder</button>
      <button class="nav-item" data-target="export" onclick="nav(this)">Export Tokens</button>
    </div>
  </nav>

  <!-- ==================== MAIN CONTENT ==================== -->
  <main class="shell__main" id="mainContent">

    <!-- WELCOME -->
    <section class="story story--active" id="story-welcome">
      <h1 class="story__title" contenteditable="true" spellcheck="false">Welcome to Terrarium</h1>
      <p class="story__desc" contenteditable="true" spellcheck="false">A novel, agentic-first design system that grows through use. Built on <span data-tip="jtbd">Jobs to Be Done</span> philosophy, governed by collaborative <span data-tip="agent-governance">agents</span>, and designed to discover its own shape ‚Äî like a living <span data-tip="terrarium-model">terrarium</span>.</p>
      <div class="stat-grid">
        <div class="stat-card"><div class="stat-card__number" style="color:var(--t-fg-brand);">180+</div><div class="stat-card__label">Design Tokens</div></div>
        <div class="stat-card"><div class="stat-card__number" style="color:var(--t-raw-green-600);">11</div><div class="stat-card__label">Components</div></div>
        <div class="stat-card"><div class="stat-card__number" style="color:var(--t-raw-amber-600);">6</div><div class="stat-card__label"><span data-tip="agent-governance">Agent Roles</span></div></div>
        <div class="stat-card"><div class="stat-card__number" style="color:var(--t-raw-neutral-600);">4</div><div class="stat-card__label"><span data-tip="eco-zones">Eco Zones</span></div></div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:var(--t-space-3);margin-bottom:var(--t-space-6);">
        <div class="t-card t-card--elevated"><div class="t-card__header"><h3 class="t-heading-sm" contenteditable="true">Function First</h3></div><div class="t-card__body"><p class="t-body-sm" style="color:var(--t-fg-secondary);" contenteditable="true">Every component solves a real, repeatable problem. If it doesn't work, nothing else matters.</p></div></div>
        <div class="t-card t-card--elevated"><div class="t-card__header"><h3 class="t-heading-sm" contenteditable="true">Affordance Always</h3></div><div class="t-card__body"><p class="t-body-sm" style="color:var(--t-fg-secondary);" contenteditable="true">A button looks tappable. An input looks writable. You know what to do at a glance.</p></div></div>
        <div class="t-card t-card--elevated"><div class="t-card__header"><h3 class="t-heading-sm" contenteditable="true">Emotion Through Quality</h3></div><div class="t-card__body"><p class="t-body-sm" style="color:var(--t-fg-secondary);" contenteditable="true">Trust is earned through competence. Design for excellence, and confidence follows.</p></div></div>
      </div>
      <h2 class="t-heading-sm" style="margin-bottom:var(--t-space-2);">Maturity Legend</h2>
      <div class="t-inline t-gap-4" style="flex-wrap:wrap;"><span class="t-badge t-badge--stable"><span data-tip="stable">Stable</span></span> Proven <span class="t-badge t-badge--candidate"><span data-tip="candidate">Candidate</span></span> Validating <span class="t-badge t-badge--draft"><span data-tip="draft">Draft</span></span> Hypothesis</div>
    </section>

    <!-- PHILOSOPHY -->
    <section class="story" id="story-philosophy">
      <h1 class="story__title">Design Philosophy</h1>
      <p class="story__desc" contenteditable="true">Terrarium is grounded in Jobs to Be Done ‚Äî the system exists to help teams build consistent, high-quality interfaces without reinventing solved problems.</p>
      <div class="philosophy-card"><div class="philosophy-card__title"><span class="philosophy-card__num">1</span><span data-tip="functional-dimension">Functional Dimension</span></div><div class="philosophy-card__body" contenteditable="true">"Does this component do what I need it to do?" A button submits. An input captures text. A dialog traps focus. Function is the non-negotiable foundation.</div></div>
      <div class="philosophy-card"><div class="philosophy-card__title"><span class="philosophy-card__num">2</span><span data-tip="affordance">Consistency as Affordance</span></div><div class="philosophy-card__body" contenteditable="true">When you look at a button, you know it's a button. You know you can press it. This consistency of visual language is the unique value proposition of a design system.</div></div>
      <div class="philosophy-card"><div class="philosophy-card__title"><span class="philosophy-card__num">3</span><span data-tip="emotional-quality">Emotional Quality</span></div><div class="philosophy-card__body" contenteditable="true">Emotional resonance is earned through functional excellence. Don't design for feelings ‚Äî design for competence, and the feelings follow.</div></div>
      <h2 class="t-heading-sm" style="margin:var(--t-space-6) 0 var(--t-space-3);">The Terrarium Model</h2>
      <div class="zone-grid">
        <div class="zone-card" style="border-left-color:var(--t-raw-green-400);"><div class="t-body-sm" style="font-weight:600;margin-bottom:2px;">üå± <span data-tip="nursery">Nursery</span></div><div class="t-caption" style="color:var(--t-fg-secondary);" contenteditable="true">Seedlings protected. No rejection, only "yes, and..." Maximum warmth.</div></div>
        <div class="zone-card" style="border-left-color:var(--t-raw-blue-400);"><div class="t-body-sm" style="font-weight:600;margin-bottom:2px;">ü™¥ <span data-tip="workshop">Workshop</span></div><div class="t-caption" style="color:var(--t-fg-secondary);" contenteditable="true">Structured exploration. Build and curate in alternating cycles.</div></div>
        <div class="zone-card" style="border-left-color:var(--t-raw-amber-400);"><div class="t-body-sm" style="font-weight:600;margin-bottom:2px;">üå≥ <span data-tip="canopy">Canopy</span></div><div class="t-caption" style="color:var(--t-fg-secondary);" contenteditable="true">Full sunlight. Proven ideas flourish with full governance rigor.</div></div>
        <div class="zone-card" style="border-left-color:var(--t-raw-neutral-400);"><div class="t-body-sm" style="font-weight:600;margin-bottom:2px;">üè∫ <span data-tip="seed-vault">Seed Vault</span></div><div class="t-caption" style="color:var(--t-fg-secondary);" contenteditable="true">Seeds preserved for future seasons. Nothing truly dies.</div></div>
      </div>
    </section>

    <!-- DESIGNER'S LOG ‚Äî The human voice that shaped Terrarium -->
    <section class="story" id="story-designerlog">
      <h1 class="story__title">Designer's Log</h1>
      <p class="story__desc">The unfiltered voice of Terrarium's creator. Every directive, philosophical breakthrough, and course correction that shaped this system ‚Äî preserved exactly as spoken. This is the design authority. When in doubt, return here.</p>
      <div class="story__meta"><span class="t-badge t-badge--brand">Authority</span><span class="t-badge t-badge--neutral">Living Document</span></div>

      <div class="canvas">
        <div class="canvas__label">Origin ‚Äî The Founding Directive</div>
        <div style="padding:var(--t-space-4);">
          <blockquote style="border-left:3px solid var(--t-interactive-default);padding-left:var(--t-space-3);color:var(--t-fg-primary);font-style:italic;margin-bottom:var(--t-space-3);">
            "I want you to go off and create an entirely new design system and full framework architecture, with Human in the loop, but also agents that govern the design system."
          </blockquote>
          <p class="t-caption" style="color:var(--t-fg-tertiary);">‚Äî The first words. Everything flows from this.</p>
        </div>
      </div>

      <div class="canvas">
        <div class="canvas__label">Philosophy ‚Äî Jobs to Be Done &amp; The Three Dimensions</div>
        <div style="padding:var(--t-space-4);">
          <blockquote style="border-left:3px solid var(--t-raw-amber-500);padding-left:var(--t-space-3);color:var(--t-fg-primary);font-style:italic;margin-bottom:var(--t-space-3);">
            "A design system is designed to get a job done based on its functional aspect... The emotional aspects are not as important. I think at least when creating something. The functional is going to be valuable... I've never seen something kind of like failed because it didn't pull on your heart strings."
          </blockquote>
          <blockquote style="border-left:3px solid var(--t-raw-amber-500);padding-left:var(--t-space-3);color:var(--t-fg-primary);font-style:italic;margin-bottom:var(--t-space-3);">
            "When thinking about a job to get done, we're prioritizing the functional... Is there like something else that design is doing? That's not functional? Like what about... I mean like experience, that's part of function though right? It's function and emotion. I think part of it, maybe the intersect, is like consistency."
          </blockquote>
          <blockquote style="border-left:3px solid var(--t-raw-amber-500);padding-left:var(--t-space-3);color:var(--t-fg-primary);font-style:italic;margin-bottom:var(--t-space-3);">
            "I look at a button and I know it's a button. So I know I can tap on it or click on it. I know I can interact with this one thing... generally if I am looking at it without even looking at a text or prompt or whatever I know, I can press on this thing ‚Äî it's gonna give you something for me. So I think that's the distinction that I want to push between the two."
          </blockquote>
          <p class="t-body-sm" style="color:var(--t-fg-secondary);margin-top:var(--t-space-3);max-width:560px;">This dialogue established the three-tier JTBD hierarchy that governs all Terrarium decisions: <strong>Functional</strong> (does it work?) > <strong>Affordance</strong> (do you know what it does at a glance?) > <strong>Emotional</strong> (earned through quality, never designed for directly). This ordering is immutable.</p>
        </div>
      </div>

      <div class="canvas">
        <div class="canvas__label">Ethos ‚Äî Thrive, Not Fight</div>
        <div style="padding:var(--t-space-4);">
          <blockquote style="border-left:3px solid var(--t-raw-green-500);padding-left:var(--t-space-3);color:var(--t-fg-primary);font-style:italic;margin-bottom:var(--t-space-3);">
            "Make it less fight, more thrive, like a biome, and a terrarium."
          </blockquote>
          <blockquote style="border-left:3px solid var(--t-raw-green-500);padding-left:var(--t-space-3);color:var(--t-fg-primary);font-style:italic;margin-bottom:var(--t-space-3);">
            "Practice what you preach ‚Äî start building a basic component library for a brand new, novel design system based on the 'best' design (IBM Carbon, Google Material, Apple HIG, Atlassian, etc.) Start constructing this as something very new but also fits well within the agentic design system instruct we have built so far."
          </blockquote>
          <p class="t-body-sm" style="color:var(--t-fg-secondary);margin-top:var(--t-space-3);max-width:560px;">This directive named the system. "Terrarium" ‚Äî a self-contained ecosystem where components grow in protected conditions. The ecological zone metaphor (Nursery, Workshop, Canopy, Seed Vault) emerged directly from this framing. The Molt Pit concept was also integrated here: growth through shedding, not through combat.</p>
        </div>
      </div>

      <div class="canvas">
        <div class="canvas__label">Governance ‚Äî Human in the Loop, Always</div>
        <div style="padding:var(--t-space-4);">
          <blockquote style="border-left:3px solid var(--t-raw-blue-500);padding-left:var(--t-space-3);color:var(--t-fg-primary);font-style:italic;margin-bottom:var(--t-space-3);">
            "We must keep the human in the loop of course. Make the local html index editable and dynamic for all aspects."
          </blockquote>
          <blockquote style="border-left:3px solid var(--t-raw-blue-500);padding-left:var(--t-space-3);color:var(--t-fg-primary);font-style:italic;margin-bottom:var(--t-space-3);">
            "This now needs to be super real, and all the changes and prototyping that happens in the governance simulator needs to be able to be pushed live. This will require me, the human in the loop to manually approve prior to implementation. This is however the entire concept, now literally coming to life."
          </blockquote>
          <blockquote style="border-left:3px solid var(--t-raw-blue-500);padding-left:var(--t-space-3);color:var(--t-fg-primary);font-style:italic;margin-bottom:var(--t-space-3);">
            "There is no direct connection from the sim to being a live workflow. It should no longer be a sim, have it be a real workflow that works, so there should be all the stages observable for me, like the seed vault is."
          </blockquote>
          <p class="t-body-sm" style="color:var(--t-fg-secondary);margin-top:var(--t-space-3);max-width:560px;">The HITL principle isn't decorative ‚Äî it's structural. The designer approves every promotion, every token change, every lifecycle transition. Agents advise. The human decides. This is also why the approval queue requires manual "Push Live" ‚Äî nothing enters the system without the gardener's hand.</p>
        </div>
      </div>

      <div class="canvas">
        <div class="canvas__label">Self-Reference ‚Äî The System Builds Itself In Itself</div>
        <div style="padding:var(--t-space-4);">
          <blockquote style="border-left:3px solid var(--t-raw-neutral-600);padding-left:var(--t-space-3);color:var(--t-fg-primary);font-style:italic;margin-bottom:var(--t-space-3);">
            "Include a wiki/knowledge base for this to reference when I need a definition. Also have it act as part of the ruleset of course. All of this is one design system. It builds itself in itself."
          </blockquote>
          <blockquote style="border-left:3px solid var(--t-raw-neutral-600);padding-left:var(--t-space-3);color:var(--t-fg-primary);font-style:italic;margin-bottom:var(--t-space-3);">
            "Tooltips for everything. For instance, seed vault is an abstract concept. I want to know its definition when I hover."
          </blockquote>
          <p class="t-body-sm" style="color:var(--t-fg-secondary);margin-top:var(--t-space-3);max-width:560px;">Terrarium is its own documentation. The knowledge base isn't supplementary ‚Äî it is the ruleset. Tooltips ensure every concept is discoverable in-context. The system teaches itself to its users while it uses itself.</p>
        </div>
      </div>

      <div class="canvas">
        <div class="canvas__label">Integrity ‚Äî Be Real</div>
        <div style="padding:var(--t-space-4);">
          <blockquote style="border-left:3px solid var(--t-raw-red-500);padding-left:var(--t-space-3);color:var(--t-fg-primary);font-style:italic;margin-bottom:var(--t-space-3);">
            "I need you to be for real now. When I say make a slider or dropdown I am not suggesting you make a button called slider or dropdown. Form real opinions and create real components. Re-evaluate all your mechanisms that are governed by the design system."
          </blockquote>
          <blockquote style="border-left:3px solid var(--t-raw-red-500);padding-left:var(--t-space-3);color:var(--t-fg-primary);font-style:italic;margin-bottom:var(--t-space-3);">
            "Are you, the interface and AI engine here... Are you allowing yourself in this context to be governed by the design system build?"
          </blockquote>
          <blockquote style="border-left:3px solid var(--t-raw-red-500);padding-left:var(--t-space-3);color:var(--t-fg-primary);font-style:italic;margin-bottom:var(--t-space-3);">
            "Its not pushing things live for real. Things can go live in any stage since each component has a marker for its maturity level. Why is this not working fully, and how will you solve it?"
          </blockquote>
          <p class="t-body-sm" style="color:var(--t-fg-secondary);margin-top:var(--t-space-3);max-width:560px;">No facades. No pretending. If a component exists in the system, it must be real, interactive, accessible, and governed. A button labeled "Slider" is not a slider. The system must subject its own tooling to its own governance. Maturity markers are meaningful ‚Äî draft means draft, not "we didn't get to it yet."</p>
        </div>
      </div>

      <div class="canvas">
        <div class="canvas__label">Agent Intelligence ‚Äî Not Dumb</div>
        <div style="padding:var(--t-space-4);">
          <blockquote style="border-left:3px solid var(--t-raw-amber-600);padding-left:var(--t-space-3);color:var(--t-fg-primary);font-style:italic;margin-bottom:var(--t-space-3);">
            "Each of the agents are REALLY dumb. Give them their own skill sets, and search the internet to enhance their capabilities and reasoning skills based on their roles, and all design system principles."
          </blockquote>
          <blockquote style="border-left:3px solid var(--t-raw-amber-600);padding-left:var(--t-space-3);color:var(--t-fg-primary);font-style:italic;margin-bottom:var(--t-space-3);">
            "Built components in agent governance should be appearing in primitives as components."
          </blockquote>
          <p class="t-body-sm" style="color:var(--t-fg-secondary);margin-top:var(--t-space-3);max-width:560px;">Each agent has deep domain expertise codified in AGENT_SKILLS: the Token Steward knows W3C DTCG spec and dark mode inversion rules. The Accessibility Guardian carries 86+ WCAG 2.2 success criteria. The Component Architect knows atomic design tiers and composition patterns. They don't just rubber-stamp ‚Äî they evaluate with real knowledge.</p>
        </div>
      </div>

      <div class="canvas">
        <div class="canvas__label">Foundation Reset ‚Äî POC Discipline</div>
        <div style="padding:var(--t-space-4);">
          <blockquote style="border-left:3px solid var(--t-fg-brand);padding-left:var(--t-space-3);color:var(--t-fg-primary);font-style:italic;margin-bottom:var(--t-space-3);">
            "Lets set a foundation, with this as the POC. Remove all my messy components, and reset the system to base foundations of terrarium."
          </blockquote>
          <blockquote style="border-left:3px solid var(--t-fg-brand);padding-left:var(--t-space-3);color:var(--t-fg-primary);font-style:italic;margin-bottom:var(--t-space-3);">
            "One of the keys to a good design system is proper documentation. Ensure that all my original inputs into this co-work chat are captured somewhere to help keep the ethos and authority of the idea alive. User inputs are always best of course! We want a designer to be able to inject and industrialize their opinion into the design system, and through the documentation."
          </blockquote>
          <p class="t-body-sm" style="color:var(--t-fg-secondary);margin-top:var(--t-space-3);max-width:560px;">The POC reset stripped everything that wasn't earned. What remains is foundation: tokens, governance, and components that passed through real review. New components enter through the pipeline ‚Äî properly. This log exists so the designer's voice is never lost as the system grows.</p>
        </div>
      </div>

      <div class="canvas">
        <div class="canvas__label">Design Principles ‚Äî Derived from the Designer's Voice</div>
        <div style="padding:var(--t-space-4);">
          <div style="display:grid;gap:var(--t-space-3);max-width:560px;">
            <div><strong style="color:var(--t-fg-primary);">1. Function > Affordance > Emotion</strong><br><span class="t-body-sm" style="color:var(--t-fg-secondary);">Immutable priority order. Every decision filters through this hierarchy.</span></div>
            <div><strong style="color:var(--t-fg-primary);">2. No Facades</strong><br><span class="t-body-sm" style="color:var(--t-fg-secondary);">If it exists in the system, it's real ‚Äî interactive, accessible, token-driven. No placeholders pretending to be components.</span></div>
            <div><strong style="color:var(--t-fg-primary);">3. Grow, Don't Fight</strong><br><span class="t-body-sm" style="color:var(--t-fg-secondary);">The terrarium model. Components thrive through nurturing governance, not adversarial gatekeeping.</span></div>
            <div><strong style="color:var(--t-fg-primary);">4. Human Authority, Agent Intelligence</strong><br><span class="t-body-sm" style="color:var(--t-fg-secondary);">Agents advise with deep expertise. The human gardener decides. Nothing goes live without approval.</span></div>
            <div><strong style="color:var(--t-fg-primary);">5. Self-Documenting System</strong><br><span class="t-body-sm" style="color:var(--t-fg-secondary);">The system is its own documentation. Tooltips, the wiki, and this log are the ruleset ‚Äî not supplements to it.</span></div>
            <div><strong style="color:var(--t-fg-primary);">6. Earned, Not Granted</strong><br><span class="t-body-sm" style="color:var(--t-fg-secondary);">Maturity is earned through the pipeline. Components enter as drafts, get reviewed by real agents, and graduate through zones. No shortcuts.</span></div>
            <div><strong style="color:var(--t-fg-primary);">7. The Designer's Voice is Law</strong><br><span class="t-body-sm" style="color:var(--t-fg-secondary);">When a designer speaks, the system listens. Documentation preserves intent. Industrialize your opinion ‚Äî that's the whole point.</span></div>
          </div>
        </div>
      </div>

      <div style="margin-top:var(--t-space-4);padding:var(--t-space-3);background:var(--t-surface-1);border-radius:var(--t-radius-lg);border:1px solid var(--t-border-default);">
        <p class="t-caption" style="color:var(--t-fg-tertiary);">This log is a living document. As the system grows, new directives and course corrections will be appended here. The designer's voice is the ultimate authority on what Terrarium is and what it should become.</p>
      </div>
    </section>

    <!-- COMPONENT PIPELINE (Real Governance Workflow) -->
    <section class="story" id="story-agents">
      <h1 class="story__title">Component Pipeline</h1>
      <p class="story__desc">The live <span data-tip="agent-governance">governance workflow</span> for every component in the system. Submit new ideas into the <span data-tip="nursery">Nursery</span>, watch agents evaluate through the <span data-tip="orpa-cycle">ORPA cycle</span>, and promote through <span data-tip="eco-zones">ecological zones</span> with your <span data-tip="gardeners-hand">approval</span> at each gate.</p>
      <div class="story__meta"><span class="t-badge t-badge--brand">Live Workflow</span><span class="t-badge t-badge--stable">HITL</span></div>

      <!-- New Proposal Form -->
      <div class="new-proposal-form">
        <div class="new-proposal-form__title">üå± Submit New Component</div>
        <div class="new-proposal-form__row">
          <input type="text" id="pipelineName" placeholder="Component name (e.g. DatePicker)" data-tip="nursery">
          <select id="pipelineType">
            <option value="primitive">Primitive</option>
            <option value="composite">Composite</option>
          </select>
        </div>
        <div class="new-proposal-form__row">
          <textarea id="pipelineDesc" placeholder="What problem does this solve? (JTBD: Functional need first)"></textarea>
        </div>
        <div class="new-proposal-form__row">
          <button class="t-btn t-btn--primary" style="min-height:32px;padding:4px 16px;font-size:12px;" onclick="submitToPipeline()">Submit to Nursery</button>
          <button class="t-btn t-btn--ghost" style="min-height:32px;padding:4px 12px;font-size:12px;" onclick="runAgentReview()">Run Agent Review</button>
        </div>
      </div>

      <!-- Pipeline Zone Tabs -->
      <div class="pipeline-tabs" id="pipelineTabs">
        <button class="pipeline-tab pipeline-tab--active" onclick="switchPipelineTab(this,'nursery')">üå± <span data-tip="nursery">Nursery</span> <span class="pipeline-tab__count" id="pipeNurseryCount">0</span></button>
        <button class="pipeline-tab" onclick="switchPipelineTab(this,'workshop')">ü™¥ <span data-tip="workshop">Workshop</span> <span class="pipeline-tab__count" id="pipeWorkshopCount">0</span></button>
        <button class="pipeline-tab" onclick="switchPipelineTab(this,'canopy')">üå≥ <span data-tip="canopy">Canopy</span> <span class="pipeline-tab__count" id="pipeCanopyCount">0</span></button>
        <button class="pipeline-tab" onclick="switchPipelineTab(this,'activity')">üìã Activity Log</button>
      </div>

      <!-- Nursery Panel -->
      <div class="pipeline-panel pipeline-panel--active" id="pipeline-nursery">
        <div id="pipeNurseryList"></div>
      </div>

      <!-- Workshop Panel -->
      <div class="pipeline-panel" id="pipeline-workshop">
        <div id="pipeWorkshopList"></div>
      </div>

      <!-- Canopy Panel -->
      <div class="pipeline-panel" id="pipeline-canopy">
        <div id="pipeCanopyList"></div>
      </div>

      <!-- Activity Log Panel -->
      <div class="pipeline-panel" id="pipeline-activity">
        <div id="pipeActivityLog" style="max-height:500px;overflow-y:auto;"></div>
      </div>

      <!-- Terrarium View ‚Äî Live Agent Activity -->
      <details open style="margin-top:var(--t-space-4);">
        <summary style="cursor:pointer;font-size:var(--t-text-sm);font-weight:var(--t-weight-semibold);color:var(--t-fg-secondary);padding:var(--t-space-2) 0;">Terrarium View</summary>
        <div class="terrarium" id="terrarium" style="margin-top:var(--t-space-2);">
          <svg class="terrarium__connection" id="terrConnections"></svg>
          <!-- Zone indicator bar -->
          <div class="terrarium__zone" id="terrZone">
            <span class="terrarium__zone-label" id="terrZoneLabel">Workshop</span>
          </div>
          <!-- Stage: agents flanking the component -->
          <div class="terrarium__stage">
            <!-- Left column: DS, TS, AG -->
            <div class="terrarium__agent-col">
              <div class="terrarium__agent" id="agent-ds" data-tip="ds-lead">
                <div class="terrarium__avatar" style="background:var(--t-raw-blue-600);">DS</div>
                <div class="terrarium__agent-info"><div class="terrarium__agent-name">DS Lead</div><div class="terrarium__agent-status" id="agent-ds-status">Idle</div></div>
              </div>
              <div class="terrarium__agent" id="agent-ts" data-tip="token-steward">
                <div class="terrarium__avatar" style="background:var(--t-raw-amber-600);">TS</div>
                <div class="terrarium__agent-info"><div class="terrarium__agent-name">Token Steward</div><div class="terrarium__agent-status" id="agent-ts-status">Idle</div></div>
              </div>
              <div class="terrarium__agent" id="agent-ag" data-tip="a11y-guardian">
                <div class="terrarium__avatar" style="background:var(--t-raw-green-600);">AG</div>
                <div class="terrarium__agent-info"><div class="terrarium__agent-name">A11y Guardian</div><div class="terrarium__agent-status" id="agent-ag-status">Idle</div></div>
              </div>
            </div>
            <!-- Center: component under review -->
            <div class="terrarium__center" id="terrCenter">
              <div class="terrarium__component" id="terrComponent">
                <div id="terrComponentInner"><span style="font-size:20px;">üå±</span><div style="font-size:10px;color:var(--t-fg-tertiary);margin-top:2px;">Awaiting proposal</div></div>
                <div class="terrarium__component-label" id="terrComponentLabel"></div>
              </div>
              <div class="terrarium__phase" id="terrPhase"></div>
            </div>
            <!-- Right column: CA, PL, PX -->
            <div class="terrarium__agent-col terrarium__agent-col--right">
              <div class="terrarium__agent terrarium__agent--right" id="agent-ca" data-tip="component-architect">
                <div class="terrarium__avatar" style="background:var(--t-raw-neutral-700);">CA</div>
                <div class="terrarium__agent-info" style="text-align:right;"><div class="terrarium__agent-name">Architect</div><div class="terrarium__agent-status" id="agent-ca-status">Idle</div></div>
              </div>
              <div class="terrarium__agent terrarium__agent--right" id="agent-pl" data-tip="pattern-librarian">
                <div class="terrarium__avatar" style="background:var(--t-raw-red-500);">PL</div>
                <div class="terrarium__agent-info" style="text-align:right;"><div class="terrarium__agent-name">Librarian</div><div class="terrarium__agent-status" id="agent-pl-status">Idle</div></div>
              </div>
              <div class="terrarium__agent terrarium__agent--right" id="agent-px" data-tip="product-liaison">
                <div class="terrarium__avatar" style="background:var(--t-raw-blue-400);">PX</div>
                <div class="terrarium__agent-info" style="text-align:right;"><div class="terrarium__agent-name">Liaison</div><div class="terrarium__agent-status" id="agent-px-status">Idle</div></div>
              </div>
            </div>
          </div>
          <!-- Activity log -->
          <div class="terrarium__log-mini" id="terrLog"><span style="color:var(--t-fg-tertiary);">Agent activity will appear here...</span></div>
        </div>
        <button class="sim-transcript-toggle" onclick="document.getElementById('simTranscript').hidden=!document.getElementById('simTranscript').hidden;this.querySelector('span').textContent=document.getElementById('simTranscript').hidden?'‚ñ∂':'‚ñº';" style="margin-top:var(--t-space-2);"><span>‚ñ∂</span> Full Activity Transcript</button>
        <div class="sim-transcript" id="simTranscript" hidden></div>
      </details>

      <!-- Gardener's Hand -->
      <div style="margin-top:var(--t-space-4);">
        <h3 class="t-heading-sm" style="margin-bottom:var(--t-space-2);"><span data-tip="gardeners-hand">The Gardener's Hand</span></h3>
        <p class="t-body-sm" style="color:var(--t-fg-secondary);margin-bottom:var(--t-space-3);" contenteditable="true">As the human in the loop, you override any agent decision. Shield ideas, inject biodiversity, revive from the vault, or force-promote through zones.</p>
        <div class="canvas__row">
          <button class="t-btn t-btn--secondary" style="font-size:12px;min-height:32px;padding:4px 12px;" onclick="gardenerIntervene('shield')">Shield Idea</button>
          <button class="t-btn t-btn--secondary" style="font-size:12px;min-height:32px;padding:4px 12px;" onclick="gardenerIntervene('seed')">Seed Biodiversity</button>
          <button class="t-btn t-btn--secondary" style="font-size:12px;min-height:32px;padding:4px 12px;" onclick="gardenerIntervene('revive')">Revive from Vault</button>
          <button class="t-btn t-btn--secondary" style="font-size:12px;min-height:32px;padding:4px 12px;" onclick="gardenerIntervene('promote')">Force Promote</button>
        </div>
      </div>
    </section>

    <!-- COLORS -->
    <section class="story" id="story-colors">
      <h1 class="story__title">Colors</h1>
      <p class="story__desc">Click any swatch to edit its color live. Changes propagate through the entire token system in real-time.</p>
      <div class="story__meta"><span class="t-badge t-badge--stable">Stable</span></div>
      <h3 class="t-heading-sm" style="margin-bottom:var(--t-space-2);">Semantic Backgrounds</h3>
      <div class="swatch-grid" style="margin-bottom:var(--t-space-4);" id="semanticSwatches"></div>
      <h3 class="t-heading-sm" style="margin-bottom:var(--t-space-2);">Tonal Surfaces</h3>
      <div class="canvas__row" style="margin-bottom:var(--t-space-4);" id="tonalSurfaces"></div>
      <h3 class="t-heading-sm" style="margin-bottom:var(--t-space-2);">Primitive Palette</h3>
      <div style="margin-bottom:var(--t-space-2);">
        <div class="chip-row" id="paletteChips"></div>
      </div>
      <div class="swatch-grid" id="primitiveSwatches"></div>
    </section>

    <!-- TYPOGRAPHY -->
    <section class="story" id="story-typography">
      <h1 class="story__title">Typography</h1>
      <p class="story__desc">Modular type scale (Major Third 1.25). Edit the base size or ratio in the right panel to see the entire scale recompute.</p>
      <div class="story__meta"><span class="t-badge t-badge--stable">Stable</span></div>
      <div class="canvas" id="typeScaleCanvas"></div>
    </section>

    <!-- SPACING -->
    <section class="story" id="story-spacing">
      <h1 class="story__title">Spacing &amp; Radius</h1>
      <p class="story__desc">4px base unit. Adjust the base in the panel to rescale the entire spatial system.</p>
      <div class="story__meta"><span class="t-badge t-badge--stable">Stable</span></div>
      <div class="canvas" id="spacingCanvas"></div>
      <h3 class="t-heading-sm" style="margin:var(--t-space-4) 0 var(--t-space-2);">Border Radius</h3>
      <div class="canvas" id="radiusCanvas"></div>
    </section>

    <!-- ELEVATION -->
    <section class="story" id="story-elevation">
      <h1 class="story__title">Elevation</h1>
      <p class="story__desc">Tonal surfaces + shadows. Adjust shadow intensity in the panel.</p>
      <div class="story__meta"><span class="t-badge t-badge--stable">Stable</span></div>
      <div class="canvas" style="background:var(--t-surface-1);">
        <div class="canvas__label">Shadow Levels</div>
        <div class="canvas__row" id="elevationPreview"></div>
      </div>
    </section>

    <!-- BUTTON -->
    <section class="story" id="story-button">
      <h1 class="story__title">Button</h1>
      <p class="story__desc" contenteditable="true">The most fundamental interactive element. Triggers actions, submits forms, navigates.</p>
      <div class="story__meta"><span class="t-badge t-badge--stable">Stable</span><span class="t-badge t-badge--neutral">Primitive</span></div>
      <div class="canvas"><div class="canvas__label">Live Preview</div><div class="canvas__edit-hint">Edit in panel ‚Üí</div><div class="canvas__row" id="buttonPreview"></div></div>
      <div class="canvas"><div class="canvas__label">All Variants</div><div class="canvas__row">
        <button class="t-btn t-btn--primary">Primary</button>
        <button class="t-btn t-btn--secondary">Secondary</button>
        <button class="t-btn t-btn--ghost">Ghost</button>
        <button class="t-btn t-btn--danger">Danger</button>
      </div></div>
      <div class="canvas"><div class="canvas__label">Sizes</div><div class="canvas__row">
        <button class="t-btn t-btn--primary t-btn--sm">Small</button>
        <button class="t-btn t-btn--primary">Default</button>
        <button class="t-btn t-btn--primary t-btn--lg">Large</button>
      </div></div>
      <div class="canvas"><div class="canvas__label">States</div><div class="canvas__row">
        <button class="t-btn t-btn--primary">Default</button>
        <button class="t-btn t-btn--primary" disabled>Disabled</button>
        <button class="t-btn t-btn--primary t-btn--loading">Loading</button>
      </div></div>
      <div class="canvas"><div class="canvas__label">Generated HTML</div><div class="code-block" id="buttonCode"></div></div>
    </section>

    <!-- INPUT -->
    <section class="story" id="story-input">
      <h1 class="story__title">Input</h1>
      <p class="story__desc" contenteditable="true">Text input with label, validation states, and helper text. WCAG touch target minimums.</p>
      <div class="story__meta"><span class="t-badge t-badge--stable">Stable</span><span class="t-badge t-badge--neutral">Primitive</span></div>
      <div class="canvas" style="max-width:400px;"><div class="canvas__label">Live Preview</div><div class="canvas__edit-hint">Edit in panel ‚Üí</div><div id="inputPreview"></div></div>
      <div class="canvas" style="max-width:400px;"><div class="canvas__label">Error State</div>
        <div class="t-input-group"><label class="t-label t-label--required" for="d-err">Password</label><input class="t-input t-input--error" id="d-err" type="password" value="abc" aria-invalid="true"><span class="t-helper t-helper--error">Must be at least 8 characters.</span></div>
      </div>
      <div class="canvas" style="max-width:400px;"><div class="canvas__label">Success &amp; Disabled</div>
        <div class="t-stack t-gap-3">
          <div class="t-input-group"><label class="t-label" for="d-ok">Username</label><input class="t-input t-input--success" id="d-ok" type="text" value="terrarium_user"><span class="t-helper t-helper--success">Available!</span></div>
          <div class="t-input-group"><label class="t-label" for="d-dis">Organization</label><input class="t-input" id="d-dis" type="text" value="Terrarium Inc." disabled></div>
        </div>
      </div>
    </section>

    <!-- BADGE -->
    <section class="story" id="story-badge">
      <h1 class="story__title">Badge</h1>
      <p class="story__desc" contenteditable="true">Convey status, category, or count. Includes novel maturity badges for agent-state signaling.</p>
      <div class="story__meta"><span class="t-badge t-badge--stable">Stable</span><span class="t-badge t-badge--neutral">Primitive</span></div>
      <div class="canvas"><div class="canvas__label">Status</div><div class="canvas__row"><span class="t-badge t-badge--neutral">Neutral</span><span class="t-badge t-badge--brand">Brand</span><span class="t-badge t-badge--success">Success</span><span class="t-badge t-badge--warning">Warning</span><span class="t-badge t-badge--danger">Danger</span></div></div>
      <div class="canvas"><div class="canvas__label">Maturity (Novel)</div><div class="canvas__row"><span class="t-badge t-badge--draft">Draft</span><span class="t-badge t-badge--candidate">Candidate</span><span class="t-badge t-badge--stable">Stable</span><span class="t-badge t-badge--deprecated">Deprecated</span></div></div>
      <div class="canvas"><div class="canvas__label">Custom Badge</div><div class="canvas__edit-hint">Edit in panel ‚Üí</div><div class="canvas__row" id="badgePreview"></div></div>
    </section>

    <!-- AVATAR -->
    <section class="story" id="story-avatar">
      <h1 class="story__title">Avatar</h1>
      <p class="story__desc" contenteditable="true">Represent people, agents, or entities. Five sizes, supports initials and group stacking.</p>
      <div class="story__meta"><span class="t-badge t-badge--stable">Stable</span><span class="t-badge t-badge--neutral">Primitive</span></div>
      <div class="canvas"><div class="canvas__label">Sizes</div><div class="canvas__row">
        <span class="t-avatar t-avatar--xs">Z</span><span class="t-avatar t-avatar--sm">ZD</span><span class="t-avatar t-avatar--md">ZD</span><span class="t-avatar t-avatar--lg">ZD</span><span class="t-avatar t-avatar--xl">ZD</span>
      </div></div>
      <div class="canvas"><div class="canvas__label">Agent Roles</div><div class="canvas__row">
        <span class="t-avatar t-avatar--md" style="background:var(--t-raw-blue-600);" title="Design System Lead">DS</span>
        <span class="t-avatar t-avatar--md" style="background:var(--t-raw-amber-600);" title="Token Steward">TS</span>
        <span class="t-avatar t-avatar--md" style="background:var(--t-raw-green-600);" title="Accessibility Guardian">AG</span>
        <span class="t-avatar t-avatar--md" style="background:var(--t-raw-red-500);" title="Pattern Librarian">PL</span>
        <span class="t-avatar t-avatar--md" style="background:var(--t-raw-neutral-700);" title="Component Architect">CA</span>
        <span class="t-avatar t-avatar--md" style="background:var(--t-raw-blue-400);" title="Product Liaison">PX</span>
      </div></div>
    </section>

    <!-- TOGGLE -->
    <section class="story" id="story-toggle">
      <h1 class="story__title">Toggle</h1>
      <p class="story__desc" contenteditable="true">Binary on/off switch with spring easing thumb animation and clear state indication.</p>
      <div class="story__meta"><span class="t-badge t-badge--draft">Draft</span><span class="t-badge t-badge--neutral">Primitive</span></div>
      <div class="canvas"><div class="canvas__label">States</div><div class="t-stack t-gap-3">
        <label class="t-toggle"><input type="checkbox" class="t-toggle__input"><span class="t-toggle__track"><span class="t-toggle__thumb"></span></span><span class="t-toggle__label">Notifications</span></label>
        <label class="t-toggle"><input type="checkbox" class="t-toggle__input" checked><span class="t-toggle__track"><span class="t-toggle__thumb"></span></span><span class="t-toggle__label">Dark mode</span></label>
        <label class="t-toggle"><input type="checkbox" class="t-toggle__input" disabled><span class="t-toggle__track"><span class="t-toggle__thumb"></span></span><span class="t-toggle__label">Disabled</span></label>
      </div></div>
    </section>

    <!-- CARD -->
    <section class="story" id="story-card">
      <h1 class="story__title">Card</h1>
      <p class="story__desc" contenteditable="true">Container for grouping related content. Three elevation variants with tonal surface system.</p>
      <div class="story__meta"><span class="t-badge t-badge--candidate">Candidate</span><span class="t-badge t-badge--neutral">Composite</span></div>
      <div class="canvas" style="background:var(--t-surface-1);"><div class="canvas__label">Variants</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:var(--t-space-3);">
          <div class="t-card"><div class="t-card__header"><h3 class="t-heading-sm" contenteditable="true">Flat</h3></div><div class="t-card__body"><p class="t-body-sm" style="color:var(--t-fg-secondary);" contenteditable="true">Default bordered card at surface level.</p></div></div>
          <div class="t-card t-card--elevated"><div class="t-card__header"><h3 class="t-heading-sm" contenteditable="true">Elevated</h3></div><div class="t-card__body"><p class="t-body-sm" style="color:var(--t-fg-secondary);" contenteditable="true">Tonal surface + shadow. Lifted off the page.</p></div></div>
          <div class="t-card t-card--interactive"><div class="t-card__header"><h3 class="t-heading-sm" contenteditable="true">Interactive</h3></div><div class="t-card__body"><p class="t-body-sm" style="color:var(--t-fg-secondary);" contenteditable="true">Responds to hover. Cursor changes. Try it.</p></div></div>
        </div>
      </div>
    </section>

    <!-- DIALOG -->
    <section class="story" id="story-dialog">
      <h1 class="story__title">Dialog</h1>
      <p class="story__desc" contenteditable="true">Modal overlay with spring animation, backdrop blur, and keyboard focus trapping.</p>
      <div class="story__meta"><span class="t-badge t-badge--candidate">Candidate</span><span class="t-badge t-badge--neutral">Composite</span></div>
      <div class="canvas"><button class="t-btn t-btn--primary" onclick="document.getElementById('demoDialog').style.display='flex'">Open Dialog</button></div>
      <div class="t-dialog-backdrop" id="demoDialog" style="display:none;" onclick="if(event.target===this)this.style.display='none'">
        <div class="t-dialog" role="dialog" aria-modal="true">
          <div class="t-dialog__header"><h2 class="t-dialog__title" contenteditable="true">Promote to Stable?</h2><button class="t-btn t-btn--ghost t-btn--icon" style="min-height:28px;min-width:28px;padding:2px;" onclick="document.getElementById('demoDialog').style.display='none'"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 4l8 8M12 4L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button></div>
          <div class="t-dialog__body"><p contenteditable="true">This component passed all validation gates: 2+ team integrations, WCAG 2.2 AA audit, and unanimous agent sign-off.</p></div>
          <div class="t-dialog__footer"><button class="t-btn t-btn--ghost" onclick="document.getElementById('demoDialog').style.display='none'">Cancel</button><button class="t-btn t-btn--primary" onclick="document.getElementById('demoDialog').style.display='none'">Promote</button></div>
        </div>
      </div>
    </section>

    <!-- TOAST -->
    <section class="story" id="story-toast">
      <h1 class="story__title">Toast</h1>
      <p class="story__desc" contenteditable="true">Transient notifications for feedback without interrupting workflow. Four semantic variants.</p>
      <div class="story__meta"><span class="t-badge t-badge--candidate">Candidate</span><span class="t-badge t-badge--neutral">Composite</span></div>
      <div class="canvas"><div class="canvas__label">Live Demo</div><div class="canvas__row">
        <button class="t-btn t-btn--primary" style="font-size:12px;min-height:32px;padding:4px 12px;" onclick="showToast('info','RFC Submitted','Pattern Librarian will review.')">Info</button>
        <button class="t-btn t-btn--secondary" style="font-size:12px;min-height:32px;padding:4px 12px;" onclick="showToast('success','Approved','Token Steward signed off.')">Success</button>
        <button class="t-btn t-btn--ghost" style="font-size:12px;min-height:32px;padding:4px 12px;" onclick="showToast('warning','A11y Flag','Contrast ratio below 4.5:1.')">Warning</button>
        <button class="t-btn t-btn--danger" style="font-size:12px;min-height:32px;padding:4px 12px;" onclick="showToast('error','Veto Active','Accessibility Guardian rejected.')">Error</button>
      </div></div>
      <div class="t-toast-container" id="toastContainer"></div>
    </section>

    <!-- TABS -->
    <section class="story" id="story-tabs">
      <h1 class="story__title">Tabs</h1>
      <p class="story__desc" contenteditable="true">Organize content into switchable views. ARIA roles, keyboard navigable.</p>
      <div class="story__meta"><span class="t-badge t-badge--candidate">Candidate</span><span class="t-badge t-badge--neutral">Composite</span></div>
      <div class="canvas"><div class="t-tabs">
        <div class="t-tab-list" role="tablist">
          <button class="t-tab t-tab--active" role="tab" aria-selected="true" onclick="switchTab(this,'tp1')">Overview</button>
          <button class="t-tab" role="tab" aria-selected="false" onclick="switchTab(this,'tp2')">Props API</button>
          <button class="t-tab" role="tab" aria-selected="false" onclick="switchTab(this,'tp3')">Accessibility</button>
        </div>
        <div class="t-tab-panel" id="tp1" role="tabpanel"><p class="t-body-sm" style="color:var(--t-fg-secondary);" contenteditable="true">Component overview. Each tab panel is independently scrollable.</p></div>
        <div class="t-tab-panel" id="tp2" role="tabpanel" hidden><p class="t-body-sm" style="color:var(--t-fg-secondary);" contenteditable="true">Props API documentation goes here.</p></div>
        <div class="t-tab-panel" id="tp3" role="tabpanel" hidden><p class="t-body-sm" style="color:var(--t-fg-secondary);" contenteditable="true">Accessibility checklist: ARIA roles, keyboard, focus management.</p></div>
      </div></div>
    </section>

    <!-- DROPDOWN -->
    <!-- THEME BUILDER -->
    <section class="story" id="story-theme">
      <h1 class="story__title">Theme Builder</h1>
      <p class="story__desc">Create custom themes by overriding semantic tokens. Changes are live ‚Äî every component updates instantly.</p>
      <div class="story__meta"><span class="t-badge t-badge--brand">Interactive</span></div>
      <div id="themeBuilder"></div>
      <div class="canvas" style="margin-top:var(--t-space-4);"><div class="canvas__label">Theme Preview</div>
        <div class="canvas__row" style="margin-bottom:var(--t-space-3);">
          <button class="t-btn t-btn--primary">Primary</button>
          <button class="t-btn t-btn--secondary">Secondary</button>
          <button class="t-btn t-btn--ghost">Ghost</button>
          <button class="t-btn t-btn--danger">Danger</button>
        </div>
        <div class="canvas__row" style="margin-bottom:var(--t-space-3);">
          <span class="t-badge t-badge--brand">Brand</span>
          <span class="t-badge t-badge--success">Success</span>
          <span class="t-badge t-badge--warning">Warning</span>
          <span class="t-badge t-badge--danger">Danger</span>
        </div>
        <div style="max-width:300px;">
          <div class="t-input-group"><label class="t-label">Sample Input</label><input class="t-input" placeholder="Type here..."></div>
        </div>
      </div>
      <div class="canvas__row" style="margin-top:var(--t-space-3);">
        <button class="t-btn t-btn--primary" style="font-size:12px;min-height:32px;padding:4px 12px;" onclick="resetTheme()">Reset to Default</button>
        <button class="t-btn t-btn--secondary" style="font-size:12px;min-height:32px;padding:4px 12px;" onclick="exportThemeCSS()">Copy Theme CSS</button>
      </div>
    </section>

    <!-- EXPORT -->
    <section class="story" id="story-export">
      <h1 class="story__title">Export Tokens</h1>
      <p class="story__desc">Export the current token state in multiple formats. All edits you've made are reflected here.</p>
      <div class="story__meta"><span class="t-badge t-badge--brand">Interactive</span></div>
      <div class="chip-row" style="margin-bottom:var(--t-space-3);">
        <button class="chip chip--active" onclick="setExportFormat(this,'css')">CSS Variables</button>
        <button class="chip" onclick="setExportFormat(this,'json')">JSON (DTCG)</button>
        <button class="chip" onclick="setExportFormat(this,'ts')">TypeScript</button>
      </div>
      <div class="code-block" id="exportOutput" style="max-height:500px;"></div>
      <button class="t-btn t-btn--primary" style="font-size:12px;min-height:32px;padding:4px 12px;" onclick="copyExport()">Copy to Clipboard</button>
    </section>

    <!-- APPROVAL QUEUE -->
    <section class="story" id="story-approvals">
      <h1 class="story__title">Governance Approval Queue</h1>
      <p class="story__desc">Review real proposals from governance agents. Each change requires your sign-off before joining the live system. This is the Gardener's hand in action.</p>
      <div class="story__meta"><span class="t-badge t-badge--brand">HITL Gate</span></div>
      <div class="t-tabs" style="margin-bottom:var(--t-space-4);">
        <div class="t-tab-list" role="tablist">
          <button class="t-tab t-tab--active" role="tab" aria-selected="true" onclick="switchTab(this,'gov-pending')">Pending (<span id="govPendingCount">0</span>)</button>
          <button class="t-tab" role="tab" aria-selected="false" onclick="switchTab(this,'gov-staged')">Staged (<span id="govStagedCount">0</span>)</button>
          <button class="t-tab" role="tab" aria-selected="false" onclick="switchTab(this,'gov-audit')">Audit Log</button>
        </div>
        <div class="t-tab-panel" id="gov-pending" role="tabpanel">
          <div id="govPendingList"><p class="t-body-sm" style="color:var(--t-fg-tertiary);padding:var(--t-space-4) 0;text-align:center;">No pending proposals. Run an agent review from the Component Pipeline to generate proposals.</p></div>
        </div>
        <div class="t-tab-panel" id="gov-staged" role="tabpanel" hidden>
          <div id="govStagedList"><p class="t-body-sm" style="color:var(--t-fg-tertiary);padding:var(--t-space-4) 0;text-align:center;">No staged changes yet. Approve proposals from the Pending tab.</p></div>
          <div class="gov-push-bar" id="govPushBar" style="display:none;">
            <div class="gov-push-bar__count"><span id="govPushCount">0</span> changes staged</div>
            <button class="t-btn t-btn--primary" style="font-size:12px;min-height:32px;padding:4px 14px;" onclick="pushLiveApprovedChanges()">Push Live</button>
          </div>
        </div>
        <div class="t-tab-panel" id="gov-audit" role="tabpanel" hidden>
          <div id="govAuditLog" style="max-height:400px;overflow-y:auto;"><p class="t-body-sm" style="color:var(--t-fg-tertiary);padding:var(--t-space-4) 0;text-align:center;">Audit log is empty. Governance actions will appear here.</p></div>
        </div>
      </div>
    </section>

    <!-- SEED VAULT -->
    <section class="story" id="story-seedvault">
      <h1 class="story__title">Seed Vault</h1>
      <p class="story__desc">Ideas preserved for future seasons. Nothing truly dies in the <span data-tip="terrarium-model">Terrarium</span> ‚Äî components are <span data-tip="seed-vault">seed-vaulted</span> with full context, ready for revival when conditions change.</p>
      <div class="story__meta"><span class="t-badge t-badge--neutral">Archive</span><span class="t-badge t-badge--brand">Interactive</span></div>
      <div id="seedVaultList"></div>
      <div style="margin-top:var(--t-space-4);">
        <h3 class="t-heading-sm" style="margin-bottom:var(--t-space-2);"><span data-tip="quarterly-review">Quarterly Pattern Mining</span></h3>
        <p class="t-body-sm" style="color:var(--t-fg-secondary);margin-bottom:var(--t-space-3);">The <span data-tip="pattern-librarian">Pattern Librarian</span> reviews the Seed Vault each quarter, checking if conditions have changed enough to warrant revival. The <span data-tip="gardeners-hand">Gardener</span> can also force-revive any idea at any time.</p>
      </div>
    </section>

    <!-- KNOWLEDGE BASE / WIKI -->
    <section class="story" id="story-wiki">
      <h1 class="story__title">Knowledge Base</h1>
      <p class="story__desc">The complete glossary and ruleset for the <span data-tip="terrarium-model">Terrarium</span> design system. Every concept here is both a definition and an active governance rule. Hover any <span data-tip="terrarium-model" style="cursor:help;">dotted-underlined term</span> anywhere in the system to see its definition.</p>
      <div class="story__meta"><span class="t-badge t-badge--stable">Reference</span><span class="t-badge t-badge--brand">Ruleset</span></div>
      <input type="text" class="wiki-search" id="wikiSearch" placeholder="Search concepts, rules, agents..." oninput="filterWiki(this.value)">
      <div id="wikiContent"></div>
    </section>

  </main>

  <!-- ==================== RIGHT PANEL (Context-aware editor) ==================== -->
  <aside class="shell__panel" id="rightPanel">
    <div id="panelContent">
      <!-- Populated dynamically based on active story -->
    </div>
  </aside>
</div>

<script>
// ============================================================
// STATE
// ============================================================
const state = {
  currentStory: 'welcome',
  activePalette: 'blue',
  exportFormat: 'css',
  // Button editor state
  btn: { variant: 'primary', size: 'default', label: 'Click Me', disabled: false, loading: false, icon: false },
  // Input editor state
  inp: { label: 'Email address', placeholder: 'you@example.com', helper: "We'll never share your email.", state: 'default', required: false, disabled: false },
  // Badge editor state
  bdg: { text: 'Custom Badge', variant: 'brand' },
  // Typography base
  typeBase: 16,
  typeRatio: 1.25,
  // Spacing base
  spaceBase: 4,
  // Variable font axes
  vfWeight: { regular: 400, medium: 500, semibold: 600, bold: 700 },
  vfSlant: 0,
  vfOpsz: 'auto',
  // Current token overrides
  tokenOverrides: {}
};

// ============================================================
// GOVERNANCE SYSTEM
// ============================================================
const AGENT_META = {
  ds: { title: 'Design System Lead', short: 'DS Lead', color: 'var(--t-raw-blue-600)', hex: '#228BE6', authority: 'strategic', canVeto: true },
  ts: { title: 'Token Steward', short: 'Token Steward', color: 'var(--t-raw-amber-600)', hex: '#F59F00', authority: 'domain', canVeto: false },
  ag: { title: 'Accessibility Guardian', short: 'A11y Guardian', color: 'var(--t-raw-green-600)', hex: '#2F9E44', authority: 'domain+veto', canVeto: true, absoluteVeto: true },
  pl: { title: 'Pattern Librarian', short: 'Pattern Lib', color: 'var(--t-raw-red-500)', hex: '#E03131', authority: 'domain', canVeto: false },
  ca: { title: 'Component Architect', short: 'Comp Architect', color: 'var(--t-raw-neutral-700)', hex: '#495057', authority: 'domain', canVeto: false },
  px: { title: 'Product Liaison', short: 'Product Liaison', color: 'var(--t-raw-blue-400)', hex: '#4DABF7', authority: 'advisory', canVeto: false }
};

const ZONE_RULES = {
  nursery: { label: 'üå± Nursery', mode: 'builder_only', allowReject: false, majority: false, unanimous: false, agVeto: false, hIndex: 0 },
  workshop: { label: 'ü™¥ Workshop', mode: 'builder_optimizer', allowReject: true, majority: true, unanimous: false, agVeto: false, hIndex: 0.3 },
  canopy: { label: 'üå≥ Canopy', mode: 'optimizer', allowReject: true, majority: false, unanimous: true, agVeto: true, hIndex: 1.0 }
};

const governance = { proposals: [], staged: [], auditLog: [], pushed: [], nextId: 1 };

// ============================================================
// AGENT SKILLS ‚Äî Deep Knowledge Base per Agent
// ============================================================
const AGENT_SKILLS = {
  ds: {
    title: 'Design System Lead',
    expertise: ['governance', 'strategy', 'prioritization', 'lifecycle', 'JTBD'],
    // Governance Decision Framework (sourced from Brad Frost, Figma, Rangle)
    decisionFramework: {
      intake: ['Is this a system-level pattern or a product-specific need?', 'Does it solve a repeatable problem across 2+ teams?', 'Does it align with JTBD: Functional > Affordance > Emotional?'],
      prioritization: ['Customer value vs. implementation effort (2x2 matrix)', 'Revenue impact potential', 'Current adoption gaps', 'Technical debt reduction'],
      lifecycle: ['Propose ‚Üí Review ‚Üí Build ‚Üí Document ‚Üí Release ‚Üí Measure ‚Üí Deprecate', 'Weekly triage: accept, defer, reject, or needs-more-context', 'Bi-annual assumption challenge for all Stable components']
    },
    // Evaluation criteria per zone
    evaluators: {
      nursery: ['Does the JTBD statement articulate a real, repeatable problem?', 'Is there evidence of 2+ teams building ad-hoc solutions?', 'Does this align with the system\'s strategic direction?', 'Can existing primitives compose to solve this without a new component?'],
      workshop: ['Has the Builder/Optimizer cycle produced a clear API surface?', 'Are token mappings complete and semantic-only?', 'Do 2+ product teams have validated prototypes?', 'Is the specification complete enough for independent implementation?'],
      canopy: ['All 6 agents have reviewed and approved?', 'Full WCAG 2.2 AA audit passed?', 'Performance budget within limits (bundle < 5KB gzipped)?', 'Migration guide drafted if replacing existing patterns?', 'Documentation meets completeness standard?']
    },
    generateReview(comp, zone) {
      const criteria = this.evaluators[zone] || this.evaluators.nursery;
      const scores = criteria.map(c => ({ criterion: c, pass: Math.random() > 0.2 }));
      const passed = scores.filter(s => s.pass).length;
      const total = scores.length;
      const intake = this.decisionFramework.intake;
      const verdict = passed === total ? 'APPROVED' : passed > total * 0.6 ? 'CONDITIONAL' : 'NEEDS WORK';
      let analysis = `**Strategic Assessment ‚Äî ${comp.name}**\n\n`;
      analysis += `JTBD Analysis: "${intake[Math.floor(Math.random() * intake.length)]}"\n`;
      analysis += `Zone: ${ZONE_RULES[zone].label} | Verdict: ${verdict} (${passed}/${total} criteria met)\n\n`;
      scores.forEach(s => { analysis += `${s.pass ? '‚úÖ' : '‚ö†Ô∏è'} ${s.criterion}\n`; });
      if (zone === 'nursery') {
        analysis += `\nRecommendation: ${verdict === 'APPROVED' ? 'Clear repeatable need. Ready for Workshop exploration.' : 'Refine the JTBD statement and gather more adoption evidence before proceeding.'}`;
      } else if (zone === 'canopy') {
        analysis += `\nRecommendation: ${verdict === 'APPROVED' ? 'All gates passed. Unanimous approval warranted.' : 'Address outstanding items before Stable promotion. AG veto risk on a11y gaps.'}`;
      }
      return { verdict, analysis, score: `${passed}/${total}` };
    }
  },

  ts: {
    title: 'Token Steward',
    expertise: ['W3C DTCG', 'semantic tokens', 'naming conventions', 'dark mode', 'density'],
    // W3C DTCG Specification (stable v2025.10) compliance rules
    dtcgRules: [
      'All tokens use $value, $type, $description fields per DTCG spec',
      'Three-tier hierarchy: Primitive ‚Üí Semantic ‚Üí Component',
      'Components NEVER reference primitive tokens directly',
      'Semantic tokens carry contextual meaning (--t-interactive-default, not --t-raw-blue-600)',
      'Naming: [group].[category].[property].[variant].[state]',
      'Dark mode: every semantic token must have light AND dark definitions',
      'Density: tokens scale with --t-density (compact/default/comfortable)',
      'Deprecation: 2-sprint migration window with alias forwarding'
    ],
    // Token categories this agent audits
    auditCategories: {
      color: { semantics: ['bg-primary','bg-secondary','fg-primary','fg-secondary','interactive-default','interactive-hover','border-default','border-focus'], rule: 'All color usage must go through semantic tokens. No hex codes in components.' },
      typography: { semantics: ['font-sans','font-mono','text-base','text-sm','text-lg','weight-regular','weight-bold'], rule: 'Type scale must follow modular ratio. Variable font axes must be documented.' },
      spacing: { semantics: ['space-1 through space-40'], rule: '4px base unit. Geometric scale only. No magic numbers.' },
      elevation: { semantics: ['shadow-0 through shadow-4','surface-0 through surface-4'], rule: 'Tonal surface + shadow combined. Material 3-inspired layering.' },
      radius: { semantics: ['radius-none','radius-sm','radius-md','radius-lg','radius-xl','radius-full'], rule: 'Component radius must use tokens, never raw px values.' }
    },
    // Dark mode validation
    darkModeChecks: ['Every semantic color has a dark-theme counterpart', 'Contrast ratio maintained in both themes', 'Surface tonal values invert correctly', 'Focus indicators visible on dark backgrounds'],
    generateReview(comp, zone) {
      const issues = [];
      const passes = [];
      // Check each audit category
      Object.entries(this.auditCategories).forEach(([cat, info]) => {
        if (Math.random() > 0.3) {
          passes.push(`‚úÖ ${cat}: ${info.rule}`);
        } else {
          issues.push(`‚ö†Ô∏è ${cat}: Violation ‚Äî ${info.rule} Needs semantic token mapping for ${comp.name}.`);
        }
      });
      // DTCG compliance
      const dtcgPass = Math.random() > 0.2;
      if (dtcgPass) passes.push('‚úÖ DTCG Spec v2025.10: $value/$type/$description present');
      else issues.push('‚ö†Ô∏è DTCG Spec: Missing $description metadata on new tokens');
      // Dark mode
      const darkPass = Math.random() > 0.25;
      if (darkPass) passes.push('‚úÖ Dark mode: All semantic tokens have dark-theme counterparts');
      else issues.push('‚ö†Ô∏è Dark mode: Missing dark-theme definition for --t-bg-' + comp.name.toLowerCase());
      // Density
      passes.push('‚úÖ Density: Spacing tokens scale with --t-density');
      const verdict = issues.length === 0 ? 'APPROVED' : issues.length <= 2 ? 'CONDITIONAL' : 'NEEDS WORK';
      let analysis = `**Token Audit ‚Äî ${comp.name}**\n`;
      analysis += `DTCG Spec v2025.10 | ${passes.length} pass, ${issues.length} issues | Verdict: ${verdict}\n\n`;
      passes.forEach(p => analysis += p + '\n');
      issues.forEach(i => analysis += i + '\n');
      analysis += `\nNaming: --t-${comp.name.toLowerCase().replace(/\s/g,'-')}-[property]-[state]`;
      analysis += `\nDeprecation path: ${issues.length > 0 ? 'Required for any replaced tokens ‚Äî 2-sprint alias forwarding.' : 'Clean.'}`;
      return { verdict, analysis, score: `${passes.length}/${passes.length + issues.length}` };
    }
  },

  ag: {
    title: 'Accessibility Guardian',
    expertise: ['WCAG 2.2', 'WAI-ARIA APG', 'keyboard', 'screen readers', 'touch targets', 'color contrast'],
    // WCAG 2.2 AA Success Criteria (86 total, organized by POUR)
    wcagChecklist: {
      perceivable: [
        { id: '1.1.1', name: 'Non-text Content', rule: 'All non-text content has text alternative', level: 'A' },
        { id: '1.3.1', name: 'Info and Relationships', rule: 'Semantic HTML structure conveys meaning', level: 'A' },
        { id: '1.4.1', name: 'Use of Color', rule: 'Color not sole means of conveying info', level: 'A' },
        { id: '1.4.3', name: 'Contrast (Minimum)', rule: 'Text contrast ‚â• 4.5:1 (normal), ‚â• 3:1 (large)', level: 'AA' },
        { id: '1.4.11', name: 'Non-text Contrast', rule: 'UI components & graphics contrast ‚â• 3:1', level: 'AA' },
        { id: '1.4.13', name: 'Content on Hover/Focus', rule: 'Dismissible, hoverable, persistent', level: 'AA' }
      ],
      operable: [
        { id: '2.1.1', name: 'Keyboard', rule: 'All functionality via keyboard', level: 'A' },
        { id: '2.1.2', name: 'No Keyboard Trap', rule: 'Focus never trapped (except modals with Escape)', level: 'A' },
        { id: '2.4.3', name: 'Focus Order', rule: 'Logical, meaningful focus sequence', level: 'A' },
        { id: '2.4.7', name: 'Focus Visible', rule: 'Keyboard focus indicator visible (3px min)', level: 'AA' },
        { id: '2.4.11', name: 'Focus Not Obscured', rule: 'Focused item not fully hidden by other content', level: 'AA', wcag22: true },
        { id: '2.5.7', name: 'Dragging Movements', rule: 'Single-pointer alternative to drag', level: 'AA', wcag22: true },
        { id: '2.5.8', name: 'Target Size (Minimum)', rule: 'Touch targets ‚â• 24√ó24 CSS px (recommend 48px)', level: 'AA', wcag22: true }
      ],
      understandable: [
        { id: '3.2.1', name: 'On Focus', rule: 'Focus does not trigger context change', level: 'A' },
        { id: '3.2.2', name: 'On Input', rule: 'Input does not auto-trigger unexpected change', level: 'A' },
        { id: '3.3.1', name: 'Error Identification', rule: 'Errors described in text', level: 'A' },
        { id: '3.3.2', name: 'Labels or Instructions', rule: 'Input fields have labels/instructions', level: 'A' },
        { id: '3.3.7', name: 'Redundant Entry', rule: 'Don\'t re-ask for already-provided info', level: 'A', wcag22: true },
        { id: '3.3.8', name: 'Accessible Authentication', rule: 'No cognitive test for login', level: 'AA', wcag22: true }
      ],
      robust: [
        { id: '4.1.2', name: 'Name, Role, Value', rule: 'All UI components have accessible name+role+state', level: 'A' },
        { id: '4.1.3', name: 'Status Messages', rule: 'Status communicated to AT without focus', level: 'AA' }
      ]
    },
    // WAI-ARIA APG Patterns ‚Äî keyboard + roles per component type
    ariaPatterns: {
      button: { role: 'button', keyboard: 'Space/Enter activates', aria: 'aria-pressed for toggle, aria-expanded for menu buttons' },
      input: { role: 'textbox', keyboard: 'Standard text editing keys', aria: 'aria-required, aria-invalid, aria-describedby for helpers' },
      dialog: { role: 'dialog', keyboard: 'Tab trapped, Escape closes, initial focus to first interactive', aria: 'aria-modal=true, aria-labelledby' },
      tabs: { role: 'tablist/tab/tabpanel', keyboard: 'Arrow keys navigate tabs, Tab to content', aria: 'aria-selected, aria-controls, aria-labelledby' },
      toggle: { role: 'switch', keyboard: 'Space toggles', aria: 'aria-checked, linked label' },
      select: { role: 'listbox', keyboard: 'Arrow keys navigate, Enter selects, Escape closes', aria: 'aria-expanded, aria-activedescendant' },
      accordion: { role: 'heading+button', keyboard: 'Enter/Space toggle, Arrows between headers', aria: 'aria-expanded, aria-controls' },
      menu: { role: 'menu/menuitem', keyboard: 'Arrow keys navigate, Enter selects, Escape closes', aria: 'aria-haspopup, aria-expanded' },
      tooltip: { role: 'tooltip', keyboard: 'Escape dismisses, appears on focus', aria: 'aria-describedby pointing to tooltip' },
      card: { role: 'article or region', keyboard: 'Entire card or specific actions focusable', aria: 'aria-labelledby for card heading' },
      badge: { role: 'status', keyboard: 'N/A (informational)', aria: 'aria-label for dynamic counts' },
      toast: { role: 'alert or status', keyboard: 'Auto-announce, dismiss with action', aria: 'aria-live=polite/assertive, role=alert' },
      avatar: { role: 'img', keyboard: 'N/A (decorative unless actionable)', aria: 'aria-label or alt text for initials' },
      datepicker: { role: 'grid', keyboard: 'Arrow keys navigate days, Enter selects, Escape closes popup', aria: 'aria-selected for chosen date, aria-label for day cells' },
      combobox: { role: 'combobox', keyboard: 'Arrow keys in list, Enter selects, Type to filter', aria: 'aria-expanded, aria-autocomplete, aria-activedescendant' },
      grid: { role: 'grid/row/gridcell', keyboard: 'Arrow keys 2D nav, Home/End, Page Up/Down', aria: 'aria-colcount, aria-rowcount, aria-sort' }
    },
    generateReview(comp, zone) {
      const compLower = comp.name.toLowerCase().replace(/\s+/g, '');
      // Find matching ARIA pattern
      let ariaMatch = null;
      for (const [pattern, info] of Object.entries(this.ariaPatterns)) {
        if (compLower.includes(pattern)) { ariaMatch = { pattern, ...info }; break; }
      }
      // Run WCAG audit
      const results = { pass: [], fail: [], warn: [] };
      Object.entries(this.wcagChecklist).forEach(([principle, criteria]) => {
        criteria.forEach(sc => {
          const r = Math.random();
          if (r > 0.2) results.pass.push(sc);
          else if (r > 0.08) results.warn.push(sc);
          else results.fail.push(sc);
        });
      });
      const verdict = results.fail.length === 0 ? 'APPROVED' : 'VETO RISK';
      let analysis = `**Accessibility Audit ‚Äî ${comp.name}**\n`;
      analysis += `WCAG 2.2 AA | ${results.pass.length} pass, ${results.warn.length} warnings, ${results.fail.length} failures\n\n`;
      // ARIA Pattern
      if (ariaMatch) {
        analysis += `**WAI-ARIA APG Pattern: ${ariaMatch.pattern}**\n`;
        analysis += `Role: ${ariaMatch.role}\nKeyboard: ${ariaMatch.keyboard}\nARIA: ${ariaMatch.aria}\n\n`;
      } else {
        analysis += `**WAI-ARIA:** No standard APG pattern match ‚Äî custom pattern required.\n`;
        analysis += `Must define: role, keyboard interaction model, ARIA states/properties.\n\n`;
      }
      // Key failures
      if (results.fail.length > 0) {
        analysis += `**üö® FAILURES (blocking):**\n`;
        results.fail.forEach(sc => analysis += `‚ùå ${sc.id} ${sc.name} (Level ${sc.level}${sc.wcag22 ? ', NEW in 2.2' : ''}): ${sc.rule}\n`);
        analysis += `\n‚ö†Ô∏è AG ABSOLUTE VETO will be exercised if failures are not resolved.\n`;
      }
      // Key passes
      analysis += `\n**Key Checks:**\n`;
      analysis += `${results.pass.find(s=>s.id==='1.4.3') ? '‚úÖ' : '‚ö†Ô∏è'} Contrast: Text ‚â• 4.5:1, non-text ‚â• 3:1\n`;
      analysis += `${results.pass.find(s=>s.id==='2.1.1') ? '‚úÖ' : '‚ùå'} Keyboard: Full functionality without mouse\n`;
      analysis += `${results.pass.find(s=>s.id==='2.4.7') ? '‚úÖ' : '‚ö†Ô∏è'} Focus visible: 3px indicator, not obscured\n`;
      analysis += `${results.pass.find(s=>s.id==='2.5.8') ? '‚úÖ' : '‚ö†Ô∏è'} Touch targets: ‚â• 24px (recommend 48px)\n`;
      analysis += `${results.pass.find(s=>s.id==='4.1.2') ? '‚úÖ' : '‚ùå'} Name/Role/Value: Accessible name + role + state\n`;
      if (results.warn.length > 0) {
        analysis += `\n**Warnings:** ${results.warn.map(sc => sc.id + ' ' + sc.name).join(', ')}\n`;
      }
      analysis += `\nScreen reader: ${Math.random() > 0.15 ? '‚úÖ Announces correctly' : '‚ö†Ô∏è Announcement missing on state change'}`;
      return { verdict, analysis, score: `${results.pass.length}/${results.pass.length + results.warn.length + results.fail.length}` };
    }
  },

  pl: {
    title: 'Pattern Librarian',
    expertise: ['documentation', 'deduplication', 'cross-pollination', 'API design', 'Seed Vault'],
    // Documentation completeness standard
    docStandard: {
      required: ['Component name and description', 'JTBD statement (Functional need)', 'API surface: props, events, slots', 'Usage examples (minimum 3)', 'Do/Don\'t guidelines', 'Accessibility notes', 'Token dependencies', 'Related components', 'Changelog'],
      quality: ['Code examples must be copy-pasteable', 'Props table with type, default, description', 'Visual examples for all states and variants', 'Migration guide if replacing existing pattern']
    },
    // Cross-pollination checks
    crossPollination: {
      seedVaultScan: 'Check every new proposal against all Seed Vault entries for overlap or revival opportunity',
      existingLibrary: 'Check against all existing primitives and composites for composition opportunity',
      patternMining: 'Quarterly review of ad-hoc product patterns for system-level extraction'
    },
    // API surface design principles
    apiPrinciples: [
      'Minimal API surface ‚Äî fewer props, more composable',
      'Sensible defaults for every prop (zero-config usable)',
      'Consistent naming: on[Event] for callbacks, is[State] for booleans',
      'Render props or slots for customization, not config objects',
      'Avoid stringly-typed APIs ‚Äî use enums/union types',
      'Composability over configuration ‚Äî prefer children/slots over mega-props'
    ],
    generateReview(comp, zone) {
      // Check for duplicates in existing system
      const existingComps = ['Button','Input','Badge','Avatar','Toggle','Card','Dialog','Toast','Tabs'];
      const vaultComps = seedVault.map(s => s.name);
      const dupeCheck = existingComps.find(e => comp.name.toLowerCase().includes(e.toLowerCase()));
      const vaultMatch = vaultComps.find(v => v.toLowerCase().includes(comp.name.toLowerCase().slice(0,4)) || comp.name.toLowerCase().includes(v.toLowerCase().slice(0,4)));
      // Documentation audit
      const docItems = this.docStandard.required;
      const docResults = docItems.map(item => ({ item, present: Math.random() > 0.35 }));
      const docPassed = docResults.filter(d => d.present).length;
      let analysis = `**Pattern & Documentation Audit ‚Äî ${comp.name}**\n\n`;
      // Deduplication
      analysis += `**Deduplication Scan:**\n`;
      if (dupeCheck) {
        analysis += `‚ö†Ô∏è Overlap detected with existing component "${dupeCheck}". Can ${comp.name} compose from ${dupeCheck} instead of being a new component?\n`;
      } else {
        analysis += `‚úÖ No duplication found against ${existingComps.length} existing components.\n`;
      }
      // Seed Vault cross-pollination
      if (vaultMatch) {
        analysis += `üîÑ **Cross-pollination opportunity!** Seed Vault entry "${vaultMatch}" has overlapping patterns. Consider revival + merge.\n`;
      } else {
        analysis += `‚úÖ Seed Vault scan: No matching archived patterns among ${vaultComps.length} vault entries.\n`;
      }
      // API Surface
      analysis += `\n**API Surface Review:**\n`;
      this.apiPrinciples.forEach(p => {
        analysis += `${Math.random() > 0.25 ? '‚úÖ' : '‚ö†Ô∏è'} ${p}\n`;
      });
      // Documentation completeness
      analysis += `\n**Documentation Completeness: ${docPassed}/${docItems.length}**\n`;
      docResults.forEach(d => analysis += `${d.present ? '‚úÖ' : 'üìù'} ${d.item}\n`);
      const verdict = !dupeCheck && docPassed >= docItems.length * 0.6 ? 'APPROVED' : 'NEEDS WORK';
      analysis += `\nVerdict: ${verdict}${dupeCheck ? ' ‚Äî Resolve duplication concern with ' + dupeCheck + ' before proceeding.' : ''}`;
      return { verdict, analysis, score: `${docPassed}/${docItems.length}` };
    }
  },

  ca: {
    title: 'Component Architect',
    expertise: ['composition', 'atomic design', 'dependencies', 'bundle size', 'SSR', 'performance'],
    // Atomic Design hierarchy mapping
    atomicTiers: { atom: 'Button, Input, Badge, Avatar, Icon, Label', molecule: 'Input Group, Search Bar, Form Field, Nav Item', organism: 'Card, Dialog, Navigation Bar, Form, Table', template: 'Page layouts, Dashboard shells', page: 'Concrete instances with real data' },
    // Architecture rules
    archRules: [
      'Inward dependency direction ‚Äî composites depend on primitives, never reverse',
      'No circular dependencies between components',
      'Single responsibility ‚Äî one component, one job',
      'Composition over inheritance ‚Äî use slots/children, not extends',
      'Bundle size budget: individual component < 5KB gzipped',
      'Tree-shakeable: unused components should not appear in bundle',
      'SSR compatible: no window/document access at import time',
      'Framework-agnostic tokens: styles via CSS custom properties',
      'Zero external runtime dependencies beyond the design system core'
    ],
    // Composition analysis
    compositionPatterns: {
      compound: 'Parent provides context, children consume (Tabs+TabPanel, Accordion+Panel)',
      render_prop: 'Component accepts render function for custom content',
      slot: 'Named slots for flexible content areas (header, body, footer)',
      controlled: 'Parent manages state via value+onChange props',
      uncontrolled: 'Component manages own state with optional defaultValue'
    },
    generateReview(comp, zone) {
      // Determine atomic tier
      const isComposite = comp.type === 'composite';
      const tier = isComposite ? 'organism' : 'atom';
      // Run architecture checks
      const archResults = this.archRules.map(rule => ({
        rule,
        pass: Math.random() > 0.2
      }));
      const passed = archResults.filter(r => r.pass).length;
      const total = archResults.length;
      // Suggest composition pattern
      const patterns = Object.entries(this.compositionPatterns);
      const suggested = patterns[Math.floor(Math.random() * patterns.length)];
      let analysis = `**Architecture Review ‚Äî ${comp.name}**\n\n`;
      analysis += `**Atomic Classification:** ${tier} (${isComposite ? 'Composite' : 'Primitive'})\n`;
      analysis += `Reference: "${this.atomicTiers[tier]}"\n\n`;
      // Composition
      analysis += `**Composition Model:**\n`;
      if (isComposite) {
        analysis += `Recommended pattern: **${suggested[0]}** ‚Äî ${suggested[1]}\n`;
        analysis += `${comp.name} should compose from existing primitives (Button, Input, Badge, etc.)\n`;
        analysis += `Dependency direction: ${comp.name} ‚Üí [Primitives] (inward only ‚úÖ)\n\n`;
      } else {
        analysis += `As a primitive, ${comp.name} should have ZERO dependencies on other components.\n`;
        analysis += `It becomes a building block for composites.\n\n`;
      }
      // Architecture audit
      analysis += `**Architecture Checklist: ${passed}/${total}**\n`;
      archResults.forEach(r => analysis += `${r.pass ? '‚úÖ' : '‚ùå'} ${r.rule}\n`);
      // Performance
      const bundleEst = isComposite ? (Math.random() * 4 + 1.5).toFixed(1) : (Math.random() * 2 + 0.3).toFixed(1);
      analysis += `\n**Performance:**\n`;
      analysis += `Estimated bundle: ${bundleEst}KB gzipped ${parseFloat(bundleEst) > 5 ? '‚ùå Over budget!' : '‚úÖ Within budget'}\n`;
      analysis += `SSR: ${Math.random() > 0.15 ? '‚úÖ No window/document at import' : '‚ö†Ô∏è Uses document ‚Äî needs SSR guard'}\n`;
      analysis += `Tree-shaking: ${Math.random() > 0.1 ? '‚úÖ Side-effect free' : '‚ö†Ô∏è Has module-level side effects'}\n`;
      const verdict = passed >= total * 0.7 && parseFloat(bundleEst) <= 5 ? 'APPROVED' : 'NEEDS WORK';
      analysis += `\nVerdict: ${verdict}`;
      return { verdict, analysis, score: `${passed}/${total}` };
    }
  },

  px: {
    title: 'Product Liaison',
    expertise: ['adoption metrics', 'team validation', 'use cases', 'migration', 'feedback loops'],
    // Adoption KPIs (sourced from Pinterest, Shopify Polaris, IBM Carbon research)
    adoptionMetrics: {
      coverage: 'Component adoption rate = DS components √∑ total components per screen',
      reuse: 'Reuse rate across teams ‚Äî target: 80%+ screens using DS components',
      efficiency: 'Time saved per feature: target 30-50% reduction (Shopify benchmark)',
      consistency: 'Visual regression incidents ‚Äî target: <2% per release',
      satisfaction: 'Developer NPS for design system ‚Äî target: 8+/10'
    },
    // Validation requirements per stage
    validationGates: {
      nursery: 'At least 2 teams building ad-hoc solutions (evidence of need)',
      workshop: '2+ teams prototyping with the component (active validation)',
      canopy: '3+ teams validated, at least 1 in production (proven adoption)'
    },
    // Use case template
    useCaseTemplate: ['Team name', 'Use case description', 'Integration status (prototype/staging/production)', 'Feedback and pain points', 'Required modes or variants', 'Timeline for adoption'],
    generateReview(comp, zone) {
      const gate = this.validationGates[zone];
      // Simulate team adoption data
      const teams = [
        { name: 'Team Finance', status: Math.random() > 0.3 ? 'production' : 'prototype', feedback: 'Needs range selection mode' },
        { name: 'Team HR', status: Math.random() > 0.4 ? 'staging' : 'prototype', feedback: 'Single date mode works well' },
        { name: 'Team Commerce', status: Math.random() > 0.5 ? 'prototype' : 'evaluating', feedback: 'Needs localization support' },
        { name: 'Team Analytics', status: Math.random() > 0.6 ? 'evaluating' : 'not started', feedback: 'Interested but low priority' }
      ];
      const activeTeams = teams.filter(t => t.status !== 'not started' && t.status !== 'evaluating');
      const prodTeams = teams.filter(t => t.status === 'production');
      let analysis = `**Product Adoption Report ‚Äî ${comp.name}**\n\n`;
      analysis += `**Validation Gate (${zone}):** ${gate}\n\n`;
      // Team adoption matrix
      analysis += `**Team Adoption Matrix:**\n`;
      teams.forEach(t => {
        const icon = t.status === 'production' ? 'üü¢' : t.status === 'staging' ? 'üü°' : t.status === 'prototype' ? 'üîµ' : '‚ö™';
        analysis += `${icon} ${t.name}: ${t.status} ‚Äî "${t.feedback}"\n`;
      });
      analysis += `\nActive integrations: ${activeTeams.length}/4 teams\n`;
      analysis += `Production: ${prodTeams.length} | Staging: ${teams.filter(t=>t.status==='staging').length} | Prototype: ${teams.filter(t=>t.status==='prototype').length}\n\n`;
      // Adoption metrics
      analysis += `**Projected KPIs:**\n`;
      Object.entries(this.adoptionMetrics).forEach(([key, desc]) => {
        analysis += `üìä ${key}: ${desc}\n`;
      });
      // Required modes/variants from feedback
      const modes = [...new Set(teams.filter(t=>t.feedback).map(t => t.feedback))];
      analysis += `\n**Feature Requests from Teams:**\n`;
      modes.forEach(m => analysis += `‚Üí ${m}\n`);
      const meetsGate = zone === 'nursery' ? activeTeams.length >= 2 : zone === 'workshop' ? activeTeams.length >= 2 : activeTeams.length >= 3 && prodTeams.length >= 1;
      const verdict = meetsGate ? 'APPROVED' : 'NEEDS MORE ADOPTION';
      analysis += `\nVerdict: ${verdict} (${activeTeams.length} active teams${!meetsGate ? ' ‚Äî need more before promotion' : ''})`;
      return { verdict, analysis, score: `${activeTeams.length}/4 teams` };
    }
  }
};

// ============================================================
// COMPONENT PIPELINE ‚Äî Real Governance Workflow
// ============================================================
const pipeline = {
  nursery: [],
  workshop: [],
  canopy: [],
  promoted: [],  // Components that graduated to Stable (appear in sidebar)
  activityLog: [],
  nextId: 1
};

function createPipelineComponent(name, type, description) {
  return {
    id: 'COMP-' + String(pipeline.nextId++).padStart(3, '0'),
    name: name,
    type: type, // 'primitive' | 'composite'
    description: description,
    zone: 'nursery',
    maturity: 'draft',
    createdAt: Date.now(),
    movedAt: Date.now(),
    agentReviews: {},  // { agentId: { status, comment, proposals: [] } }
    proposals: [],     // GOV-IDs linked to this component
    shielded: false,
    isLive: false
  };
}

function submitToPipeline() {
  const nameEl = document.getElementById('pipelineName');
  const typeEl = document.getElementById('pipelineType');
  const descEl = document.getElementById('pipelineDesc');
  const name = (nameEl.value || '').trim();
  const type = typeEl.value;
  const desc = (descEl.value || '').trim();
  if (!name) { showToast('warning', 'Name Required', 'Enter a component name.'); return; }
  if (!desc) { showToast('warning', 'Description Required', 'Describe the functional need (JTBD).'); return; }
  // Check duplicate
  const all = [...pipeline.nursery, ...pipeline.workshop, ...pipeline.canopy, ...pipeline.promoted];
  if (all.find(c => c.name.toLowerCase() === name.toLowerCase())) {
    showToast('warning', 'Duplicate', name + ' already exists in the pipeline.'); return;
  }
  const comp = createPipelineComponent(name, type, desc);
  pipeline.nursery.push(comp);
  logPipelineActivity('submitted', comp.id, name, 'gardener', 'Entered Nursery as ' + type + ' draft');
  // Auto-generate agent observations for nursery (builder-only, no rejection)
  autoAgentReview(comp, 'nursery');
  nameEl.value = ''; descEl.value = '';
  renderPipeline();
  showToast('success', 'Submitted!', name + ' is now germinating in the Nursery.');
  // Update terrarium view
  setZone('nursery');
  updateCenterComponent('seedling', name);
  logMini('<b style="color:var(--t-raw-green-400);">üå± ' + name + ' entered the Nursery</b>');
}

function autoAgentReview(comp, zone) {
  const rules = ZONE_RULES[zone];
  const agents = Object.keys(AGENT_META);

  // Update terrarium view ‚Äî show component and zone
  setZone(zone);
  updateCenterComponent(zone === 'nursery' ? 'seedling' : zone === 'workshop' ? 'growing' : 'validating', comp.name);

  agents.forEach((agentId, idx) => {
    const skills = AGENT_SKILLS[agentId];
    // Update terrarium agent status in real time
    updateAgentStatus(agentId, 'Reviewing...');

    if (skills && skills.generateReview) {
      const review = skills.generateReview(comp, zone);
      const statusMap = { 'APPROVED': 'approved', 'CONDITIONAL': 'reviewing', 'NEEDS WORK': 'reviewing', 'VETO RISK': 'reviewing', 'NEEDS MORE ADOPTION': 'reviewing' };
      const status = statusMap[review.verdict] || 'observing';
      const finalStatus = zone === 'nursery' ? 'observing' : status;
      comp.agentReviews[agentId] = {
        status: finalStatus,
        verdict: review.verdict,
        comment: review.analysis,
        score: review.score,
        expertise: skills.expertise || [],
        timestamp: Date.now()
      };
      // Update terrarium agent status with verdict
      const verdictIcon = review.verdict === 'APPROVED' ? '‚úì' : review.verdict === 'VETO RISK' ? '‚úó' : '~';
      updateAgentStatus(agentId, `${verdictIcon} ${review.score || review.verdict}`);
      // Short summary for activity log
      const shortSummary = `[${review.verdict}] ${review.score} ‚Äî ${skills.title} review complete`;
      logPipelineActivity('agent_review', comp.id, comp.name, agentId, shortSummary);
      logMini(`<span style="color:${AGENT_META[agentId].hex};">${AGENT_META[agentId].short}</span> ‚Üí ${review.verdict} ${review.score || ''}`);
    } else {
      comp.agentReviews[agentId] = { status: 'pending', comment: 'Awaiting review.', timestamp: Date.now() };
      updateAgentStatus(agentId, 'Pending');
    }
  });
}

function generatePipelineProposals(comp) {
  const zone = comp.zone;
  // Generate real governance proposals for this component
  const proposalsGenerated = [];
  // Token Steward proposes token changes
  const tokenData = generateTokenProposal('ts', comp.name, zone);
  if (tokenData) {
    const p = createProposal({ type: 'token', agent: 'ts', targetId: comp.id, ...tokenData, zone });
    submitProposal(p);
    comp.proposals.push(p.id);
    proposalsGenerated.push(p.id);
  }
  // A11y Guardian proposes spec changes
  const agData = generateTokenProposal('ag', comp.name, zone);
  if (agData) {
    const p = createProposal({ type: 'token', agent: 'ag', targetId: comp.id, ...agData, zone });
    submitProposal(p);
    comp.proposals.push(p.id);
    proposalsGenerated.push(p.id);
  }
  // Component Architect proposes radius changes
  const caData = generateTokenProposal('ca', comp.name, zone);
  if (caData) {
    const p = createProposal({ type: 'token', agent: 'ca', targetId: comp.id, ...caData, zone });
    submitProposal(p);
    comp.proposals.push(p.id);
    proposalsGenerated.push(p.id);
  }
  // Pattern Librarian proposes spec
  const plData = generateSpecProposal('pl', comp.name, zone);
  if (plData) {
    const p = createProposal({ type: 'spec', agent: 'pl', targetId: comp.id, ...plData, zone });
    submitProposal(p);
    comp.proposals.push(p.id);
    proposalsGenerated.push(p.id);
  }
  // Product Liaison proposes validation
  const pxData = generateSpecProposal('px', comp.name, zone);
  if (pxData) {
    const p = createProposal({ type: 'spec', agent: 'px', targetId: comp.id, ...pxData, zone });
    submitProposal(p);
    comp.proposals.push(p.id);
    proposalsGenerated.push(p.id);
  }
  return proposalsGenerated;
}

function runAgentReview() {
  // Find the first component in any zone that doesn't have proposals yet or run review on selected tab
  const activeTab = document.querySelector('.pipeline-tab--active');
  const zone = activeTab ? activeTab.textContent.trim().toLowerCase().split(' ')[1] : 'nursery';
  const zoneKey = zone.includes('nursery') ? 'nursery' : zone.includes('workshop') ? 'workshop' : zone.includes('canopy') ? 'canopy' : 'nursery';
  const items = pipeline[zoneKey];
  if (items.length === 0) {
    showToast('info', 'No Components', 'Submit a component to the pipeline first.');
    return;
  }
  // Generate proposals for all items in this zone
  let totalProposals = 0;
  items.forEach(comp => {
    const generated = generatePipelineProposals(comp);
    totalProposals += generated.length;
    // Update agent reviews to show they've contributed
    Object.keys(comp.agentReviews).forEach(agentId => {
      comp.agentReviews[agentId].status = 'reviewed';
    });
    // Animate terrarium
    setZone(zoneKey);
    updateCenterComponent(zoneKey === 'nursery' ? 'growing' : zoneKey === 'workshop' ? 'validating' : 'stable', comp.name);
  });
  renderPipeline();
  showToast('success', 'Agents Reviewed', totalProposals + ' proposals generated. Check Approval Queue.');
  logMini('<b style="color:var(--t-raw-green-400);">‚úì ' + totalProposals + ' proposals from agent review ‚Üí Approval Queue</b>');
}

function promoteComponent(compId) {
  // Find the component across all zones
  let comp = null;
  let fromZone = null;
  for (const zone of ['nursery', 'workshop', 'canopy']) {
    const idx = pipeline[zone].findIndex(c => c.id === compId);
    if (idx !== -1) {
      comp = pipeline[zone].splice(idx, 1)[0];
      fromZone = zone;
      break;
    }
  }
  if (!comp) return;
  const zoneOrder = ['nursery', 'workshop', 'canopy'];
  const currentIdx = zoneOrder.indexOf(fromZone);
  if (currentIdx < 2) {
    // Move to next zone
    const nextZone = zoneOrder[currentIdx + 1];
    comp.zone = nextZone;
    comp.maturity = nextZone === 'workshop' ? 'candidate' : nextZone === 'canopy' ? 'candidate' : 'draft';
    comp.movedAt = Date.now();
    pipeline[nextZone].push(comp);
    // If already live, update sidebar maturity badge
    if (comp.isLive) {
      updateComponentMaturity(comp.name.toLowerCase(), comp.maturity);
    }
    // Generate fresh agent reviews for new zone
    autoAgentReview(comp, nextZone);
    logPipelineActivity('promoted', comp.id, comp.name, 'gardener', `Moved from ${fromZone} to ${nextZone}`);
    renderPipeline();
    showToast('success', 'Promoted!', comp.name + ' moved to ' + ZONE_RULES[nextZone].label);
    setZone(nextZone);
    updateCenterComponent(nextZone === 'workshop' ? 'growing' : 'validating', comp.name);
    logMini('<b style="color:var(--t-raw-blue-400);">üìà ' + comp.name + ' promoted to ' + nextZone + '</b>');
  } else {
    // Canopy ‚Üí Stable (promoted to live component!)
    comp.zone = 'stable';
    comp.maturity = 'stable';
    comp.movedAt = Date.now();
    comp.isLive = true;
    pipeline.promoted.push(comp);
    logPipelineActivity('graduated', comp.id, comp.name, 'gardener', 'Graduated to STABLE ‚Äî now a live component');
    // Add to sidebar nav (or update if already live from an earlier Push Live)
    const existing = document.querySelector('[data-target="' + comp.name.toLowerCase() + '"]');
    if (existing) {
      updateComponentMaturity(comp.name.toLowerCase(), 'stable');
    } else {
      addComponentToSidebar(comp);
      addComponentStory(comp);
    }
    renderPipeline();
    showToast('success', 'üåø Stable!', comp.name + ' is now a live component in the design system.');
    updateCenterComponent('stable', comp.name);
    logMini('<b style="color:var(--t-raw-green-400);">üå≥ ' + comp.name + ' graduated to STABLE</b>');
  }
}

function seedVaultComponent(compId) {
  let comp = null;
  for (const zone of ['nursery', 'workshop', 'canopy']) {
    const idx = pipeline[zone].findIndex(c => c.id === compId);
    if (idx !== -1) {
      comp = pipeline[zone].splice(idx, 1)[0];
      break;
    }
  }
  if (!comp) return;
  // Add to seed vault
  seedVault.push({
    name: comp.name,
    archivedDate: new Date().toISOString().slice(0, 10),
    reason: 'Moved to Seed Vault from ' + comp.zone + '. Preserved with full context for future revival.',
    context: comp.description + '. Agent reviews: ' + Object.entries(comp.agentReviews).map(([a, r]) => AGENT_META[a].short + ': ' + r.comment).join('; '),
    revivable: true,
    reviveReason: 'Conditions may change. Gardener can revive at any time.',
    agents: Object.fromEntries(Object.entries(comp.agentReviews).map(([a, r]) => [a, r.comment.substring(0, 60)]))
  });
  logPipelineActivity('seed-vaulted', comp.id, comp.name, 'gardener', 'Preserved in Seed Vault');
  renderPipeline();
  renderSeedVault();
  showToast('info', 'Seed Vaulted', comp.name + ' preserved with full context.');
}

function addComponentToSidebar(comp) {
  const sectionTitle = comp.type === 'composite' ? 'Composites' : 'Primitives';
  const sections = document.querySelectorAll('.nav-section');
  let targetSection = null;
  sections.forEach(sec => {
    const title = sec.querySelector('.nav-section__title');
    if (title && title.textContent.trim() === sectionTitle) targetSection = sec;
  });
  if (!targetSection) return;
  // Check if already exists
  if (targetSection.querySelector('[data-target="' + comp.name.toLowerCase() + '"]')) return;
  const btn = document.createElement('button');
  btn.className = 'nav-item';
  btn.setAttribute('data-target', comp.name.toLowerCase());
  btn.setAttribute('onclick', 'nav(this)');
  const maturity = comp.maturity || 'draft';
  btn.innerHTML = '<span class="nav-item__dot nav-item__dot--' + maturity + '"></span>' + comp.name;
  targetSection.appendChild(btn);
}

// ---- COMPONENT STORY BUILDER ----
// Creates story pages for pipeline-graduated components.
// No template facades ‚Äî components earn their place through governance.

function addComponentStory(comp) {
  const main = document.getElementById('mainContent');
  const storyId = 'story-' + comp.name.toLowerCase().replace(/\s+/g, '-');
  if (document.getElementById(storyId)) return;

  const maturity = comp.maturity || 'draft';
  const maturityLabel = maturity.charAt(0).toUpperCase() + maturity.slice(1);
  const maturityBadgeClass = 't-badge--' + maturity;
  const zoneLabel = comp.zone ? comp.zone.charAt(0).toUpperCase() + comp.zone.slice(1) : 'Pipeline';

  // Build agent review history
  const agentHistoryHTML = comp.agentReviews
    ? Object.entries(comp.agentReviews).map(([a, r]) =>
      '<div style="margin-bottom:var(--t-space-1);"><span style="color:' + (AGENT_META[a]?.hex || '#888') + ';font-weight:600;font-size:11px;">' + (AGENT_META[a]?.short || a) + '</span> <span class="t-caption" style="color:var(--t-fg-tertiary);">' + (r.verdict || '') + (r.score ? ' ' + r.score : '') + '</span><div class="t-caption" style="color:var(--t-fg-secondary);margin-top:1px;">' + (r.comment || '').substring(0, 200) + '</div></div>'
    ).join('')
    : '<div class="t-caption" style="color:var(--t-fg-tertiary);">No agent reviews yet.</div>';

  // Proposal summary
  const proposalCount = comp.proposals?.length || 0;
  const reviewCount = comp.agentReviews ? Object.keys(comp.agentReviews).length : 0;

  const section = document.createElement('section');
  section.className = 'story';
  section.id = storyId;
  section.innerHTML = `
    <h1 class="story__title">${comp.name}</h1>
    <p class="story__desc" contenteditable="true">${comp.description}</p>
    <div class="story__meta">
      <span class="t-badge ${maturityBadgeClass}">${maturityLabel}</span>
      <span class="t-badge t-badge--neutral">${comp.type === 'composite' ? 'Composite' : 'Primitive'}</span>
      <span class="t-badge t-badge--neutral">${zoneLabel}</span>
      <span class="t-badge t-badge--brand">Governance-Built</span>
    </div>
    <div class="canvas">
      <div class="canvas__label">Component Status</div>
      <div style="padding:var(--t-space-4);">
        <div class="t-body-sm" style="color:var(--t-fg-secondary);max-width:480px;">
          <p style="margin-bottom:var(--t-space-2);">This component was born through the Terrarium pipeline. It has passed through <strong>${zoneLabel}</strong> zone governance with <strong>${reviewCount}/6</strong> agent reviews and <strong>${proposalCount}</strong> proposal${proposalCount !== 1 ? 's' : ''}.</p>
          <p style="color:var(--t-fg-tertiary);font-size:var(--t-text-xs);">Pipeline ID: ${comp.id}</p>
        </div>
      </div>
    </div>
    <div class="canvas">
      <div class="canvas__label">Governance History</div>
      <div style="padding:var(--t-space-3);">${agentHistoryHTML}</div>
    </div>
  `;
  main.appendChild(section);
}

function logPipelineActivity(action, compId, compName, actor, detail) {
  pipeline.activityLog.push({
    timestamp: Date.now(),
    action, compId, compName, actor, detail
  });
}

function switchPipelineTab(tabEl, panelId) {
  document.querySelectorAll('.pipeline-tab').forEach(t => t.classList.remove('pipeline-tab--active'));
  tabEl.classList.add('pipeline-tab--active');
  document.querySelectorAll('.pipeline-panel').forEach(p => p.classList.remove('pipeline-panel--active'));
  document.getElementById('pipeline-' + panelId).classList.add('pipeline-panel--active');
}

function renderPipeline() {
  // Update counts
  const nc = document.getElementById('pipeNurseryCount');
  const wc = document.getElementById('pipeWorkshopCount');
  const cc = document.getElementById('pipeCanopyCount');
  if (nc) nc.textContent = pipeline.nursery.length;
  if (wc) wc.textContent = pipeline.workshop.length;
  if (cc) cc.textContent = pipeline.canopy.length;

  // Render each zone
  renderPipelineZone('nursery', 'pipeNurseryList');
  renderPipelineZone('workshop', 'pipeWorkshopList');
  renderPipelineZone('canopy', 'pipeCanopyList');
  renderPipelineActivityLog();
}

function renderPipelineZone(zone, containerId) {
  const el = document.getElementById(containerId);
  if (!el) return;
  const items = pipeline[zone];
  if (items.length === 0) {
    const emptyMessages = {
      nursery: { icon: 'üå±', text: 'No seedlings yet. Submit a new component above to start the governance workflow.' },
      workshop: { icon: 'ü™¥', text: 'No components in the Workshop. Promote items from the Nursery to begin structured exploration.' },
      canopy: { icon: 'üå≥', text: 'No components in the Canopy. Promote items from the Workshop for final validation and stable graduation.' }
    };
    const msg = emptyMessages[zone] || { icon: 'üì≠', text: 'Empty.' };
    el.innerHTML = `<div class="pipeline-empty"><div class="pipeline-empty__icon">${msg.icon}</div><div class="pipeline-empty__text">${msg.text}</div></div>`;
    return;
  }
  el.innerHTML = items.map(comp => renderComponentCard(comp, zone)).join('');
}

function renderComponentCard(comp, zone) {
  const rules = ZONE_RULES[zone];
  const tipMap = { ag: 'a11y-guardian', ds: 'ds-lead', ts: 'token-steward', pl: 'pattern-librarian', ca: 'component-architect', px: 'product-liaison' };

  // Build agent review chips with verdict badges
  const agentChips = Object.entries(comp.agentReviews).map(([agentId, review]) => {
    const meta = AGENT_META[agentId];
    const hasVerdict = !!review.verdict;
    const verdictColor = review.verdict === 'APPROVED' ? 'var(--t-raw-green-600)' : review.verdict === 'VETO RISK' ? 'var(--t-raw-red-600)' : review.verdict === 'CONDITIONAL' ? 'var(--t-raw-amber-600)' : 'var(--t-fg-tertiary)';
    const statusClass = review.status === 'approved' ? 'comp-card__agent-chip--approved' : 'comp-card__agent-chip--pending';
    const icon = review.status === 'approved' ? '‚úÖ' : review.status === 'observing' ? 'üëÅ' : review.status === 'reviewing' ? 'üîç' : '‚è≥';
    return `<span class="comp-card__agent-chip ${statusClass}" data-tip="${tipMap[agentId] || ''}" style="cursor:pointer;" onclick="toggleAgentDetail('${comp.id}','${agentId}')">
      <span class="comp-card__agent-chip__dot" style="background:${meta.hex};"></span>
      ${icon} ${meta.short}${review.score ? ' <span style="font-size:9px;color:' + verdictColor + ';">' + review.score + '</span>' : ''}
    </span>`;
  }).join('');

  // Build expandable agent detail panels
  const agentDetails = Object.entries(comp.agentReviews).map(([agentId, review]) => {
    const meta = AGENT_META[agentId];
    const skills = AGENT_SKILLS[agentId];
    if (!review.comment || review.comment.length < 30) return '';
    // Convert markdown-like formatting to HTML
    const htmlComment = review.comment
      .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
      .replace(/\n/g, '<br>')
      .replace(/‚úÖ/g, '<span style="color:var(--t-raw-green-600);">‚úÖ</span>')
      .replace(/‚ùå/g, '<span style="color:var(--t-raw-red-600);">‚ùå</span>')
      .replace(/‚ö†Ô∏è/g, '<span style="color:var(--t-raw-amber-600);">‚ö†Ô∏è</span>')
      .replace(/üìù/g, '<span>üìù</span>')
      .replace(/üîÑ/g, '<span>üîÑ</span>')
      .replace(/üö®/g, '<span style="color:var(--t-raw-red-600);">üö®</span>');
    return `<div class="comp-card__agent-detail" id="agent-detail-${comp.id}-${agentId}" style="display:none;margin-top:var(--t-space-2);padding:var(--t-space-3);background:var(--t-surface-1);border-radius:var(--t-radius-md);border-left:3px solid ${meta.hex};font-size:11px;line-height:1.6;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--t-space-2);">
        <b style="color:${meta.hex};">${meta.title}${review.verdict ? ' ‚Äî <span style="font-size:10px;padding:1px 6px;border-radius:8px;background:' + (review.verdict==='APPROVED'?'rgba(45,106,79,0.12)':review.verdict==='VETO RISK'?'rgba(224,49,49,0.12)':'rgba(245,159,0,0.12)') + ';">' + review.verdict + '</span>' : ''}</b>
        ${skills ? '<span style="font-size:9px;color:var(--t-fg-tertiary);">Expertise: ' + skills.expertise.join(', ') + '</span>' : ''}
      </div>
      <div style="color:var(--t-fg-secondary);">${htmlComment}</div>
    </div>`;
  }).join('');

  const proposalCount = comp.proposals.length;
  const timeSince = Math.round((Date.now() - comp.createdAt) / 60000);
  const timeStr = timeSince < 1 ? 'just now' : timeSince < 60 ? timeSince + 'm ago' : Math.round(timeSince / 60) + 'h ago';

  // Count verdicts for promotion eligibility
  const verdicts = Object.values(comp.agentReviews).map(r => r.verdict).filter(Boolean);
  const approved = verdicts.filter(v => v === 'APPROVED').length;
  const vetoRisk = verdicts.filter(v => v === 'VETO RISK').length;
  const canPromote = zone !== 'canopy' || (approved >= 5 && vetoRisk === 0);
  const promoteLabel = zone === 'nursery' ? 'Promote to Workshop' : zone === 'workshop' ? 'Promote to Canopy' : 'Graduate to Stable üåø';

  // Overall health summary
  const healthStr = verdicts.length > 0
    ? `<span style="font-size:10px;color:var(--t-fg-tertiary);">Agent consensus: ${approved}/${verdicts.length} approved${vetoRisk > 0 ? ' ¬∑ <span style="color:var(--t-raw-red-600);">' + vetoRisk + ' veto risk</span>' : ''}</span>`
    : '';

  return `<div class="comp-card">
    <div class="comp-card__header">
      <div>
        <div class="comp-card__name">${comp.name} <span class="t-badge t-badge--${comp.maturity}" style="font-size:9px;vertical-align:middle;">${comp.maturity}</span></div>
        <div class="t-caption" style="color:var(--t-fg-tertiary);">${comp.id} ¬∑ ${comp.type} ¬∑ ${timeStr}${comp.shielded ? ' ¬∑ üõ°Ô∏è Shielded' : ''}</div>
      </div>
      <span class="comp-card__zone-badge comp-card__zone-badge--${zone}">${rules.label}</span>
    </div>
    <div class="comp-card__desc">${comp.description}</div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--t-space-1);">
      <div class="comp-card__agents" style="margin-bottom:0;">${agentChips}</div>
      ${healthStr}
    </div>
    <div style="font-size:10px;color:var(--t-fg-tertiary);margin-bottom:var(--t-space-2);cursor:pointer;" onclick="toggleAllAgentDetails('${comp.id}')">Click any agent chip to expand their full review ‚ñæ</div>
    ${agentDetails}
    ${proposalCount > 0 ? `<div class="comp-card__proposals">üìã ${proposalCount} governance proposal${proposalCount > 1 ? 's' : ''} submitted ‚Üí <a href="#" onclick="nav(document.querySelector('[data-target=approvals]'));return false;" style="color:var(--t-fg-link);">Approval Queue</a></div>` : '<div class="comp-card__proposals" style="color:var(--t-raw-amber-500);">No proposals yet ‚Äî click "Run Agent Review" to generate</div>'}
    ${comp.isLive ? '<div style="display:flex;align-items:center;gap:var(--t-space-2);padding:var(--t-space-2);background:rgba(45,106,79,0.08);border-radius:var(--t-radius-sm);margin-bottom:var(--t-space-2);"><span style="color:var(--t-raw-green-500);font-weight:600;font-size:11px;">üåø LIVE in sidebar</span><span style="font-size:10px;color:var(--t-fg-tertiary);">as ${comp.maturity}</span></div>' : ''}
    <div class="comp-card__actions">
      ${!comp.isLive ? `<button class="t-btn t-btn--sm" style="font-size:11px;background:var(--t-raw-green-600);color:white;border:none;" onclick="pushComponentLive(findPipelineComponent('${comp.id}'));renderPipeline();">üåø Push Live</button>` : ''}
      <button class="t-btn t-btn--primary t-btn--sm" style="font-size:11px;" onclick="promoteComponent('${comp.id}')" ${!canPromote ? 'disabled title="All agents must approve in Canopy"' : ''}>${promoteLabel}</button>
      <button class="t-btn t-btn--secondary t-btn--sm" style="font-size:11px;" onclick="seedVaultComponent('${comp.id}')">Seed Vault</button>
      <button class="t-btn t-btn--ghost t-btn--sm" style="font-size:11px;" onclick="runSingleAgentReview('${comp.id}')">Re-evaluate</button>
    </div>
  </div>`;
}

function toggleAgentDetail(compId, agentId) {
  const el = document.getElementById('agent-detail-' + compId + '-' + agentId);
  if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function toggleAllAgentDetails(compId) {
  const details = document.querySelectorAll('[id^="agent-detail-' + compId + '"]');
  const anyVisible = [...details].some(d => d.style.display !== 'none');
  details.forEach(d => d.style.display = anyVisible ? 'none' : 'block');
}

function runSingleAgentReview(compId) {
  let comp = null;
  let compZone = null;
  for (const zone of ['nursery', 'workshop', 'canopy']) {
    comp = pipeline[zone].find(c => c.id === compId);
    if (comp) { compZone = zone; break; }
  }
  if (!comp) return;
  // Re-run intelligent agent reviews with AGENT_SKILLS
  autoAgentReview(comp, compZone);
  // Generate governance proposals
  const generated = generatePipelineProposals(comp);
  renderPipeline();
  showToast('success', 'Deep Review Complete', `6 agents evaluated ${comp.name} using their full skill sets. ${generated.length} proposals generated.`);
}

function renderPipelineActivityLog() {
  const el = document.getElementById('pipeActivityLog');
  if (!el) return;
  if (pipeline.activityLog.length === 0) {
    el.innerHTML = '<div class="pipeline-empty"><div class="pipeline-empty__icon">üìã</div><div class="pipeline-empty__text">Activity log is empty. Submit a component to see governance activity here.</div></div>';
    return;
  }
  el.innerHTML = pipeline.activityLog.slice().reverse().map(e => {
    const time = new Date(e.timestamp).toLocaleTimeString();
    const actor = e.actor === 'gardener' ? 'üßë‚Äçüåæ Gardener' : (AGENT_META[e.actor] ? `<span style="color:${AGENT_META[e.actor].hex};">${AGENT_META[e.actor].short}</span>` : e.actor);
    const actionIcons = { submitted: 'üå±', promoted: 'üìà', graduated: 'üåø', 'seed-vaulted': 'üè∫', agent_review: 'üîç' };
    const icon = actionIcons[e.action] || 'üìù';
    return `<div class="audit-entry"><span class="audit-entry__time">${time}</span> ${icon} ${actor} ‚Äî <b>${e.compName}</b>: ${e.detail}</div>`;
  }).join('');
}

function createProposal(opts) {
  const zone = opts.zone || 'nursery';
  const rules = ZONE_RULES[zone];
  const p = {
    id: 'GOV-' + String(governance.nextId++).padStart(3, '0'),
    timestamp: Date.now(),
    type: opts.type, // 'token' | 'lifecycle' | 'spec'
    proposedBy: opts.agent,
    targetZone: zone,
    targetId: opts.targetId || null,
    rationale: opts.rationale || '',
    orpaCycle: opts.orpa || { observe: '', reflect: '', plan: '', act: '' },
    changes: opts.changes || [],
    approvalsNeeded: opts.approvalsNeeded || [],
    approvalsReceived: {},
    vetoedBy: null,
    vetoReason: null,
    citations: opts.citations || [],
    status: 'pending',
    zoneRules: { ...rules }
  };
  // Auto-approve by proposing agent
  p.approvalsReceived[opts.agent] = true;
  // In nursery, all agents auto-approve (no rejection allowed)
  if (zone === 'nursery') {
    p.approvalsNeeded.forEach(a => { p.approvalsReceived[a] = true; });
  }
  return p;
}

function submitProposal(proposal) {
  governance.proposals.push(proposal);
  logAudit('proposal_submitted', proposal.id, proposal.proposedBy, proposal.rationale);
  updateGovUI();
}

function logAudit(action, proposalId, actor, detail) {
  governance.auditLog.push({
    timestamp: Date.now(),
    action: action,
    proposalId: proposalId,
    actor: actor,
    detail: detail || ''
  });
}

function checkCompliance(proposal) {
  const rules = proposal.zoneRules;
  // AG absolute veto
  if (proposal.vetoedBy === 'ag' && rules.agVeto) {
    return { ok: false, reason: 'Accessibility Guardian has exercised absolute veto. Cannot override below Steering Committee.' };
  }
  // Unanimous check
  if (rules.unanimous) {
    const missing = proposal.approvalsNeeded.filter(a => !proposal.approvalsReceived[a]);
    if (missing.length > 0) {
      return { ok: false, reason: 'Unanimous approval required. Missing: ' + missing.map(a => AGENT_META[a].short).join(', ') };
    }
  }
  // Majority check
  if (rules.majority) {
    const count = Object.values(proposal.approvalsReceived).filter(Boolean).length;
    const needed = Math.ceil(proposal.approvalsNeeded.length / 2);
    if (count < needed) {
      return { ok: false, reason: `Majority required: ${count}/${proposal.approvalsNeeded.length} (need ${needed})` };
    }
  }
  return { ok: true };
}

function approveProposal(id) {
  const p = governance.proposals.find(x => x.id === id);
  if (!p) return;
  const compliance = checkCompliance(p);
  if (!compliance.ok) {
    // Gardener override ‚Äî allow with warning
    if (!confirm('‚ö†Ô∏è Governance warning:\\n\\n' + compliance.reason + '\\n\\nAs the Ecosystem Gardener, you can override this. Proceed?')) return;
    logAudit('gardener_override', id, 'gardener', compliance.reason);
  }
  p.status = 'staged';
  governance.proposals = governance.proposals.filter(x => x.id !== id);
  governance.staged.push(p);
  logAudit('approved', id, 'gardener', 'Human gardener approved');
  updateGovUI();
  showToast('success', 'Staged', p.id + ' approved ‚Äî ready to Push Live.');
}

function rejectProposal(id) {
  const p = governance.proposals.find(x => x.id === id);
  if (!p) return;
  if (p.zoneRules.label && !p.zoneRules.allowReject) {
    showToast('warning', 'Nursery Rule', 'Cannot reject in the Nursery. Ideas are seed-vaulted, not rejected.');
    p.status = 'seed-vaulted';
  } else {
    p.status = 'rejected';
  }
  governance.proposals = governance.proposals.filter(x => x.id !== id);
  logAudit('rejected', id, 'gardener', p.status);
  updateGovUI();
  showToast('info', p.status === 'seed-vaulted' ? 'Seed Vaulted' : 'Rejected', p.id + ' ‚Äî agents will adapt in next cycle.');
}

function previewProposal(id) {
  const p = governance.proposals.find(x => x.id === id) || governance.staged.find(x => x.id === id);
  if (!p || p.type !== 'token') { showToast('info', 'Preview', 'Preview available for token changes only.'); return; }
  // Show overlay with before/after
  const overlay = document.createElement('div');
  overlay.className = 'proposal-preview-overlay';
  overlay.onclick = function(e) { if (e.target === this) this.remove(); };
  const beforeTokens = p.changes.map(c => `<div><span class="diff-old">${c.token}: ${c.oldValue}</span></div>`).join('');
  const afterTokens = p.changes.map(c => `<div><span class="diff-new">${c.token}: ${c.newValue}</span></div>`).join('');
  const demoAfter = p.changes.map(c => `${c.token}: ${c.newValue};`).join(' ');
  overlay.innerHTML = `<div class="proposal-preview">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--t-space-3);">
      <h2 class="t-heading-sm">${p.id} ‚Äî Preview</h2>
      <button class="t-btn t-btn--ghost t-btn--sm" onclick="this.closest('.proposal-preview-overlay').remove()">Close</button>
    </div>
    <p class="t-body-sm" style="color:var(--t-fg-secondary);margin-bottom:var(--t-space-3);">${p.rationale}</p>
    <div class="proposal-preview__grid">
      <div class="proposal-preview__side">
        <div class="t-caption" style="margin-bottom:var(--t-space-2);font-weight:600;">Before</div>
        <div class="proposal-card__diff">${beforeTokens}</div>
        <div style="padding:var(--t-space-2);"><button class="t-btn t-btn--primary t-btn--sm">Sample Button</button></div>
      </div>
      <div class="proposal-preview__side">
        <div class="t-caption" style="margin-bottom:var(--t-space-2);font-weight:600;">After</div>
        <div class="proposal-card__diff">${afterTokens}</div>
        <div style="padding:var(--t-space-2);${demoAfter}"><button class="t-btn t-btn--primary t-btn--sm" style="${demoAfter}">Sample Button</button></div>
      </div>
    </div>
  </div>`;
  document.body.appendChild(overlay);
}

function pushLiveApprovedChanges() {
  if (governance.staged.length === 0) { showToast('info', 'Nothing to Push', 'No staged changes.'); return; }
  const count = governance.staged.length;
  pushUndo(); // Single undo snapshot for entire batch
  let applied = 0;
  let componentsLived = [];
  governance.staged.forEach(p => {
    // 1. Apply token changes to CSS
    if (p.type === 'token') {
      p.changes.forEach(c => { setTokenDirect(c.token, c.newValue); applied++; });
    }
    // 2. Apply spec changes (CSS properties within specs)
    if (p.type === 'spec') {
      p.changes.forEach(c => {
        if (c.cssProperty && c.newValue) { setTokenDirect(c.cssProperty, c.newValue); applied++; }
      });
    }
    // 3. Lifecycle changes ‚Äî update maturity AND make component live
    if (p.type === 'lifecycle') {
      const t = p.changes[0];
      if (t) {
        updateComponentMaturity(t.component, t.to);
        applied++;
      }
    }
    // 4. Find the pipeline component this proposal belongs to and push it live
    if (p.targetId) {
      const pipeComp = findPipelineComponent(p.targetId);
      if (pipeComp && !componentsLived.includes(p.targetId)) {
        pushComponentLive(pipeComp);
        componentsLived.push(p.targetId);
      }
    }
    p.status = 'pushed_live';
    p.pushedAt = Date.now();
    governance.pushed.push(p);
    logAudit('pushed_live', p.id, 'gardener', `Applied ${p.changes.length} changes`);
  });
  governance.staged = [];
  updateGovUI();
  updatePanel();
  updateDynamicContent();
  renderPipeline();
  const compMsg = componentsLived.length > 0 ? ` ${componentsLived.length} component(s) now live in the sidebar.` : '';
  showToast('success', 'Live!', `${applied} changes from ${count} proposals pushed to the live system.${compMsg} Ctrl+Z to revert.`);
}

// Find a pipeline component by its ID (COMP-xxx) or name across all zones
function findPipelineComponent(targetId) {
  for (const zone of ['nursery', 'workshop', 'canopy']) {
    const comp = pipeline[zone].find(c => c.id === targetId || c.name.toLowerCase() === targetId);
    if (comp) return comp;
  }
  // Also check if it's already promoted
  return pipeline.promoted.find(c => c.id === targetId || c.name.toLowerCase() === targetId) || null;
}

// Push a pipeline component live ‚Äî adds to sidebar with its CURRENT maturity, at ANY stage
function pushComponentLive(comp) {
  if (!comp) return;
  const alreadyLive = pipeline.promoted.find(c => c.id === comp.id);
  if (alreadyLive) {
    // Already live ‚Äî just update its maturity badge
    updateComponentMaturity(comp.name.toLowerCase(), comp.maturity);
    return;
  }
  // Check if already in sidebar
  const existing = document.querySelector('[data-target="' + comp.name.toLowerCase() + '"]');
  if (existing) {
    updateComponentMaturity(comp.name.toLowerCase(), comp.maturity);
    return;
  }
  // Add to sidebar nav with current maturity (draft, candidate, or stable)
  addComponentToSidebar(comp);
  // Create a story section for the component
  addComponentStory(comp);
  // Mark as live in pipeline (but DON'T remove from zone ‚Äî it stays visible there)
  comp.isLive = true;
  logPipelineActivity('went_live', comp.id, comp.name, 'gardener', `Now LIVE in sidebar as ${comp.maturity} (${comp.zone} zone)`);
  logMini('<b style="color:var(--t-raw-green-400);">üåø ' + comp.name + ' is now LIVE as ' + comp.maturity + '</b>');
}

function updateComponentMaturity(componentId, newTier) {
  const dotClass = { draft: 'nav-item__dot--draft', candidate: 'nav-item__dot--candidate', stable: 'nav-item__dot--stable' };
  // Normalize the ID (could be "COMP-001", "datepicker", or "DatePicker")
  const normalId = componentId.toLowerCase().replace(/\s+/g, '');
  // Update nav sidebar dot
  const navBtn = document.querySelector('[data-target="' + normalId + '"]');
  if (navBtn) {
    const dot = navBtn.querySelector('.nav-item__dot');
    if (dot) { dot.className = 'nav-item__dot ' + (dotClass[newTier] || 'nav-item__dot--draft'); }
  }
  // Update badge in story
  const story = document.getElementById('story-' + normalId);
  if (story) {
    const badges = story.querySelectorAll('.t-badge[class*="draft"], .t-badge[class*="candidate"], .t-badge[class*="stable"], .t-badge[class*="deprecated"]');
    if (badges.length > 0) {
      badges[0].className = 't-badge t-badge--' + newTier;
      badges[0].textContent = newTier.charAt(0).toUpperCase() + newTier.slice(1);
    }
  }
  // Also update the pipeline component's maturity
  for (const zone of ['nursery', 'workshop', 'canopy']) {
    const comp = pipeline[zone].find(c => c.name.toLowerCase() === normalId || c.id === componentId);
    if (comp) { comp.maturity = newTier; break; }
  }
  showToast('success', 'Maturity Updated', componentId + ' is now ' + newTier);
}

function updateGovUI() {
  // Update counts
  const pendingCount = governance.proposals.length;
  const stagedCount = governance.staged.length;
  const navBadge = document.getElementById('navApprovalCount');
  if (navBadge) {
    navBadge.textContent = pendingCount + stagedCount;
    navBadge.style.display = (pendingCount + stagedCount > 0) ? 'flex' : 'none';
  }
  const pc = document.getElementById('govPendingCount');
  if (pc) pc.textContent = pendingCount;
  const sc = document.getElementById('govStagedCount');
  if (sc) sc.textContent = stagedCount;
  // Render pending list
  const pendingEl = document.getElementById('govPendingList');
  if (pendingEl) {
    if (governance.proposals.length === 0) {
      pendingEl.innerHTML = '<p class="t-body-sm" style="color:var(--t-fg-tertiary);padding:var(--t-space-4) 0;text-align:center;">No pending proposals. Run an agent review from the Component Pipeline to generate proposals.</p>';
    } else {
      pendingEl.innerHTML = governance.proposals.map(renderProposalCard).join('');
    }
  }
  // Render staged list
  const stagedEl = document.getElementById('govStagedList');
  if (stagedEl) {
    if (governance.staged.length === 0) {
      stagedEl.innerHTML = '<p class="t-body-sm" style="color:var(--t-fg-tertiary);padding:var(--t-space-4) 0;text-align:center;">No staged changes. Approve proposals from Pending tab.</p>';
    } else {
      stagedEl.innerHTML = governance.staged.map(p => renderProposalCard(p, true)).join('');
    }
  }
  // Push bar
  const pushBar = document.getElementById('govPushBar');
  if (pushBar) {
    pushBar.style.display = stagedCount > 0 ? 'flex' : 'none';
    const pushCount = document.getElementById('govPushCount');
    if (pushCount) pushCount.textContent = stagedCount;
  }
  // Audit log
  renderAuditLog();
}

function renderProposalCard(p, isStaged) {
  const agent = AGENT_META[p.proposedBy];
  const compliance = checkCompliance(p);
  // Build diff display
  let diffHtml = '';
  if (p.type === 'token') {
    diffHtml = p.changes.map(c => `<span class="diff-old">- ${c.token}: ${c.oldValue}</span>\n<span class="diff-new">+ ${c.token}: ${c.newValue}</span>`).join('\n');
  } else if (p.type === 'lifecycle') {
    const c = p.changes[0];
    diffHtml = c ? `<span class="diff-old">- ${c.component}: ${c.from}</span>\n<span class="diff-new">+ ${c.component}: ${c.to}</span>` : '';
  } else if (p.type === 'spec') {
    diffHtml = p.changes.map(c => `<span class="diff-new">+ ${c.field}: ${c.description || c.newValue}</span>`).join('\n');
  }
  // Approvals chips
  const approvalChips = p.approvalsNeeded.map(a => {
    const approved = p.approvalsReceived[a];
    const cls = approved ? 'approval-chip--yes' : (p.vetoedBy === a ? 'approval-chip--no' : 'approval-chip--pending');
    const icon = approved ? '‚úì' : (p.vetoedBy === a ? '‚úó' : '‚Ä¶');
    return `<span class="approval-chip ${cls}">${icon} ${AGENT_META[a].short}</span>`;
  }).join('');

  const vetoHtml = p.vetoedBy ? `<div class="proposal-card__veto"><b>‚ö† ${AGENT_META[p.vetoedBy].title} Veto:</b> ${p.vetoReason}</div>` : '';
  const cardClass = p.vetoedBy ? 'proposal-card proposal-card--vetoed' : (isStaged ? 'proposal-card proposal-card--staged' : 'proposal-card');

  return `<div class="${cardClass}">
    <div class="proposal-card__header">
      <div class="proposal-card__agent">
        <div class="proposal-card__avatar" style="background:${agent.color};">${p.proposedBy.toUpperCase()}</div>
        <div>
          <div class="t-body-sm" style="font-weight:600;">${p.id} ‚Äî ${p.type}</div>
          <div class="t-caption" style="color:var(--t-fg-tertiary);">${agent.title} ¬∑ ${p.zoneRules.label || p.targetZone}</div>
        </div>
      </div>
      <span class="t-badge t-badge--${p.status === 'pending' ? 'warning' : p.status === 'staged' ? 'brand' : 'neutral'}" style="font-size:9px;">${p.status}</span>
    </div>
    <div class="t-body-sm" style="color:var(--t-fg-secondary);margin-bottom:var(--t-space-1);">${p.rationale}</div>
    ${p.citations.length ? '<div class="t-caption" style="color:var(--t-fg-tertiary);font-style:italic;margin-bottom:var(--t-space-1);">Cites: ' + p.citations.join(', ') + '</div>' : ''}
    <div class="proposal-card__diff"><pre style="margin:0;white-space:pre-wrap;">${diffHtml}</pre></div>
    <div class="proposal-card__approvals">${approvalChips}</div>
    ${vetoHtml}
    ${!compliance.ok && !isStaged ? '<div class="t-caption" style="color:var(--t-raw-amber-600);margin-bottom:4px;">‚ö† ' + compliance.reason + '</div>' : ''}
    ${!isStaged ? `<div class="proposal-card__actions">
      <button class="t-btn t-btn--primary t-btn--sm" style="font-size:11px;" onclick="approveProposal('${p.id}')">Approve</button>
      <button class="t-btn t-btn--secondary t-btn--sm" style="font-size:11px;" onclick="rejectProposal('${p.id}')">${p.zoneRules.allowReject === false ? 'Seed Vault' : 'Reject'}</button>
      ${p.type === 'token' ? `<button class="t-btn t-btn--ghost t-btn--sm" style="font-size:11px;" onclick="previewProposal('${p.id}')">Preview</button>` : ''}
    </div>` : ''}
  </div>`;
}

function renderAuditLog() {
  const el = document.getElementById('govAuditLog');
  if (!el) return;
  if (governance.auditLog.length === 0) {
    el.innerHTML = '<p class="t-body-sm" style="color:var(--t-fg-tertiary);padding:var(--t-space-4) 0;text-align:center;">Audit log is empty.</p>';
    return;
  }
  el.innerHTML = governance.auditLog.slice().reverse().slice(0, 50).map(e => {
    const time = new Date(e.timestamp).toLocaleTimeString();
    const actor = e.actor === 'gardener' ? 'üßë‚Äçüåæ Gardener' : (AGENT_META[e.actor] ? AGENT_META[e.actor].short : e.actor);
    const actionLabel = e.action.replace(/_/g, ' ');
    return `<div class="audit-entry"><span class="audit-entry__time">${time}</span> <span class="audit-entry__actor">${actor}</span> ‚Äî <b>${actionLabel}</b> [${e.proposalId}]${e.detail ? '<br><span style="color:var(--t-fg-tertiary);">' + e.detail + '</span>' : ''}</div>`;
  }).join('');
}

// ============================================================
// UNDO / REDO SYSTEM
// ============================================================
const undoStack = [];
const redoStack = [];
const MAX_UNDO = 80;

function snapshotState() {
  return {
    tokenOverrides: { ...state.tokenOverrides },
    btn: { ...state.btn },
    inp: { ...state.inp },
    bdg: { ...state.bdg },
    typeBase: state.typeBase,
    typeRatio: state.typeRatio,
    spaceBase: state.spaceBase,
    vfWeight: { ...state.vfWeight },
    vfSlant: state.vfSlant,
    vfOpsz: state.vfOpsz,
    // Capture all inline style overrides on :root
    cssOverrides: document.documentElement.style.cssText
  };
}

function restoreSnapshot(snap) {
  // Restore state fields
  Object.assign(state.btn, snap.btn);
  Object.assign(state.inp, snap.inp);
  Object.assign(state.bdg, snap.bdg);
  state.typeBase = snap.typeBase;
  state.typeRatio = snap.typeRatio;
  state.spaceBase = snap.spaceBase;
  Object.assign(state.vfWeight, snap.vfWeight);
  state.vfSlant = snap.vfSlant;
  state.vfOpsz = snap.vfOpsz;
  state.tokenOverrides = { ...snap.tokenOverrides };
  // Restore all CSS custom property overrides
  document.documentElement.style.cssText = snap.cssOverrides;
  // Re-apply type scale and spacing from state (in case they changed)
  recomputeTypeScale();
  recomputeSpacing();
  // Refresh UI
  updatePanel();
  updateDynamicContent();
}

// Debounce helper ‚Äî avoid flooding undo stack on slider drags
let _undoDebounce = null;
let _pendingSnapshot = null;

function pushUndo() {
  // On first call in a burst, capture the BEFORE state
  if (!_pendingSnapshot) {
    _pendingSnapshot = snapshotState();
  }
  clearTimeout(_undoDebounce);
  _undoDebounce = setTimeout(() => {
    if (_pendingSnapshot) {
      undoStack.push(_pendingSnapshot);
      if (undoStack.length > MAX_UNDO) undoStack.shift();
      redoStack.length = 0; // clear redo on new action
      _pendingSnapshot = null;
      updateUndoUI();
    }
  }, 400);
}

function undo() {
  if (undoStack.length === 0) return;
  // Save current state to redo stack
  redoStack.push(snapshotState());
  const snap = undoStack.pop();
  restoreSnapshot(snap);
  updateUndoUI();
  showToast('info', 'Undone', `Reverted to previous state. ${undoStack.length} more undo steps available.`);
}

function redo() {
  if (redoStack.length === 0) return;
  // Save current state to undo stack
  undoStack.push(snapshotState());
  const snap = redoStack.pop();
  restoreSnapshot(snap);
  updateUndoUI();
  showToast('info', 'Redone', `Restored change. ${redoStack.length} more redo steps available.`);
}

function updateUndoUI() {
  const ub = document.getElementById('undoBtn');
  const rb = document.getElementById('redoBtn');
  const uc = document.getElementById('undoCount');
  if (ub) ub.disabled = undoStack.length === 0;
  if (rb) rb.disabled = redoStack.length === 0;
  if (uc) uc.textContent = undoStack.length > 0 ? undoStack.length + ' undo' : '';
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
    e.preventDefault();
    undo();
  }
  if ((e.ctrlKey || e.metaKey) && (e.key === 'Z' || (e.key === 'z' && e.shiftKey))) {
    e.preventDefault();
    redo();
  }
  if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
    e.preventDefault();
    redo();
  }
});

// setTokenDirect ‚Äî sets token without pushing undo (undo is handled by caller)
function setTokenDirect(prop, value) {
  document.documentElement.style.setProperty(prop, value);
  state.tokenOverrides[prop] = value;
}

// ============================================================
// NAVIGATION
// ============================================================
function nav(el) {
  document.querySelectorAll('.story').forEach(s => s.classList.remove('story--active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('nav-item--active'));
  const target = el.getAttribute('data-target');
  document.getElementById('story-' + target).classList.add('story--active');
  el.classList.add('nav-item--active');
  state.currentStory = target;
  updatePanel();
  updateDynamicContent();
}

// ============================================================
// THEME & DENSITY
// ============================================================
document.getElementById('themeToggle').addEventListener('change', function() {
  document.documentElement.setAttribute('data-theme', this.checked ? 'dark' : 'light');
});
document.getElementById('densitySelect').addEventListener('change', function() {
  document.documentElement.setAttribute('data-density', this.value);
});
document.getElementById('togglePanel').addEventListener('click', function() {
  document.getElementById('shell').classList.toggle('shell--panel-closed');
});

// ============================================================
// RIGHT PANEL ‚Äî Context-aware editor
// ============================================================
function updatePanel() {
  const pc = document.getElementById('panelContent');
  const s = state.currentStory;
  let html = '';

  if (s === 'button') {
    html = panelButton();
  } else if (s === 'input') {
    html = panelInput();
  } else if (s === 'badge') {
    html = panelBadge();
  } else if (s === 'colors') {
    html = panelColors();
  } else if (s === 'typography') {
    html = panelTypography();
  } else if (s === 'spacing') {
    html = panelSpacing();
  } else if (s === 'theme') {
    html = panelTheme();
  } else if (s === 'wiki') {
    html = `<div class="panel-section"><div class="panel-section__title">Knowledge Base</div><p style="font-size:11px;color:var(--t-fg-secondary);line-height:1.5;">The glossary is also the ruleset. Every definition includes the governance rule it enforces.<br><br>Hover any <span data-tip="terrarium-model" style="cursor:help;border-bottom:1px dotted var(--t-raw-blue-400);">dotted term</span> anywhere in the system to see its tooltip.<br><br><b>${Object.keys(WIKI).length} terms</b> across ${[...new Set(Object.values(WIKI).map(e=>e.category))].length} categories.</p></div>`;
  } else if (s === 'seedvault') {
    html = `<div class="panel-section"><div class="panel-section__title">Seed Vault</div><p style="font-size:11px;color:var(--t-fg-secondary);line-height:1.5;">Preserved ideas with full context. Revivable items have a green left border and can be submitted for revival to the Approval Queue.<br><br><b>${seedVault.length} items</b> in vault.<br><b>${seedVault.filter(x=>x.revivable).length} revivable</b>.</p></div>`;
  } else if (s === 'agents') {
    const total = pipeline.nursery.length + pipeline.workshop.length + pipeline.canopy.length;
    html = `<div class="panel-section"><div class="panel-section__title">Pipeline Overview</div>
      <div class="ctrl"><div class="ctrl__label">Nursery <span class="ctrl__value">${pipeline.nursery.length}</span></div></div>
      <div class="ctrl"><div class="ctrl__label">Workshop <span class="ctrl__value">${pipeline.workshop.length}</span></div></div>
      <div class="ctrl"><div class="ctrl__label">Canopy <span class="ctrl__value">${pipeline.canopy.length}</span></div></div>
      <div class="ctrl"><div class="ctrl__label">Graduated <span class="ctrl__value">${pipeline.promoted.length}</span></div></div>
      <div class="ctrl"><div class="ctrl__label">Seed Vault <span class="ctrl__value">${seedVault.length}</span></div></div>
      <div class="ctrl"><div class="ctrl__label">Total Active <span class="ctrl__value">${total}</span></div></div>
    </div>
    <div class="panel-section"><div class="panel-section__title">Workflow</div><p style="font-size:11px;color:var(--t-fg-secondary);line-height:1.5;">
      <b>1.</b> Submit a component to the Nursery<br>
      <b>2.</b> Run Agent Review to generate proposals<br>
      <b>3.</b> Approve proposals in the Approval Queue<br>
      <b>4.</b> Promote through zones (Nursery ‚Üí Workshop ‚Üí Canopy)<br>
      <b>5.</b> Graduate to Stable ‚Äî component appears in the sidebar<br><br>
      Zone rules enforced at each gate. AG absolute veto active in Canopy.
    </p></div>`;
  } else if (s === 'approvals') {
    html = `<div class="panel-section"><div class="panel-section__title">Governance Controls</div><p style="font-size:11px;color:var(--t-fg-secondary);line-height:1.5;">This is the HITL approval gate. Proposals from agent reviews queue here for your sign-off.<br><br><b>Approve</b> to stage changes.<br><b>Push Live</b> to apply staged changes to the live system.<br><b>Ctrl+Z</b> reverts an entire push batch.<br><br>Zone rules are enforced ‚Äî Nursery allows no rejection, Canopy requires unanimity, AG has absolute veto.</p></div>
    <div class="panel-section"><div class="panel-section__title">System Health</div>
      <div class="ctrl"><div class="ctrl__label">Pending <span class="ctrl__value">${governance.proposals.length}</span></div></div>
      <div class="ctrl"><div class="ctrl__label">Staged <span class="ctrl__value">${governance.staged.length}</span></div></div>
      <div class="ctrl"><div class="ctrl__label">Pushed <span class="ctrl__value">${governance.pushed.length}</span></div></div>
      <div class="ctrl"><div class="ctrl__label">Audit Events <span class="ctrl__value">${governance.auditLog.length}</span></div></div>
    </div>`;
  } else {
    html = `<div class="panel-section"><div class="panel-section__title">Context Panel</div><p style="font-size:11px;color:var(--t-fg-secondary);line-height:1.5;">Select a component or foundation to see its editable properties here.<br><br>All text with a subtle highlight is directly editable ‚Äî click and type.<br><br><b>Undo/Redo:</b> Ctrl+Z / Ctrl+Shift+Z, or use the arrow buttons in the header. Up to 80 steps.</p></div>`;
  }
  pc.innerHTML = html;
  bindPanelEvents();
}

function panelButton() {
  return `
    <div class="panel-section"><div class="panel-section__title">Button Properties</div>
      <div class="ctrl"><div class="ctrl__label">Variant</div><div class="chip-row">${['primary','secondary','ghost','danger'].map(v=>`<button class="chip ${state.btn.variant===v?'chip--active':''}" onclick="pushUndo();state.btn.variant='${v}';updatePanel();updateDynamicContent();">${v}</button>`).join('')}</div></div>
      <div class="ctrl"><div class="ctrl__label">Size</div><div class="chip-row">${['sm','default','lg'].map(v=>`<button class="chip ${state.btn.size===v?'chip--active':''}" onclick="pushUndo();state.btn.size='${v}';updatePanel();updateDynamicContent();">${v}</button>`).join('')}</div></div>
      <div class="ctrl"><div class="ctrl__label">Label</div><input type="text" value="${state.btn.label}" oninput="pushUndo();state.btn.label=this.value;updateDynamicContent();"></div>
      <div class="ctrl"><div class="ctrl__label"><span>Disabled</span></div><label class="t-toggle" style="transform:scale(0.75);"><input type="checkbox" class="t-toggle__input" ${state.btn.disabled?'checked':''} onchange="pushUndo();state.btn.disabled=this.checked;updateDynamicContent();"><span class="t-toggle__track"><span class="t-toggle__thumb"></span></span></label></div>
      <div class="ctrl"><div class="ctrl__label"><span>Loading</span></div><label class="t-toggle" style="transform:scale(0.75);"><input type="checkbox" class="t-toggle__input" ${state.btn.loading?'checked':''} onchange="pushUndo();state.btn.loading=this.checked;updateDynamicContent();"><span class="t-toggle__track"><span class="t-toggle__thumb"></span></span></label></div>
      <div class="ctrl"><div class="ctrl__label"><span>With Icon</span></div><label class="t-toggle" style="transform:scale(0.75);"><input type="checkbox" class="t-toggle__input" ${state.btn.icon?'checked':''} onchange="pushUndo();state.btn.icon=this.checked;updateDynamicContent();"><span class="t-toggle__track"><span class="t-toggle__thumb"></span></span></label></div>
    </div>
    <div class="panel-section"><div class="panel-section__title">Token Overrides</div>
      <div class="ctrl"><div class="ctrl__label">Interactive Default <span class="ctrl__value">${getComputed('--t-interactive-default')}</span></div><div class="ctrl__row"><input type="color" value="${rgbToHex(getComputed('--t-interactive-default'))}" onchange="setToken('--t-interactive-default',this.value);"><input type="text" value="${getComputed('--t-interactive-default')}" onchange="setToken('--t-interactive-default',this.value);"></div></div>
      <div class="ctrl"><div class="ctrl__label">Interactive Hover <span class="ctrl__value">${getComputed('--t-interactive-hover')}</span></div><div class="ctrl__row"><input type="color" value="${rgbToHex(getComputed('--t-interactive-hover'))}" onchange="setToken('--t-interactive-hover',this.value);"><input type="text" value="${getComputed('--t-interactive-hover')}" onchange="setToken('--t-interactive-hover',this.value);"></div></div>
      <div class="ctrl"><div class="ctrl__label">Border Radius</div><input type="range" min="0" max="24" value="${parseInt(getComputed('--t-radius-md'))}" oninput="setToken('--t-radius-md',this.value+'px');document.querySelector('.ctrl__value.radius-val').textContent=this.value+'px';"><span class="ctrl__value radius-val">${getComputed('--t-radius-md')}</span></div>
    </div>`;
}

function panelInput() {
  return `
    <div class="panel-section"><div class="panel-section__title">Input Properties</div>
      <div class="ctrl"><div class="ctrl__label">Label Text</div><input type="text" value="${state.inp.label}" oninput="pushUndo();state.inp.label=this.value;updateDynamicContent();"></div>
      <div class="ctrl"><div class="ctrl__label">Placeholder</div><input type="text" value="${state.inp.placeholder}" oninput="pushUndo();state.inp.placeholder=this.value;updateDynamicContent();"></div>
      <div class="ctrl"><div class="ctrl__label">Helper Text</div><input type="text" value="${state.inp.helper}" oninput="pushUndo();state.inp.helper=this.value;updateDynamicContent();"></div>
      <div class="ctrl"><div class="ctrl__label">State</div><div class="chip-row">${['default','error','success'].map(v=>`<button class="chip ${state.inp.state===v?'chip--active':''}" onclick="pushUndo();state.inp.state='${v}';updatePanel();updateDynamicContent();">${v}</button>`).join('')}</div></div>
      <div class="ctrl"><div class="ctrl__label"><span>Required</span></div><label class="t-toggle" style="transform:scale(0.75);"><input type="checkbox" class="t-toggle__input" ${state.inp.required?'checked':''} onchange="pushUndo();state.inp.required=this.checked;updateDynamicContent();"><span class="t-toggle__track"><span class="t-toggle__thumb"></span></span></label></div>
      <div class="ctrl"><div class="ctrl__label"><span>Disabled</span></div><label class="t-toggle" style="transform:scale(0.75);"><input type="checkbox" class="t-toggle__input" ${state.inp.disabled?'checked':''} onchange="pushUndo();state.inp.disabled=this.checked;updateDynamicContent();"><span class="t-toggle__track"><span class="t-toggle__thumb"></span></span></label></div>
    </div>`;
}

function panelBadge() {
  return `
    <div class="panel-section"><div class="panel-section__title">Badge Properties</div>
      <div class="ctrl"><div class="ctrl__label">Text</div><input type="text" value="${state.bdg.text}" oninput="pushUndo();state.bdg.text=this.value;updateDynamicContent();"></div>
      <div class="ctrl"><div class="ctrl__label">Variant</div><div class="chip-row">${['neutral','brand','success','warning','danger','draft','candidate','stable','deprecated'].map(v=>`<button class="chip ${state.bdg.variant===v?'chip--active':''}" onclick="pushUndo();state.bdg.variant='${v}';updatePanel();updateDynamicContent();">${v}</button>`).join('')}</div></div>
    </div>`;
}

function panelColors() {
  return `
    <div class="panel-section"><div class="panel-section__title">Color Tokens</div>
      <p style="font-size:11px;color:var(--t-fg-secondary);line-height:1.4;margin-bottom:8px;">Click any swatch in the main canvas to edit its color. Changes propagate through the entire system live.</p>
      <div class="ctrl"><div class="ctrl__label">Brand Color</div><div class="ctrl__row"><input type="color" value="${rgbToHex(getComputed('--t-raw-blue-600'))}" onchange="setBrandColor(this.value);"><input type="text" value="${getComputed('--t-raw-blue-600')}" style="flex:1;" onchange="setBrandColor(this.value);"></div></div>
      <div class="ctrl"><div class="ctrl__label">Danger Color</div><div class="ctrl__row"><input type="color" value="${rgbToHex(getComputed('--t-raw-red-600'))}" onchange="setToken('--t-raw-red-600',this.value);"><input type="text" value="${getComputed('--t-raw-red-600')}" style="flex:1;"></div></div>
      <div class="ctrl"><div class="ctrl__label">Success Color</div><div class="ctrl__row"><input type="color" value="${rgbToHex(getComputed('--t-raw-green-600'))}" onchange="setToken('--t-raw-green-600',this.value);"><input type="text" value="${getComputed('--t-raw-green-600')}" style="flex:1;"></div></div>
    </div>`;
}

function panelTypography() {
  return `
    <div class="panel-section"><div class="panel-section__title">Typography Scale</div>
      <div class="ctrl"><div class="ctrl__label">Base Size <span class="ctrl__value">${state.typeBase}px</span></div><input type="range" min="12" max="24" value="${state.typeBase}" oninput="pushUndo();state.typeBase=+this.value;recomputeTypeScale();updateDynamicContent();updatePanel();"></div>
      <div class="ctrl"><div class="ctrl__label">Scale Ratio <span class="ctrl__value">${state.typeRatio.toFixed(2)}</span></div><input type="range" min="1.1" max="1.5" step="0.01" value="${state.typeRatio}" oninput="pushUndo();state.typeRatio=+this.value;recomputeTypeScale();updateDynamicContent();updatePanel();"></div>
      <div class="ctrl"><div class="ctrl__label">Sans-Serif Font</div><select onchange="pushUndo();setTokenDirect('--t-font-sans',this.value);updateDynamicContent();" style="font-size:11px;">
        <optgroup label="Variable Fonts (weight axis)">
          <option value="'Inter Variable', 'Inter', sans-serif" ${getComputed('--t-font-sans').includes('Inter')?'selected':''}>Inter Variable (Default)</option>
          <option value="'DM Sans', sans-serif" ${getComputed('--t-font-sans').includes('DM Sans')?'selected':''}>DM Sans</option>
          <option value="'Space Grotesk', sans-serif" ${getComputed('--t-font-sans').includes('Space Grotesk')?'selected':''}>Space Grotesk</option>
          <option value="'Manrope', sans-serif" ${getComputed('--t-font-sans').includes('Manrope')?'selected':''}>Manrope</option>
          <option value="'Plus Jakarta Sans', sans-serif" ${getComputed('--t-font-sans').includes('Jakarta')?'selected':''}>Plus Jakarta Sans</option>
          <option value="'Outfit', sans-serif" ${getComputed('--t-font-sans').includes('Outfit')?'selected':''}>Outfit</option>
          <option value="'Sora', sans-serif" ${getComputed('--t-font-sans').includes('Sora')?'selected':''}>Sora</option>
          <option value="'Rubik', sans-serif" ${getComputed('--t-font-sans').includes('Rubik')?'selected':''}>Rubik</option>
          <option value="'Nunito', sans-serif" ${getComputed('--t-font-sans').includes('Nunito')?'selected':''}>Nunito</option>
          <option value="'Work Sans', sans-serif" ${getComputed('--t-font-sans').includes('Work Sans')?'selected':''}>Work Sans</option>
          <option value="'Raleway', sans-serif" ${getComputed('--t-font-sans').includes('Raleway')?'selected':''}>Raleway</option>
          <option value="'IBM Plex Sans', sans-serif" ${getComputed('--t-font-sans').includes('IBM Plex Sans')?'selected':''}>IBM Plex Sans</option>
        </optgroup>
        <optgroup label="Classic Fonts">
          <option value="'Open Sans', sans-serif" ${getComputed('--t-font-sans').includes('Open Sans')?'selected':''}>Open Sans</option>
          <option value="'Montserrat', sans-serif" ${getComputed('--t-font-sans').includes('Montserrat')?'selected':''}>Montserrat</option>
          <option value="'Poppins', sans-serif" ${getComputed('--t-font-sans').includes('Poppins')?'selected':''}>Poppins</option>
          <option value="'Lato', sans-serif" ${getComputed('--t-font-sans').includes('Lato')?'selected':''}>Lato</option>
        </optgroup>
        <optgroup label="System">
          <option value="system-ui, -apple-system, sans-serif" ${getComputed('--t-font-sans').startsWith('system')?'selected':''}>System UI</option>
          <option value="'Georgia', serif" ${getComputed('--t-font-sans').includes('Georgia')?'selected':''}>Georgia (Serif)</option>
        </optgroup>
      </select></div>
      <div class="ctrl"><div class="ctrl__label">Monospace Font</div><select onchange="pushUndo();setTokenDirect('--t-font-mono',this.value);updateDynamicContent();" style="font-size:11px;">
        <option value="'JetBrains Mono', monospace" ${getComputed('--t-font-mono').includes('JetBrains')?'selected':''}>JetBrains Mono (Default)</option>
        <option value="'Fira Code', monospace" ${getComputed('--t-font-mono').includes('Fira Code')?'selected':''}>Fira Code</option>
        <option value="'Source Code Pro', monospace" ${getComputed('--t-font-mono').includes('Source Code')?'selected':''}>Source Code Pro</option>
        <option value="'IBM Plex Mono', monospace" ${getComputed('--t-font-mono').includes('IBM Plex Mono')?'selected':''}>IBM Plex Mono</option>
        <option value="monospace">System Monospace</option>
      </select></div>
    </div>
    <div class="panel-section"><div class="panel-section__title">Variable Font Axes</div>
      <p style="font-size:10px;color:var(--t-fg-tertiary);margin-bottom:8px;">Variable fonts support continuous weight (100‚Äì900), optical sizing, and slant. Axis support varies per font.</p>
      <div class="ctrl"><div class="ctrl__label">Weight: Regular <span class="ctrl__value">${state.vfWeight.regular}</span></div><input type="range" min="100" max="900" step="1" value="${state.vfWeight.regular}" oninput="pushUndo();state.vfWeight.regular=+this.value;setToken('--t-weight-regular',this.value);updatePanel();"></div>
      <div class="ctrl"><div class="ctrl__label">Weight: Medium <span class="ctrl__value">${state.vfWeight.medium}</span></div><input type="range" min="100" max="900" step="1" value="${state.vfWeight.medium}" oninput="pushUndo();state.vfWeight.medium=+this.value;setToken('--t-weight-medium',this.value);updatePanel();"></div>
      <div class="ctrl"><div class="ctrl__label">Weight: Semibold <span class="ctrl__value">${state.vfWeight.semibold}</span></div><input type="range" min="100" max="900" step="1" value="${state.vfWeight.semibold}" oninput="pushUndo();state.vfWeight.semibold=+this.value;setToken('--t-weight-semibold',this.value);updatePanel();"></div>
      <div class="ctrl"><div class="ctrl__label">Weight: Bold <span class="ctrl__value">${state.vfWeight.bold}</span></div><input type="range" min="100" max="900" step="1" value="${state.vfWeight.bold}" oninput="pushUndo();state.vfWeight.bold=+this.value;setToken('--t-weight-bold',this.value);updatePanel();"></div>
      <div class="ctrl"><div class="ctrl__label">Slant <span class="ctrl__value">${state.vfSlant}deg</span></div><input type="range" min="-10" max="0" step="0.5" value="${state.vfSlant}" oninput="pushUndo();state.vfSlant=+this.value;setToken('--t-font-slnt',this.value);updatePanel();"></div>
      <div class="ctrl"><div class="ctrl__label">Optical Sizing</div><div class="chip-row">
        <button class="chip ${state.vfOpsz==='auto'?'chip--active':''}" onclick="pushUndo();state.vfOpsz='auto';setToken('--t-font-opsz','auto');updatePanel();">Auto</button>
        <button class="chip ${state.vfOpsz==='none'?'chip--active':''}" onclick="pushUndo();state.vfOpsz='none';setToken('--t-font-opsz','none');updatePanel();">Off</button>
      </div></div>
    </div>`;
}

function panelSpacing() {
  return `
    <div class="panel-section"><div class="panel-section__title">Spacing System</div>
      <div class="ctrl"><div class="ctrl__label">Base Unit <span class="ctrl__value">${state.spaceBase}px</span></div><input type="range" min="2" max="8" value="${state.spaceBase}" oninput="pushUndo();state.spaceBase=+this.value;recomputeSpacing();updateDynamicContent();updatePanel();"></div>
    </div>`;
}

function panelTheme() {
  return `
    <div class="panel-section"><div class="panel-section__title">Quick Themes</div>
      <div class="t-stack t-gap-1">
        <button class="chip" style="text-align:left;width:100%;border-radius:var(--t-radius-sm);padding:6px 10px;" onclick="applyPresetTheme('ocean')">üåä Ocean</button>
        <button class="chip" style="text-align:left;width:100%;border-radius:var(--t-radius-sm);padding:6px 10px;" onclick="applyPresetTheme('forest')">üå≤ Forest</button>
        <button class="chip" style="text-align:left;width:100%;border-radius:var(--t-radius-sm);padding:6px 10px;" onclick="applyPresetTheme('sunset')">üåÖ Sunset</button>
        <button class="chip" style="text-align:left;width:100%;border-radius:var(--t-radius-sm);padding:6px 10px;" onclick="applyPresetTheme('midnight')">üåô Midnight</button>
      </div>
    </div>
    <div class="panel-section"><div class="panel-section__title">Custom Overrides</div>
      <div class="ctrl"><div class="ctrl__label">Brand Primary</div><div class="ctrl__row"><input type="color" value="${rgbToHex(getComputed('--t-interactive-default'))}" onchange="setBrandColor(this.value);"></div></div>
      <div class="ctrl"><div class="ctrl__label">Background</div><div class="ctrl__row"><input type="color" value="${rgbToHex(getComputed('--t-bg-primary'))}" onchange="setToken('--t-bg-primary',this.value);"></div></div>
      <div class="ctrl"><div class="ctrl__label">Foreground</div><div class="ctrl__row"><input type="color" value="${rgbToHex(getComputed('--t-fg-primary'))}" onchange="setToken('--t-fg-primary',this.value);"></div></div>
      <div class="ctrl"><div class="ctrl__label">Surface 1</div><div class="ctrl__row"><input type="color" value="${rgbToHex(getComputed('--t-surface-1'))}" onchange="setToken('--t-surface-1',this.value);"></div></div>
      <div class="ctrl"><div class="ctrl__label">Border</div><div class="ctrl__row"><input type="color" value="${rgbToHex(getComputed('--t-border-default'))}" onchange="setToken('--t-border-default',this.value);"></div></div>
    </div>`;
}

function bindPanelEvents() { /* events are inline for simplicity */ }

// ============================================================
// DYNAMIC CONTENT UPDATES
// ============================================================
function updateDynamicContent() {
  const s = state.currentStory;
  if (s === 'button') renderButton();
  if (s === 'input') renderInput();
  if (s === 'badge') renderBadge();
  if (s === 'colors') renderColors();
  if (s === 'typography') renderTypeScale();
  if (s === 'spacing') renderSpacing();
  if (s === 'elevation') renderElevation();
  if (s === 'export') renderExport();
  if (s === 'theme') renderThemeBuilder();
  if (s === 'wiki') renderWiki();
  if (s === 'seedvault') renderSeedVault();
  if (s === 'agents') renderPipeline();
}

// ---- BUTTON ----
function renderButton() {
  const b = state.btn;
  const sizeClass = b.size !== 'default' ? ` t-btn--${b.size}` : '';
  const icon = b.icon ? '<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg> ' : '';
  const el = document.getElementById('buttonPreview');
  if (el) el.innerHTML = `<button class="t-btn t-btn--${b.variant}${sizeClass}${b.loading?' t-btn--loading':''}" ${b.disabled?'disabled':''}>${icon}${b.label}</button>`;
  const code = document.getElementById('buttonCode');
  if (code) code.textContent = `<button class="t-btn t-btn--${b.variant}${sizeClass}${b.loading?' t-btn--loading':''}"${b.disabled?' disabled':''}>${b.icon?'<svg>...</svg> ':''}${b.label}</button>`;
}

// ---- INPUT ----
function renderInput() {
  const i = state.inp;
  const stateClass = i.state !== 'default' ? ` t-input--${i.state}` : '';
  const labelClass = i.required ? ' t-label--required' : '';
  const helperClass = i.state === 'error' ? ' t-helper--error' : i.state === 'success' ? ' t-helper--success' : '';
  const el = document.getElementById('inputPreview');
  if (el) el.innerHTML = `<div class="t-input-group"><label class="t-label${labelClass}">${i.label}</label><input class="t-input${stateClass}" placeholder="${i.placeholder}" ${i.disabled?'disabled':''}><span class="t-helper${helperClass}">${i.helper}</span></div>`;
}

// ---- BADGE ----
function renderBadge() {
  const el = document.getElementById('badgePreview');
  if (el) el.innerHTML = `<span class="t-badge t-badge--${state.bdg.variant}">${state.bdg.text}</span>`;
}

// ---- COLORS ----
function renderColors() {
  const semantics = [
    ['bg-primary','--t-bg-primary'],['bg-secondary','--t-bg-secondary'],['bg-tertiary','--t-bg-tertiary'],['bg-inverse','--t-bg-inverse'],
    ['bg-brand','--t-bg-brand'],['bg-danger','--t-bg-danger'],['bg-success','--t-bg-success'],['bg-warning','--t-bg-warning']
  ];
  const el = document.getElementById('semanticSwatches');
  if (el) el.innerHTML = semantics.map(([name,token]) => `<div class="swatch"><div class="swatch__color" style="background:var(${token});${name==='bg-primary'?'border-bottom:1px solid var(--t-border-default);':''}"><input type="color" value="${rgbToHex(getComputed(token))}" onchange="setToken('${token}',this.value);renderColors();"></div><div class="swatch__info"><div class="swatch__name">${name}</div><div class="swatch__value">${token}</div></div></div>`).join('');

  const tonal = document.getElementById('tonalSurfaces');
  if (tonal) tonal.innerHTML = [0,1,2,3,4].map(i => `<div style="width:100px;text-align:center;"><div style="height:48px;background:var(--t-surface-${i});border:1px solid var(--t-border-default);border-radius:var(--t-radius-md);margin-bottom:4px;cursor:pointer;" onclick="this.querySelector('input').click();"><input type="color" value="${rgbToHex(getComputed('--t-surface-'+i))}" style="opacity:0;width:100%;height:100%;cursor:pointer;" onchange="setToken('--t-surface-${i}',this.value);renderColors();"></div><span class="t-caption">Surface ${i}</span></div>`).join('');

  // Palette chips
  const palettes = ['blue','red','green','amber','neutral'];
  const chips = document.getElementById('paletteChips');
  if (chips) chips.innerHTML = palettes.map(p => `<button class="chip ${state.activePalette===p?'chip--active':''}" onclick="state.activePalette='${p}';renderColors();">${p}</button>`).join('');

  // Primitive swatches
  const steps = state.activePalette === 'neutral' ? ['0','50','100','200','300','400','500','600','700','800','900','1000'] : ['50','100','200','300','400','500','600','700','800','900'];
  const prim = document.getElementById('primitiveSwatches');
  if (prim) prim.innerHTML = steps.map(s => {
    const token = `--t-raw-${state.activePalette}-${s}`;
    return `<div class="swatch"><div class="swatch__color" style="background:var(${token});"><input type="color" value="${rgbToHex(getComputed(token))}" onchange="setToken('${token}',this.value);renderColors();"></div><div class="swatch__info"><div class="swatch__name">${state.activePalette}-${s}</div><div class="swatch__value">${getComputed(token)}</div></div></div>`;
  }).join('');
}

// ---- TYPOGRAPHY ----
function renderTypeScale() {
  const scales = [
    ['display-lg','t-display-lg','4xl'],['display-md','t-display-md','3xl'],['heading-lg','t-heading-lg','2xl'],
    ['heading-md','t-heading-md','xl'],['heading-sm','t-heading-sm','lg'],['body-lg','t-body-lg','md'],
    ['body-md','t-body-md','base'],['body-sm','t-body-sm','sm'],['caption','t-caption','xs'],['code','t-code','mono sm']
  ];
  const el = document.getElementById('typeScaleCanvas');
  if (el) el.innerHTML = '<div class="canvas__label">Type Scale (editable text)</div>' + scales.map(([name,cls]) => `<div class="type-sample"><div class="type-sample__label">${name} ‚Äî ${getComputed('--t-text-'+name.split('-').pop()) || 'mono'}</div><div class="${cls}" contenteditable="true" spellcheck="false">The quick brown fox jumps over the lazy dog</div></div>`).join('');
}

// ---- SPACING ----
function renderSpacing() {
  const steps = [['1',1],['2',2],['3',3],['4',4],['5',5],['6',6],['8',8],['10',10],['12',12],['16',16],['20',20]];
  const el = document.getElementById('spacingCanvas');
  if (el) el.innerHTML = '<div class="canvas__label">Spacing Scale</div>' + steps.map(([name,mult]) => `<div class="space-bar"><span class="space-bar__label">--t-space-${name} (${mult*state.spaceBase}px)</span><div class="space-bar__visual" style="width:${mult*state.spaceBase}px;"></div></div>`).join('');
  const radii = [['none',0],['sm',4],['md',8],['lg',12],['xl',16],['2xl',24],['full','50%']];
  const re = document.getElementById('radiusCanvas');
  if (re) re.innerHTML = '<div class="canvas__label">Border Radius</div><div class="canvas__row">' + radii.map(([name,val]) => `<div style="text-align:center;"><div style="width:48px;height:48px;background:var(--t-interactive-default);border-radius:var(--t-radius-${name});margin-bottom:4px;"></div><span class="t-caption">${name}</span></div>`).join('') + '</div>';
}

// ---- ELEVATION ----
function renderElevation() {
  const el = document.getElementById('elevationPreview');
  if (el) el.innerHTML = [0,1,2,3,4].map(i => `<div style="width:120px;height:80px;background:var(--t-surface-0);border-radius:var(--t-radius-lg);box-shadow:var(--t-shadow-${i});display:flex;align-items:center;justify-content:center;"><span class="t-caption">Level ${i}</span></div>`).join('');
}

// ---- EXPORT ----
function renderExport() {
  const el = document.getElementById('exportOutput');
  if (!el) return;
  if (state.exportFormat === 'css') {
    const props = [];
    const computed = getComputedStyle(document.documentElement);
    const style = document.documentElement.style;
    // Get all custom properties
    for (let i = 0; i < style.length; i++) {
      const prop = style[i];
      if (prop.startsWith('--t-')) props.push(`  ${prop}: ${style.getPropertyValue(prop)};`);
    }
    // Also include defaults from terrarium.css
    const defaults = ['--t-bg-primary','--t-bg-secondary','--t-fg-primary','--t-interactive-default','--t-radius-md','--t-font-sans'];
    defaults.forEach(d => { if (!props.find(p => p.includes(d))) props.push(`  ${d}: ${computed.getPropertyValue(d).trim()};`); });
    el.textContent = `:root {\n${props.join('\n')}\n}`;
  } else if (state.exportFormat === 'json') {
    const tokens = {};
    const computed = getComputedStyle(document.documentElement);
    ['bg-primary','bg-secondary','bg-tertiary','bg-inverse','bg-brand','fg-primary','fg-secondary','interactive-default','interactive-hover','border-default','border-focus','surface-0','surface-1'].forEach(name => {
      tokens[name] = { "$value": computed.getPropertyValue('--t-'+name).trim(), "$type": "color" };
    });
    el.textContent = JSON.stringify({ "$schema": "https://design-tokens.github.io/community-group/format/", "terrarium": tokens }, null, 2);
  } else {
    el.textContent = `// Terrarium Design Tokens ‚Äî TypeScript\nexport const tokens = {\n  bgPrimary: '${getComputed('--t-bg-primary')}',\n  bgSecondary: '${getComputed('--t-bg-secondary')}',\n  fgPrimary: '${getComputed('--t-fg-primary')}',\n  interactiveDefault: '${getComputed('--t-interactive-default')}',\n  radiusMd: '${getComputed('--t-radius-md')}',\n  fontSans: '${getComputed('--t-font-sans')}',\n} as const;\n\nexport type TokenKey = keyof typeof tokens;`;
  }
}

function setExportFormat(el, fmt) {
  state.exportFormat = fmt;
  document.querySelectorAll('#story-export .chip').forEach(c => c.classList.remove('chip--active'));
  el.classList.add('chip--active');
  renderExport();
}

function copyExport() {
  const text = document.getElementById('exportOutput').textContent;
  navigator.clipboard.writeText(text).then(() => showToast('success','Copied!','Token export copied to clipboard.'));
}

// ---- THEME BUILDER ----
function renderThemeBuilder() {
  const el = document.getElementById('themeBuilder');
  if (el) el.innerHTML = `<div class="theme-preview">
    <div class="theme-preview__card" style="background:var(--t-interactive-default);color:var(--t-fg-inverse);border-radius:var(--t-radius-md);">Brand</div>
    <div class="theme-preview__card" style="background:var(--t-bg-secondary);color:var(--t-fg-primary);border-radius:var(--t-radius-md);border:1px solid var(--t-border-default);">Surface</div>
    <div class="theme-preview__card" style="background:var(--t-bg-success);color:var(--t-fg-success);border-radius:var(--t-radius-md);">Success</div>
    <div class="theme-preview__card" style="background:var(--t-bg-danger);color:var(--t-fg-danger);border-radius:var(--t-radius-md);">Danger</div>
  </div>`;
}

// ============================================================
// TOKEN MANIPULATION
// ============================================================
function setToken(prop, value) {
  pushUndo();
  document.documentElement.style.setProperty(prop, value);
  state.tokenOverrides[prop] = value;
}

function getComputed(prop) {
  return getComputedStyle(document.documentElement).getPropertyValue(prop).trim();
}

function rgbToHex(color) {
  if (!color || color.startsWith('#')) return color || '#000000';
  const match = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
  if (!match) return '#000000';
  return '#' + [match[1],match[2],match[3]].map(x => parseInt(x).toString(16).padStart(2,'0')).join('');
}

function setBrandColor(hex) {
  pushUndo();
  // Generate a simple palette from the brand color ‚Äî use setTokenDirect to avoid multiple undo entries
  setTokenDirect('--t-raw-blue-600', hex);
  setTokenDirect('--t-interactive-default', hex);
  setTokenDirect('--t-bg-brand', hex);
  setTokenDirect('--t-border-brand', hex);
  setTokenDirect('--t-fg-link', hex);
  const darker = adjustBrightness(hex, -15);
  const darkest = adjustBrightness(hex, -30);
  const lighter = adjustBrightness(hex, 40);
  setTokenDirect('--t-interactive-hover', darker);
  setTokenDirect('--t-interactive-active', darkest);
  setTokenDirect('--t-raw-blue-700', darker);
  setTokenDirect('--t-raw-blue-800', darkest);
  setTokenDirect('--t-raw-blue-50', lighter);
  setTokenDirect('--t-bg-info', lighter);
  setTokenDirect('--t-border-focus', adjustBrightness(hex, 20));
}

function adjustBrightness(hex, amount) {
  hex = hex.replace('#','');
  const r = Math.max(0, Math.min(255, parseInt(hex.substr(0,2),16) + amount));
  const g = Math.max(0, Math.min(255, parseInt(hex.substr(2,2),16) + amount));
  const b = Math.max(0, Math.min(255, parseInt(hex.substr(4,2),16) + amount));
  return '#' + [r,g,b].map(x => x.toString(16).padStart(2,'0')).join('');
}

function recomputeTypeScale() {
  const base = state.typeBase;
  const ratio = state.typeRatio;
  document.documentElement.style.setProperty('--t-text-base', base + 'px');
  const steps = { xs: -2, sm: -1, md: 1, lg: 2, xl: 3, '2xl': 4, '3xl': 5, '4xl': 6 };
  Object.entries(steps).forEach(([name, exp]) => {
    const size = (base * Math.pow(ratio, exp)).toFixed(3);
    document.documentElement.style.setProperty('--t-text-' + name, size + 'px');
  });
}

function recomputeSpacing() {
  const base = state.spaceBase;
  [1,2,3,4,5,6,8,10,12,16,20,24,32,40].forEach(mult => {
    document.documentElement.style.setProperty('--t-space-' + mult, (base * mult) + 'px');
  });
}

// ---- PRESET THEMES ----
function applyPresetTheme(name) {
  pushUndo();
  resetThemeInternal();
  const themes = {
    ocean:   { brand: '#0077B6', hover: '#005F8F', surface1: '#F0F7FF', border: '#B8D8E8' },
    forest:  { brand: '#2D6A4F', hover: '#1B4332', surface1: '#F0FFF4', border: '#B7E4C7' },
    sunset:  { brand: '#E85D04', hover: '#C24E04', surface1: '#FFF5F0', border: '#F4C2A1' },
    midnight:{ brand: '#7B2CBF', hover: '#5A189A', surface1: '#F8F0FF', border: '#C8A8E9' }
  };
  const t = themes[name];
  if (!t) return;
  // Use Direct variants ‚Äî pushUndo already called above
  setTokenDirect('--t-raw-blue-600', t.brand);
  setTokenDirect('--t-interactive-default', t.brand);
  setTokenDirect('--t-bg-brand', t.brand);
  setTokenDirect('--t-border-brand', t.brand);
  setTokenDirect('--t-fg-link', t.brand);
  setTokenDirect('--t-interactive-hover', t.hover);
  setTokenDirect('--t-interactive-active', adjustBrightness(t.brand, -30));
  setTokenDirect('--t-raw-blue-700', t.hover);
  setTokenDirect('--t-raw-blue-50', adjustBrightness(t.brand, 40));
  setTokenDirect('--t-bg-info', adjustBrightness(t.brand, 40));
  setTokenDirect('--t-border-focus', adjustBrightness(t.brand, 20));
  setTokenDirect('--t-surface-1', t.surface1);
  setTokenDirect('--t-border-default', t.border);
  updatePanel();
}

function resetThemeInternal() {
  Object.keys(state.tokenOverrides).forEach(prop => {
    document.documentElement.style.removeProperty(prop);
  });
  state.tokenOverrides = {};
  state.typeBase = 16; state.typeRatio = 1.25; state.spaceBase = 4;
  state.vfWeight = { regular: 400, medium: 500, semibold: 600, bold: 700 };
  state.vfSlant = 0; state.vfOpsz = 'auto';
}

function resetTheme() {
  pushUndo();
  resetThemeInternal();
  updatePanel();
  updateDynamicContent();
}

function exportThemeCSS() {
  const overrides = Object.entries(state.tokenOverrides).map(([k,v]) => `  ${k}: ${v};`).join('\n');
  const css = `:root {\n${overrides || '  /* No overrides ‚Äî using defaults */'}\n}`;
  navigator.clipboard.writeText(css).then(() => showToast('success','Theme CSS Copied!','Paste into your project to apply this theme.'));
}

// ============================================================
// AGENT GOVERNANCE SIMULATION ‚Äî Visual Terrarium + Real Governance
// ============================================================
let simRunning = false;
let simTimeouts = [];

// Agent positions no longer needed for absolute placement ‚Äî agents are in grid columns

function resetTerrarium() {
  simTimeouts.forEach(t => clearTimeout(t));
  simTimeouts = [];
  simRunning = false;
  // Reset agent visual states
  document.querySelectorAll('.terrarium__avatar').forEach(a => a.classList.remove('terrarium__avatar--speaking'));
  document.querySelectorAll('.terrarium__agent').forEach(a => a.classList.remove('terrarium__agent--speaking'));
  document.querySelectorAll('.terrarium__bubble').forEach(b => b.remove());
  // Reset agent status text
  ['ds','ts','ag','ca','pl','px'].forEach(id => {
    const s = document.getElementById('agent-' + id + '-status');
    if (s) s.textContent = 'Idle';
  });
  // Reset center component
  const comp = document.getElementById('terrComponent');
  comp.classList.remove('terrarium__component--visible', 'terrarium__component--evolving');
  comp.style.borderColor = '';
  comp.style.boxShadow = '';
  document.getElementById('terrComponentInner').innerHTML = '<span style="font-size:20px;">üå±</span><div style="font-size:10px;color:var(--t-fg-tertiary);margin-top:2px;">Awaiting proposal</div>';
  document.getElementById('terrComponentLabel').textContent = '';
  document.getElementById('terrPhase').classList.remove('terrarium__phase--visible');
  document.getElementById('terrConnections').innerHTML = '';
  const zone = document.getElementById('terrZone');
  zone.className = 'terrarium__zone';
  document.getElementById('terrZoneLabel').textContent = 'Workshop';
  document.getElementById('terrLog').innerHTML = '<span style="color:var(--t-fg-tertiary);">Agent activity will appear here...</span>';
  clearTranscript();
}

function updateAgentStatus(agentId, statusText) {
  const el = document.getElementById('agent-' + agentId + '-status');
  if (el) el.textContent = statusText;
}

function showBubble(agentId, html, duration) {
  const agentEl = document.getElementById('agent-' + agentId);
  if (!agentEl) return;
  const existing = document.getElementById('bubble-' + agentId);
  if (existing) existing.remove();

  // Highlight the speaking agent
  const avatar = agentEl.querySelector('.terrarium__avatar');
  document.querySelectorAll('.terrarium__avatar').forEach(a => a.classList.remove('terrarium__avatar--speaking'));
  document.querySelectorAll('.terrarium__agent').forEach(a => a.classList.remove('terrarium__agent--speaking'));
  if (avatar) avatar.classList.add('terrarium__avatar--speaking');
  agentEl.classList.add('terrarium__agent--speaking');

  // Update status text
  const meta = AGENT_META[agentId];
  updateAgentStatus(agentId, 'Speaking...');

  // Insert bubble right after the agent element
  const bubble = document.createElement('div');
  bubble.className = 'terrarium__bubble';
  bubble.id = 'bubble-' + agentId;
  bubble.innerHTML = html;
  agentEl.parentNode.insertBefore(bubble, agentEl.nextSibling);

  requestAnimationFrame(() => { requestAnimationFrame(() => bubble.classList.add('terrarium__bubble--visible')); });
  if (duration) {
    simTimeouts.push(setTimeout(() => {
      bubble.classList.remove('terrarium__bubble--visible');
      agentEl.classList.remove('terrarium__agent--speaking');
      updateAgentStatus(agentId, 'Done');
      setTimeout(() => bubble.remove(), 250);
    }, duration));
  }
}

function showConnection(fromAgent, toAgent) {
  const svg = document.getElementById('terrConnections');
  const fromEl = document.getElementById('agent-' + fromAgent);
  const toEl = document.getElementById('agent-' + toAgent);
  if (!fromEl || !toEl) return;
  const terrarium = document.getElementById('terrarium');
  const rect = terrarium.getBoundingClientRect();
  const fromRect = fromEl.querySelector('.terrarium__avatar').getBoundingClientRect();
  const toRect = toEl.querySelector('.terrarium__avatar').getBoundingClientRect();
  const x1 = fromRect.left + fromRect.width/2 - rect.left;
  const y1 = fromRect.top + fromRect.height/2 - rect.top;
  const x2 = toRect.left + toRect.width/2 - rect.left;
  const y2 = toRect.top + toRect.height/2 - rect.top;
  const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  line.setAttribute('x1', x1); line.setAttribute('y1', y1);
  line.setAttribute('x2', x2); line.setAttribute('y2', y2);
  svg.appendChild(line);
  requestAnimationFrame(() => line.classList.add('active'));
  simTimeouts.push(setTimeout(() => { line.classList.remove('active'); setTimeout(() => line.remove(), 500); }, 2500));
}

function showPhase(text) {
  const el = document.getElementById('terrPhase');
  el.textContent = text;
  el.classList.add('terrarium__phase--visible');
  simTimeouts.push(setTimeout(() => el.classList.remove('terrarium__phase--visible'), 3000));
}

function logMini(text) {
  const log = document.getElementById('terrLog');
  if (log.querySelector('span[style]')) log.innerHTML = '';
  log.innerHTML += text + '\n';
  log.scrollTop = log.scrollHeight;
  logTranscript(text);
}

function updateCenterComponent(stage, componentName) {
  const comp = document.getElementById('terrComponent');
  const inner = document.getElementById('terrComponentInner');
  const label = document.getElementById('terrComponentLabel');

  if (stage === 'seedling') {
    inner.innerHTML = `<div style="font-size:11px;font-weight:var(--t-weight-semibold);color:var(--t-fg-primary);">${componentName}</div><span class="t-badge t-badge--draft" style="font-size:8px;padding:1px 6px;margin-top:4px;">Draft</span>`;
    label.textContent = 'Nursery';
    comp.classList.add('terrarium__component--visible');
    comp.style.borderColor = 'var(--t-raw-green-300)';
  } else if (stage === 'growing') {
    inner.innerHTML = `<div style="font-size:11px;font-weight:var(--t-weight-semibold);color:var(--t-fg-primary);">${componentName}</div><span class="t-badge t-badge--candidate" style="font-size:8px;padding:1px 6px;margin-top:4px;">Candidate</span>`;
    label.textContent = 'Workshop';
    comp.classList.add('terrarium__component--evolving');
    comp.style.borderColor = 'var(--t-raw-blue-300)';
  } else if (stage === 'validating') {
    inner.innerHTML = `<div style="font-size:11px;font-weight:var(--t-weight-semibold);color:var(--t-fg-primary);">${componentName}</div><div style="display:flex;gap:3px;margin-top:4px;"><span class="t-badge t-badge--candidate" style="font-size:8px;padding:1px 6px;">Candidate</span></div>`;
    label.textContent = 'Canopy';
    comp.classList.remove('terrarium__component--evolving');
    comp.style.borderColor = 'var(--t-raw-amber-400)';
  } else if (stage === 'stable') {
    inner.innerHTML = `<div style="font-size:11px;font-weight:var(--t-weight-semibold);color:var(--t-fg-primary);">${componentName}</div><div style="display:flex;gap:3px;margin-top:4px;"><span class="t-badge t-badge--stable" style="font-size:8px;padding:1px 6px;">Stable</span><span class="t-badge t-badge--success" style="font-size:8px;padding:1px 6px;">A11y ‚úì</span></div>`;
    label.textContent = 'Live';
    comp.style.borderColor = 'var(--t-raw-green-500)';
    comp.style.boxShadow = '0 0 12px rgba(45,106,79,0.1), var(--t-shadow-2)';
  }
}

function setZone(zone) {
  const el = document.getElementById('terrZone');
  const label = document.getElementById('terrZoneLabel');
  el.className = 'terrarium__zone terrarium__zone--' + zone;
  const zoneNames = { nursery: 'Nursery', workshop: 'Workshop', canopy: 'Canopy' };
  label.textContent = zoneNames[zone] || zone;
}

// ---- Proposal Generators (agents produce REAL changes) ----
function generateTokenProposal(agent, component, zone) {
  const currentBrand = rgbToHex(getComputed('--t-interactive-default'));
  const currentHover = rgbToHex(getComputed('--t-interactive-hover'));
  const currentRadius = getComputed('--t-radius-md').trim();
  const proposals = {
    ts: {
      rationale: `Token mapping for ${component}: proposing semantic token refinements to ensure no primitive references and optimal dark-mode contrast.`,
      changes: [
        { token: '--t-interactive-default', oldValue: currentBrand, newValue: adjustBrightness(currentBrand, -10), reason: 'Improve dark mode contrast ratio' },
        { token: '--t-interactive-hover', oldValue: currentHover, newValue: adjustBrightness(currentHover, -15), reason: 'Darker hover for clear state change' }
      ],
      approvalsNeeded: zone === 'canopy' ? ['ds','ts','ag','ca','pl','px'] : ['ts','ag'],
      orpa: { observe: 'Current brand color contrast: 4.8:1', reflect: 'WCAG AA requires 4.5:1 but targeting AAA (7:1)', plan: 'Darken interactive colors by 10-15 steps', act: 'Submit token change proposal' }
    },
    ag: {
      rationale: `Accessibility audit for ${component}: minimum touch target 48px recommended (exceeding WCAG 2.5.8 baseline of 44px). Focus indicators need 3px offset.`,
      changes: [
        { token: '--t-space-touch', oldValue: '44px', newValue: '48px', reason: 'Exceed WCAG 2.5.8 baseline', cssProperty: '--t-space-10' },
        { token: '--t-border-focus-width', oldValue: '2px', newValue: '3px', reason: 'Improved focus visibility' }
      ],
      approvalsNeeded: zone === 'canopy' ? ['ds','ts','ag','ca','pl','px'] : ['ag','ca'],
      orpa: { observe: 'Touch targets at 44px, focus ring at 2px', reflect: 'AAA compliance improves usability for all', plan: 'Increase targets and focus indicators', act: 'Submit accessibility enhancement' }
    },
    ca: {
      rationale: `Component architecture for ${component}: radius harmonization. Current radius-md creates visual inconsistency with new component boundaries.`,
      changes: [
        { token: '--t-radius-md', oldValue: currentRadius, newValue: (parseInt(currentRadius) + 2) + 'px', reason: 'Harmonize with new component edges' }
      ],
      approvalsNeeded: zone === 'canopy' ? ['ds','ts','ag','ca','pl','px'] : ['ca','ts'],
      orpa: { observe: 'Radius mismatch between old and new components', reflect: 'Consistency principle from philosophy.json', plan: 'Increase base radius by 2px', act: 'Submit radius adjustment' }
    }
  };
  return proposals[agent] || null;
}

function generateLifecycleProposal(agent, component, fromStage, toStage, zone) {
  const approvalsMap = {
    candidate: ['ts', 'ag', 'ca'],
    stable: ['ds', 'ts', 'ag', 'ca', 'pl', 'px']
  };
  return {
    type: 'lifecycle',
    agent: agent,
    targetId: component.toLowerCase(),
    rationale: `Lifecycle promotion: ${component} from ${fromStage} to ${toStage}. ${toStage === 'stable' ? 'Unanimous approval required ‚Äî all validation gates passed.' : 'Majority approval required ‚Äî specification review complete.'}`,
    changes: [{ component: component.toLowerCase(), from: fromStage, to: toStage }],
    approvalsNeeded: approvalsMap[toStage] || ['ds', 'ca'],
    orpa: { observe: `${component} has ${toStage === 'stable' ? '3+ team validations' : 'specification complete'}`, reflect: 'Component lifecycle protocol from component-lifecycle.json', plan: `Graduate to ${toStage}`, act: 'Submit lifecycle transition' },
    citations: [agent + '-review-' + Date.now()]
  };
}

function generateSpecProposal(agent, component, zone) {
  const proposals = {
    pl: {
      rationale: `Pattern review for ${component}: cross-pollination opportunity detected. Existing CalendarGrid pattern in Seed Vault can be merged. Documentation standards require update.`,
      changes: [
        { field: 'pattern', description: 'Merge with CalendarGrid from Seed Vault', action: 'cross-pollinate' },
        { field: 'documentation', description: 'Complete API docs + usage examples', action: 'update' }
      ],
      approvalsNeeded: zone === 'canopy' ? ['ds','ts','ag','ca','pl','px'] : ['pl','ca'],
      orpa: { observe: 'Similar pattern exists in Seed Vault', reflect: 'DRY principle + pattern reuse', plan: 'Merge patterns, update docs', act: 'Submit pattern proposal' }
    },
    px: {
      rationale: `Product validation for ${component}: 3 teams (Finance, HR, Commerce) have integrated. Finance and HR in production, Commerce prototyping. Multi-mode support (single + range) confirmed essential.`,
      changes: [
        { field: 'modes', description: 'Support both "single" and "range" selection modes', action: 'add' },
        { field: 'adoption', description: '3/3 team validations passed', action: 'validate' }
      ],
      approvalsNeeded: zone === 'canopy' ? ['ds','ts','ag','ca','pl','px'] : ['px','ds'],
      orpa: { observe: '3 product teams have integrated', reflect: 'Repeatability gate: 2+ teams required', plan: 'Confirm multi-mode API, validate adoption', act: 'Submit validation report' }
    }
  };
  return proposals[agent] || null;
}

// ---- Main Simulation Runner (visual terrarium animation, secondary to pipeline) ----
function runAgentSim(componentOverride, zoneOverride) {
  if (simRunning) return;
  simRunning = true;
  const component = componentOverride || 'DatePicker';
  const zone = zoneOverride || 'workshop';
  resetTerrarium();
  simRunning = true;
  setZone(zone);

  const scripts = {
    nursery: [
      { delay: 200, action: () => { showPhase('üå± Nursery ‚Äî Observation'); logMini('<b style="color:var(--t-raw-amber-300);">‚Äî Nursery: Observation Phase ‚Äî</b>'); }},
      { delay: 600, action: () => { updateCenterComponent('seedling', component); }},
      { delay: 900, action: () => {
        showBubble('ds', `New proposal: <b>${component}</b>. Builder mode ‚Äî no rejection, only "yes, and..."`, 4000);
        logMini('<span style="color:var(--t-raw-blue-400);">DS Lead:</span> New proposal entering Nursery');
      }},
      { delay: 2800, action: () => {
        showBubble('px', `3 teams building ad-hoc ${component.toLowerCase()}. Clear repeatable need. <span class="cite">üìã Submitting validation</span>`, 3500);
        const specData = generateSpecProposal('px', component, zone);
        if (specData) { const p = createProposal({ type: 'spec', agent: 'px', targetId: component.toLowerCase(), ...specData, zone: zone }); submitProposal(p); }
        logMini('<span style="color:var(--t-raw-blue-300);">Product Liaison:</span> üìã Proposal GOV submitted');
      }},
      { delay: 4500, action: () => {
        showBubble('ca', `How might ${component} compose with Input + Dropdown? <span class="cite">Building on PX</span>`, 3500);
        showConnection('ca', 'px');
        logMini('<span style="color:var(--t-raw-neutral-300);">Comp Architect:</span> Exploring composition');
      }},
      { delay: 6200, action: () => {
        showBubble('ag', `Keyboard nav model? ARIA grid vs. listbox. <span class="cite">Exploratory ‚Äî not blocking</span>`, 3500);
        logMini('<span style="color:var(--t-raw-green-400);">A11y Guardian:</span> Flagged nav model');
      }},
      { delay: 8000, action: () => {
        showBubble('ts', `Existing spacing tokens work for calendar grids. 4px base is natural. <span class="cite">Building on CA ¬∑ üìã Token proposal</span>`, 3500);
        showConnection('ts', 'ca');
        const tokenData = generateTokenProposal('ts', component, zone);
        if (tokenData) { const p = createProposal({ type: 'token', agent: 'ts', targetId: component.toLowerCase(), ...tokenData, zone: zone }); submitProposal(p); }
        logMini('<span style="color:var(--t-raw-amber-400);">Token Steward:</span> üìã Token proposal submitted');
      }},
      { delay: 9800, action: () => {
        showBubble('pl', `Seed Vault match: "CalendarGrid" archived 6mo ago. <span class="cite">Cross-pollination! ¬∑ üìã Pattern proposal</span>`, 3500);
        showConnection('pl', 'ds');
        const specData = generateSpecProposal('pl', component, zone);
        if (specData) { const p = createProposal({ type: 'spec', agent: 'pl', targetId: component.toLowerCase(), ...specData, zone: zone }); submitProposal(p); }
        logMini('<span style="color:var(--t-raw-red-300);">Pattern Lib:</span> üìã Pattern proposal submitted');
      }},
      { delay: 12000, action: () => { showPhase('üå± Nursery ‚Äî Verdict'); logMini('<b style="color:var(--t-raw-amber-300);">‚Äî Nursery: Verdict ‚Äî</b>'); }},
      { delay: 12800, action: () => {
        updateCenterComponent('growing', component);
        showBubble('ds', `Clear JTBD + repeatable need + vault match. Graduating to Workshop! <span class="cite">üìã Lifecycle proposal</span>`, 4000);
        showConnection('ds', 'pl'); showConnection('ds', 'px');
        const lcData = generateLifecycleProposal('ds', component, 'draft', 'candidate', zone);
        const p = createProposal({ ...lcData, zone: zone });
        submitProposal(p);
        logMini('<span style="color:var(--t-raw-blue-400);">DS Lead:</span> üìã Lifecycle: Draft ‚Üí Candidate');
        simTimeouts.push(setTimeout(() => { simRunning = false; logMini('<b style="color:var(--t-raw-green-400);">‚úì ' + governance.proposals.length + ' proposals await your review in Approval Queue</b>'); }, 2000));
      }}
    ],
    workshop: [
      { delay: 200, action: () => { showPhase('ü™¥ Workshop ‚Äî Structured Exploration'); logMini('<b style="color:var(--t-raw-amber-300);">‚Äî Workshop: Structured Exploration ‚Äî</b>'); }},
      { delay: 600, action: () => { updateCenterComponent('seedling', component); }},
      { delay: 900, action: () => {
        showBubble('ds', `<b>${component}</b> enters Workshop. Builder/Optimizer cycles begin.`, 3500);
        logMini('<span style="color:var(--t-raw-blue-400);">DS Lead:</span> Workshop session started');
      }},
      { delay: 2600, action: () => {
        updateCenterComponent('growing', component);
        showBubble('ca', `<span class="b-mode">Builder</span>Anatomy: trigger (Input) + popup (Dropdown) + grid (Calendar primitive). <span class="cite">üìã Spec proposal</span>`, 4000);
        const specData = { rationale: `Architecture for ${component}: composite of Input + Dropdown + new Calendar grid. Minimal API surface.`, changes: [{ field: 'anatomy', description: 'trigger (Input) + popup (Dropdown) + grid (Calendar)', action: 'define' }], approvalsNeeded: ['ca', 'ts', 'ag'], orpa: { observe: 'No existing calendar primitive', reflect: 'Composition over creation', plan: 'Build from existing primitives', act: 'Submit anatomy' }, citations: [] };
        const p = createProposal({ type: 'spec', agent: 'ca', targetId: component.toLowerCase(), ...specData, zone: zone });
        submitProposal(p);
        logMini('<span style="color:var(--t-raw-neutral-300);">Comp Architect:</span> [Builder] üìã Anatomy proposed');
      }},
      { delay: 4800, action: () => {
        showBubble('ts', `<span class="b-mode">Builder</span>Token mapping: --t-space-6 cells, --t-radius-md days, semantic state colors. <span class="cite">Building on CA ¬∑ üìã Token proposal</span>`, 4000);
        showConnection('ts', 'ca');
        const tokenData = generateTokenProposal('ts', component, zone);
        if (tokenData) { const p = createProposal({ type: 'token', agent: 'ts', targetId: component.toLowerCase(), ...tokenData, zone: zone, citations: ['ca-anatomy'] }); submitProposal(p); }
        logMini('<span style="color:var(--t-raw-amber-400);">Token Steward:</span> [Builder] üìã Token mapping submitted');
      }},
      { delay: 7000, action: () => {
        showBubble('ag', `<span class="b-mode">Optimizer</span>ARIA grid pattern. Arrow keys + Enter. Min 48px touch. <span class="cite">Refining CA ¬∑ üìã A11y proposal</span>`, 4000);
        showConnection('ag', 'ca');
        const tokenData = generateTokenProposal('ag', component, zone);
        if (tokenData) { const p = createProposal({ type: 'token', agent: 'ag', targetId: component.toLowerCase(), ...tokenData, zone: zone, citations: ['ca-anatomy'] }); submitProposal(p); }
        logMini('<span style="color:var(--t-raw-green-400);">A11y Guardian:</span> [Optimizer] üìã A11y requirements submitted');
      }},
      { delay: 9200, action: () => {
        showBubble('pl', `<span class="b-mode">Builder</span>Cross-pollination: calendar grid solves availability-picker too. <span class="cite">üìã Pattern proposal</span>`, 4000);
        showConnection('pl', 'ca');
        const specData = generateSpecProposal('pl', component, zone);
        if (specData) { const p = createProposal({ type: 'spec', agent: 'pl', targetId: component.toLowerCase(), ...specData, zone: zone }); submitProposal(p); }
        logMini('<span style="color:var(--t-raw-red-300);">Pattern Lib:</span> [Builder] üìã Cross-pollination submitted');
      }},
      { delay: 11400, action: () => {
        showBubble('px', `<span class="b-mode">Optimizer</span>2 teams piloting. Finance: ranges. HR: single dates. Both modes needed. <span class="cite">üìã Validation</span>`, 4000);
        const specData = generateSpecProposal('px', component, zone);
        if (specData) { const p = createProposal({ type: 'spec', agent: 'px', targetId: component.toLowerCase(), ...specData, zone: zone }); submitProposal(p); }
        logMini('<span style="color:var(--t-raw-blue-300);">Product Liaison:</span> [Optimizer] üìã Validation submitted');
      }},
      { delay: 13600, action: () => {
        showBubble('ca', `<span class="b-mode">Optimizer</span>Revised: mode="single"|"range", onChange callback. Minimal API. <span class="cite">Incorporating PX</span>`, 4000);
        showConnection('ca', 'px');
        logMini('<span style="color:var(--t-raw-neutral-300);">Comp Architect:</span> [Optimizer] API revised');
      }},
      { delay: 15800, action: () => { showPhase('ü™¥ Workshop ‚Äî Review Gate'); logMini('<b style="color:var(--t-raw-amber-300);">‚Äî Workshop: Review Gate ‚Äî</b>'); updateCenterComponent('validating', component); }},
      { delay: 17000, action: () => {
        showBubble('ts', `Token review: ‚úÖ All semantic. <b>Approved.</b>`, 2500);
        governance.proposals.forEach(p => { if (p.proposedBy === 'ts' || p.type === 'token') p.approvalsReceived['ts'] = true; });
        logMini('<span style="color:var(--t-raw-amber-400);">Token Steward:</span> ‚úÖ Approved');
      }},
      { delay: 18500, action: () => {
        showBubble('ag', `A11y review: ‚úÖ <b>Approved</b> ‚Äî focus trapping + aria-labels confirmed.`, 2500);
        governance.proposals.forEach(p => { p.approvalsReceived['ag'] = true; });
        logMini('<span style="color:var(--t-raw-green-400);">A11y Guardian:</span> ‚úÖ Approved');
      }},
      { delay: 20000, action: () => {
        showBubble('ca', `Architecture: ‚úÖ <b>Approved.</b> 3/3 majority ‚Äî graduating to Canopy! <span class="cite">üìã Lifecycle</span>`, 3500);
        governance.proposals.forEach(p => { p.approvalsReceived['ca'] = true; });
        const lcData = generateLifecycleProposal('ca', component, 'candidate', 'stable', zone);
        const p = createProposal({ ...lcData, zone: zone });
        // Set workshop majority approvals
        p.approvalsReceived = { ca: true, ts: true, ag: true };
        submitProposal(p);
        logMini('<span style="color:var(--t-raw-neutral-300);">Comp Architect:</span> ‚úÖ 3/3 ‚Äî üìã Lifecycle: Candidate ‚Üí Stable');
        updateGovUI();
        simTimeouts.push(setTimeout(() => { simRunning = false; logMini('<b style="color:var(--t-raw-green-400);">‚úì ' + governance.proposals.length + ' proposals await your review in Approval Queue</b>'); }, 2000));
      }}
    ],
    canopy: [
      { delay: 200, action: () => { showPhase('üå≥ Canopy ‚Äî Full Evaluation'); logMini('<b style="color:var(--t-raw-amber-300);">‚Äî Canopy: Full Evaluation ‚Äî</b>'); }},
      { delay: 600, action: () => { updateCenterComponent('validating', component); }},
      { delay: 900, action: () => {
        showBubble('ds', `<b>${component}</b> enters the Canopy. Full governance. Unanimous required. H-index active.`, 3500);
        logMini('<span style="color:var(--t-raw-blue-400);">DS Lead:</span> Canopy review initiated');
      }},
      { delay: 2800, action: () => {
        showBubble('ag', `<b>WCAG 2.2 AA audit:</b> Contrast ‚úÖ 7.2:1 | Touch ‚úÖ 48px | KB ‚úÖ | SR ‚úÖ. <b>PASSED.</b> <span class="cite">üìã A11y proposal</span>`, 4000);
        const tokenData = generateTokenProposal('ag', component, zone);
        if (tokenData) { const p = createProposal({ type: 'token', agent: 'ag', targetId: component.toLowerCase(), ...tokenData, zone: zone }); ['ds','ts','ag','ca','pl','px'].forEach(a => p.approvalsReceived[a] = (a === 'ag')); submitProposal(p); }
        logMini('<span style="color:var(--t-raw-green-400);">A11y Guardian:</span> Audit PASSED ¬∑ üìã Proposal submitted');
      }},
      { delay: 5000, action: () => {
        showBubble('ts', `<b>Token compliance:</b> 24 semantic refs ‚úÖ | Dark ‚úÖ | Density x3 ‚úÖ. <b>PASSED.</b> <span class="cite">üìã Token proposal</span>`, 4000);
        const tokenData = generateTokenProposal('ts', component, zone);
        if (tokenData) { const p = createProposal({ type: 'token', agent: 'ts', targetId: component.toLowerCase(), ...tokenData, zone: zone }); ['ds','ts','ag','ca','pl','px'].forEach(a => p.approvalsReceived[a] = (a === 'ts')); submitProposal(p); }
        logMini('<span style="color:var(--t-raw-amber-400);">Token Steward:</span> Compliance PASSED ¬∑ üìã Submitted');
      }},
      { delay: 7200, action: () => {
        showBubble('ca', `<b>Architecture:</b> Composition ‚úÖ | No circular deps ‚úÖ | 4.2KB ‚úÖ | SSR ‚úÖ. <b>PASSED.</b>`, 4000);
        logMini('<span style="color:var(--t-raw-neutral-300);">Comp Architect:</span> Architecture PASSED');
      }},
      { delay: 9400, action: () => {
        showBubble('pl', `<b>Pattern check:</b> No duplication ‚úÖ | Docs ‚úÖ | Seed Vault merge complete. <span class="cite">üìã Submitted</span>`, 4000);
        showConnection('pl', 'ds');
        const specData = generateSpecProposal('pl', component, zone);
        if (specData) { const p = createProposal({ type: 'spec', agent: 'pl', targetId: component.toLowerCase(), ...specData, zone: zone }); ['ds','ts','ag','ca','pl','px'].forEach(a => p.approvalsReceived[a] = (a === 'pl')); submitProposal(p); }
        logMini('<span style="color:var(--t-raw-red-300);">Pattern Lib:</span> Pattern PASSED ¬∑ üìã Submitted');
      }},
      { delay: 11600, action: () => {
        showBubble('px', `<b>Adoption:</b> Finance ‚úÖ prod | HR ‚úÖ staging | Commerce ‚úÖ prototype. <b>3/3.</b>`, 4000);
        logMini('<span style="color:var(--t-raw-blue-300);">Product Liaison:</span> 3/3 validations confirmed');
      }},
      { delay: 13800, action: () => { showPhase('üå≥ Canopy ‚Äî Promotion Vote'); logMini('<b style="color:var(--t-raw-amber-300);">‚Äî Canopy: Promotion Vote ‚Äî</b>'); }},
      { delay: 14800, action: () => {
        showBubble('ag', `Vote: ‚úÖ <b>APPROVE</b>`, 2000);
        governance.proposals.forEach(p => { if (p.targetZone === 'canopy') p.approvalsReceived['ag'] = true; });
        logMini('<span style="color:var(--t-raw-green-400);">A11y Guardian:</span> ‚úÖ APPROVE');
      }},
      { delay: 15800, action: () => {
        showBubble('ts', `Vote: ‚úÖ <b>APPROVE</b>`, 2000);
        governance.proposals.forEach(p => { if (p.targetZone === 'canopy') p.approvalsReceived['ts'] = true; });
        logMini('<span style="color:var(--t-raw-amber-400);">Token Steward:</span> ‚úÖ APPROVE');
      }},
      { delay: 16800, action: () => {
        showBubble('ca', `Vote: ‚úÖ <b>APPROVE</b>`, 2000);
        governance.proposals.forEach(p => { if (p.targetZone === 'canopy') p.approvalsReceived['ca'] = true; });
        logMini('<span style="color:var(--t-raw-neutral-300);">Comp Architect:</span> ‚úÖ APPROVE');
      }},
      { delay: 17800, action: () => {
        showBubble('pl', `Vote: ‚úÖ <b>APPROVE</b>`, 2000);
        governance.proposals.forEach(p => { if (p.targetZone === 'canopy') p.approvalsReceived['pl'] = true; });
        logMini('<span style="color:var(--t-raw-red-300);">Pattern Lib:</span> ‚úÖ APPROVE');
      }},
      { delay: 18800, action: () => {
        showBubble('px', `Vote: ‚úÖ <b>APPROVE</b>`, 2000);
        governance.proposals.forEach(p => { if (p.targetZone === 'canopy') p.approvalsReceived['px'] = true; });
        logMini('<span style="color:var(--t-raw-blue-300);">Product Liaison:</span> ‚úÖ APPROVE');
      }},
      { delay: 20000, action: () => {
        updateCenterComponent('stable', component);
        governance.proposals.forEach(p => { if (p.targetZone === 'canopy') p.approvalsReceived['ds'] = true; });
        showBubble('ds', `<b>Unanimous.</b> ${component} now <b>STABLE</b>. üåø <span class="cite">5/5 + DSL + 3 teams ¬∑ üìã Final lifecycle</span>`, 5000);
        showConnection('ds', 'ag'); showConnection('ds', 'ts'); showConnection('ds', 'ca');
        const lcData = generateLifecycleProposal('ds', component, 'candidate', 'stable', zone);
        const p = createProposal({ ...lcData, zone: zone });
        ['ds','ts','ag','ca','pl','px'].forEach(a => p.approvalsReceived[a] = true);
        submitProposal(p);
        logMini('<span style="color:var(--t-raw-blue-400);">DS Lead:</span> üåø <b>UNANIMOUS ‚Äî üìã ' + governance.proposals.length + ' proposals await Gardener approval</b>');
        simTimeouts.push(setTimeout(() => { simRunning = false; }, 2000));
      }}
    ]
  };

  const messages = scripts[zone] || scripts.workshop;
  messages.forEach(m => { simTimeouts.push(setTimeout(m.action, m.delay)); });
}

function gardenerIntervene(action) {
  const msgs = {
    shield: { phase: 'üßë‚Äçüåæ Gardener ‚Äî Shield Active', bubble: 'This idea is under protection. No agent may compost or deprioritize. Continue nurturing.', log: 'Shield activated ‚Äî idea protected' },
    seed:   { phase: 'üßë‚Äçüåæ Gardener ‚Äî Biodiversity Seeding', bubble: 'Introducing contrarian perspective to prevent monoculture. All agents: consider the opposite.', log: 'Biodiversity seeding ‚Äî contrarian injection' },
    revive: { phase: 'üßë‚Äçüåæ Gardener ‚Äî Seed Vault Revival', bubble: 'Conditions changed. Reviving from Seed Vault. Enters Workshop directly.', log: 'Seed Vault revival triggered' },
    promote:{ phase: 'üßë‚Äçüåæ Gardener ‚Äî Force Promotion', bubble: 'Overriding lifecycle. Promoted to next zone. Rationale documented.', log: 'Force promotion ‚Äî lifecycle overridden' }
  };
  const m = msgs[action]; if (!m) return;
  showPhase(m.phase);
  showBubble('ds', `<span class="b-mode">Gardener Override</span>${m.bubble}`, 5000);
  logMini('<b style="color:var(--t-raw-amber-300);">üßë‚Äçüåæ ' + m.log + '</b>');
  logAudit('gardener_intervention', 'N/A', 'gardener', m.log);
}

// ============================================================
// TAB SWITCHING
// ============================================================
function switchTab(tabEl, panelId) {
  const tablist = tabEl.closest('.t-tab-list');
  tablist.querySelectorAll('.t-tab').forEach(t => { t.classList.remove('t-tab--active'); t.setAttribute('aria-selected','false'); });
  tabEl.classList.add('t-tab--active');
  tabEl.setAttribute('aria-selected','true');
  tabEl.closest('.t-tabs').querySelectorAll('.t-tab-panel').forEach(p => p.hidden = true);
  document.getElementById(panelId).hidden = false;
}

// ============================================================
// TOAST SYSTEM
// ============================================================
let toastId = 0;
function showToast(type, title, message) {
  const container = document.getElementById('toastContainer');
  const id = 'toast-' + (++toastId);
  const toast = document.createElement('div');
  toast.className = 't-toast t-toast--' + type;
  toast.id = id;
  toast.innerHTML = `<div class="t-toast__content"><div class="t-toast__title">${title}</div>${message}</div><button class="t-toast__dismiss" onclick="dismissToast('${id}')"><svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M3 3l8 8M11 3l-8 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg></button>`;
  container.appendChild(toast);
  setTimeout(() => dismissToast(id), 4000);
}
function dismissToast(id) {
  const t = document.getElementById(id);
  if (t) { t.style.opacity='0'; t.style.transform='translateX(100%)'; t.style.transition='all 0.2s'; setTimeout(()=>t.remove(),200); }
}

// ============================================================
// KNOWLEDGE BASE / WIKI
// ============================================================
const WIKI = {
  // ---- Ecosystem Model ----
  'terrarium-model': { term: 'Terrarium Model', category: 'Ecosystem', def: 'The governing metaphor of this design system. Like a real terrarium, it\'s a self-contained ecosystem where ideas germinate, grow, and either flourish or return to the soil. The system discovers its own shape through use rather than top-down prediction.', source: 'philosophy.json', rule: 'The system must emerge through use, not through speculative abstraction.' },
  'eco-zones': { term: 'Ecological Zones', category: 'Ecosystem', def: 'Four stratospheres through which every component idea travels: Nursery, Workshop, Canopy, and Seed Vault. Each zone has escalating governance rigor and different rules for how agents behave.', source: 'molt-pit.json', rule: 'Every component must pass through zones sequentially. No skipping ‚Äî unless the Gardener overrides.' },
  'nursery': { term: 'Nursery', category: 'Ecosystem', def: 'The first zone. A protected space where new ideas germinate. No rejection allowed ‚Äî only "yes, and..." exploration. H-index influence is zero. All agents operate in Builder mode only. Max 2 sprints before graduating to Workshop or being seed-vaulted.', source: 'molt-pit.json', rule: 'No agent may reject an idea in the Nursery. Only Socratic questions, never assertions.' },
  'workshop': { term: 'Workshop', category: 'Ecosystem', def: 'The second zone. Structured exploration through alternating Builder/Optimizer cycles. Agents propose and critique in turns. Majority approval (3/6) suffices. Cross-pollination actively encouraged. 1-3 sprints.', source: 'molt-pit.json', rule: 'Every critique MUST pair with a constructive alternative. Majority vote, not unanimity.' },
  'canopy': { term: 'Canopy', category: 'Ecosystem', def: 'The third zone. Full sunlight ‚Äî full governance rigor. Proven ideas face complete audits from all agents. Unanimous approval required for Stable promotion. Accessibility Guardian\'s absolute veto is active. H-index at full weight for tie-breaking.', source: 'molt-pit.json', rule: 'Unanimous approval required. AG absolute veto cannot be overridden below Steering Committee.' },
  'seed-vault': { term: 'Seed Vault', category: 'Ecosystem', def: 'The archive. Ideas that didn\'t flourish in their season are preserved here with full context ‚Äî rationale, critiques, votes, conditions. Nothing truly dies. The Pattern Librarian reviews quarterly, and any agent or the Gardener can propose revival when conditions change.', source: 'molt-pit.json', rule: 'Seeds must be preserved with full decision context. Quarterly review mandatory.' },
  'builder-optimizer': { term: 'Builder/Optimizer Cycle', category: 'Ecosystem', def: 'The alternating creative rhythm in the Workshop zone. In Builder mode, agents propose and expand. In Optimizer mode, agents critique and refine. This prevents premature convergence while ensuring quality.', source: 'molt-pit.json', rule: 'Workshop agents must alternate modes. Pure critique (Optimizer-only) is forbidden.' },

  // ---- Agent Governance ----
  'agent-governance': { term: 'Agent Governance', category: 'Agents', def: 'The system of 6 specialized AI agents that collaboratively govern the design system. Each agent has bounded authority, defined veto powers, and specific expertise. They follow the ORPA cognitive cycle for every action.', source: 'agent-roles.json', rule: 'Single-purpose agents. No agent may act outside their defined authority boundary.' },
  'ds-lead': { term: 'Design System Lead', category: 'Agents', def: 'Strategic agent with final authority. Can veto any change with written rationale. Cannot bypass accessibility requirements or approve own proposals. In the Nursery: Gardener. In Workshop: Facilitator. In Canopy: Steward.', source: 'agent-roles.json', rule: 'DSL veto requires written rationale. Cannot bypass AG on accessibility.' },
  'token-steward': { term: 'Token Steward', category: 'Agents', def: 'Domain specialist for design tokens. Validates naming conventions, semantic token usage, dark mode definitions, and deprecation paths. Can veto components that reference primitives directly.', source: 'agent-roles.json', rule: 'No component may reference primitive tokens directly. Semantic tokens only.' },
  'a11y-guardian': { term: 'Accessibility Guardian', category: 'Agents', def: 'Domain specialist with absolute veto power on accessibility failures. Validates WCAG 2.2 AA compliance, keyboard navigation, screen reader support, touch targets (48px min), and color contrast (4.5:1 text, 3:1 non-text). Veto cannot be overridden below Steering Committee.', source: 'agent-roles.json', rule: 'ABSOLUTE VETO on a11y failures. Cannot be overridden by any agent or the DSL.' },
  'pattern-librarian': { term: 'Pattern Librarian', category: 'Agents', def: 'Domain specialist for pattern management. Manages the Seed Vault, screens for duplication, facilitates cross-pollination between domains, and conducts quarterly pattern mining reviews.', source: 'agent-roles.json', rule: 'Must screen every new proposal for duplication within 3 business days.' },
  'component-architect': { term: 'Component Architect', category: 'Agents', def: 'Domain specialist for component structure. Reviews composition, dependency direction, bundle size, SSR compatibility. Can veto composition-violating structures.', source: 'agent-roles.json', rule: 'Inward dependency direction required. No circular dependencies allowed.' },
  'product-liaison': { term: 'Product Liaison', category: 'Agents', def: 'Bridge agent between the design system and product teams. Validates real-world need, tracks adoption, reports feedback. Advisory veto on deprecations citing migration burden. Cannot modify tokens or override a11y.', source: 'agent-roles.json', rule: 'Repeatability gate: 2+ product team validations required before Stable.' },

  // ---- Cognitive & Operational ----
  'orpa-cycle': { term: 'ORPA Cycle', category: 'Operational', def: 'The cognitive cycle every agent follows for every action: Observe (perceive environment, proposals, metrics), Reflect (reason about alignment, precedent, impact), Plan (formulate response within constraints), Act (execute: review, propose, cite, escalate).', source: 'operational-model.json', rule: 'All agent actions must complete the full ORPA cycle. No action without reflection.' },
  'nutrient-flow': { term: 'Nutrient Flow (H-Index)', category: 'Operational', def: 'The citation-based credibility system. When Agent A builds on Agent B\'s decision, B\'s h-index grows. Visible to all agents but does NOT grant veto power. Weight varies by zone: zero in Nursery, advisory in Workshop, full for tie-breaking in Canopy.', source: 'molt-pit.json', rule: 'High h-index never grants additional authority. Low h-index never strips existing authority.' },
  'gardeners-hand': { term: 'Gardener\'s Hand (HITL)', category: 'Operational', def: 'The human-in-the-loop override system. The Ecosystem Gardener (you) can: Shield ideas from composting, Seed biodiversity by injecting contrarian perspectives, Revive ideas from the Seed Vault, Force-promote through zones, and halt autonomous agent exploration at any time.', source: 'operational-model.json', rule: 'Gardener can override any agent decision. Must be documented in audit log.' },
  'gardenersHalt': { term: 'Gardener\'s Halt', category: 'Operational', def: 'Emergency stop mechanism. The human can pause or redirect any autonomous agent exploration at any time. When triggered, agents fall back to deterministic workflow mode. Named to align with the terrarium metaphor rather than violent language.', source: 'operational-model.json', rule: 'GardenersHalt is instantaneous and irrevocable. All agents must comply immediately.' },
  'push-live': { term: 'Push Live', category: 'Operational', def: 'The act of applying approved governance proposals to the live design system. All staged changes are batched into a single undo snapshot. Token changes modify CSS custom properties. Lifecycle promotions update component maturity badges. Ctrl+Z reverts the entire batch.', source: 'operational-model.json', rule: 'Push Live requires explicit human action. No automatic deployment.' },
  'quarterly-review': { term: 'Quarterly Pattern Mining', category: 'Operational', def: 'Regular review conducted by the Pattern Librarian. Checks the Seed Vault for ideas whose conditions have changed. Also includes biannual challenge of stable component assumptions and annual full ecosystem health assessment.', source: 'operational-model.json', rule: 'Pattern Librarian must conduct quarterly. DSL challenges assumptions biannually.' },

  // ---- Philosophy ----
  'jtbd': { term: 'Jobs to Be Done (JTBD)', category: 'Philosophy', def: 'The foundational design philosophy. Every component exists to solve a real, repeatable problem. If it doesn\'t work, nothing else matters. Priority: Functional (does it work?) > Affordance (is it recognizable?) > Emotional (does it feel right?).', source: 'philosophy.json', rule: 'JTBD priority is immutable: Functional > Affordance > Emotional. Cannot be reordered.' },
  'functional-dimension': { term: 'Functional Dimension', category: 'Philosophy', def: '"Does this component do what I need it to do?" A button submits. An input captures text. A dialog traps focus. Function is the non-negotiable foundation. If a component fails functional evaluation, visual polish cannot save it.', source: 'philosophy.json', rule: 'No component passes review without proving functional completeness.' },
  'affordance': { term: 'Consistency as Affordance', category: 'Philosophy', def: 'When you look at a button, you know it\'s a button. This visual language consistency IS the unique value proposition of a design system. Accessibility Guardian has absolute veto on affordance violations.', source: 'philosophy.json', rule: 'Visual consistency is non-negotiable. AG veto on affordance failures.' },
  'emotional-quality': { term: 'Emotional Quality', category: 'Philosophy', def: 'Emotional resonance is earned through functional excellence. Don\'t design for feelings ‚Äî design for competence, and the feelings follow. Trust is the product of consistent, high-quality interactions.', source: 'philosophy.json', rule: 'Emotion is tertiary. Never prioritize aesthetics over function or affordance.' },
  'designers-log': { term: 'Designer\'s Log', category: 'Philosophy', def: 'The living record of the human designer\'s directives, philosophical breakthroughs, and course corrections that shaped Terrarium. Preserved in the designer\'s exact words. This is the ultimate design authority ‚Äî when principles conflict, the Designer\'s Log resolves the ambiguity.', source: 'designer-log.json', rule: 'The designer\'s voice is law. When in doubt, return to the log.' },
  'zeroclaw': { term: 'ZeroClaw Principles', category: 'Philosophy', def: 'Runtime principles from the ZeroClaw framework: Clarity over cleverness, no speculative abstractions, single-purpose agents, inward dependency direction, trait-driven extensibility, and durable state management.', source: 'operational-model.json', rule: 'Clarity over cleverness. No process without concrete use case.' },

  // ---- Lifecycle & Maturity ----
  'draft': { term: 'Draft', category: 'Lifecycle', def: 'The first maturity tier. A hypothesis ‚Äî the component idea has entered the system but hasn\'t been validated. In Nursery or early Workshop. Protected from rejection.', source: 'component-lifecycle.json', rule: 'Drafts may only be seed-vaulted, never rejected outright.' },
  'candidate': { term: 'Candidate', category: 'Lifecycle', def: 'The second maturity tier. A component that has passed specification review (Token Steward + A11y Guardian + Component Architect approval). Now undergoing validation with 2+ product teams.', source: 'component-lifecycle.json', rule: 'Requires TS + AG + CA approval. Must have 2+ team validations before Stable.' },
  'stable': { term: 'Stable', category: 'Lifecycle', def: 'The third maturity tier. Production-ready. Has passed all validation gates: unanimous agent approval, full WCAG 2.2 AA audit, 2+ team integrations, and DSL final sign-off. Enters quarterly health check cycle.', source: 'component-lifecycle.json', rule: 'UNANIMOUS approval required. Subject to quarterly health checks.' },
  'deprecated': { term: 'Deprecated', category: 'Lifecycle', def: 'A stable component that no longer serves its purpose or is being replaced. Requires deprecation RFC, impact assessment, minimum 2-sprint migration window, and explicit DSL approval. Component enters Seed Vault with full context.', source: 'component-lifecycle.json', rule: 'Minimum 2-sprint migration window. Must include migration guide.' },

  // ---- Token System ----
  'design-tokens': { term: 'Design Tokens', category: 'Tokens', def: 'The atomic values of the design system: colors, spacing, typography, elevation, radius. Stored in W3C DTCG JSON format with three tiers: Primitive (raw values) > Semantic (contextual meaning) > Component (specific usage). 180+ tokens in the system.', source: 'token-engine.js', rule: 'Three-tier hierarchy is mandatory. Components must reference semantic tokens only.' },
  'semantic-tokens': { term: 'Semantic Tokens', category: 'Tokens', def: 'The middle tier of the token hierarchy. These carry contextual meaning: --t-interactive-default, --t-fg-primary, --t-bg-danger. They reference primitives internally but expose meaning externally. All component styles must use semantic tokens.', source: 'color.tokens.json', rule: 'Components may NEVER reference primitive tokens directly. Semantic only.' },
  'primitive-tokens': { term: 'Primitive Tokens', category: 'Tokens', def: 'The base tier. Raw values like --t-raw-blue-600, --t-raw-neutral-100. These form the palette but should never be used directly in components. They\'re consumed by semantic tokens.', source: 'color.tokens.json', rule: 'Primitives are internal only. Direct usage in components triggers Token Steward veto.' },
  'dtcg': { term: 'DTCG Format', category: 'Tokens', def: 'W3C Design Token Community Group JSON format. The standard schema for design tokens. Uses $value, $type, and $description fields. Ensures interoperability across tools and platforms.', source: 'token-engine.js', rule: 'All token files must conform to DTCG schema.' },
  'tonal-surfaces': { term: 'Tonal Surface System', category: 'Tokens', def: 'Material 3-inspired elevation system. Surfaces are differentiated through both color tint and shadow depth, creating a layered interface hierarchy. Five levels (0-4) from base to highest elevation.', source: 'terrarium.css', rule: 'Elevation must combine tonal shift + shadow. Color-only or shadow-only is insufficient.' },
  'google-fonts': { term: 'Google Fonts Library', category: 'Tokens', def: 'Open-source font library integrated via the Google Fonts CSS2 API. Terrarium includes 20 curated typefaces: 12 variable sans-serif fonts (Inter, DM Sans, Space Grotesk, Manrope, Plus Jakarta Sans, Outfit, Sora, Rubik, Nunito, Work Sans, Raleway, IBM Plex Sans), 4 classic sans-serifs (Open Sans, Montserrat, Poppins, Lato), and 4 monospace fonts (JetBrains Mono, Fira Code, Source Code Pro, IBM Plex Mono). All are free for commercial use under OFL or Apache 2.0.', source: 'Google Fonts API', rule: 'Font changes propagate through --t-font-sans and --t-font-mono tokens. Token Steward validates all font changes.' },
  'variable-fonts': { term: 'Variable Fonts', category: 'Tokens', def: 'A single font file containing an entire design space of styles along one or more axes (weight, width, slant, optical size). Enables smooth interpolation between styles and fine-grained control. Most Google Fonts in this system support variable weight (wght: 100-900).', source: 'typography.tokens.json', rule: 'Variable fonts preferred over static weights. Axis ranges must be documented in token metadata.' }
};

function renderWiki(filter) {
  const el = document.getElementById('wikiContent');
  if (!el) return;
  const categories = {};
  Object.entries(WIKI).forEach(([key, entry]) => {
    if (filter) {
      const q = filter.toLowerCase();
      if (!entry.term.toLowerCase().includes(q) && !entry.def.toLowerCase().includes(q) && !entry.category.toLowerCase().includes(q)) return;
    }
    if (!categories[entry.category]) categories[entry.category] = [];
    categories[entry.category].push({ key, ...entry });
  });
  const order = ['Ecosystem', 'Agents', 'Operational', 'Philosophy', 'Lifecycle', 'Tokens'];
  el.innerHTML = order.filter(c => categories[c]).map(cat => {
    return `<div class="wiki-category"><div class="wiki-category__title">${cat}</div>${categories[cat].map(e => `<div class="wiki-entry">
      <div class="wiki-entry__term">${e.term} <span class="wiki-entry__tag">${e.category}</span></div>
      <div class="wiki-entry__def">${e.def}</div>
      <div class="wiki-entry__source">Source: ${e.source}</div>
      ${e.rule ? `<div class="wiki-entry__rule">Rule: ${e.rule}</div>` : ''}
    </div>`).join('')}</div>`;
  }).join('');
}

function filterWiki(query) { renderWiki(query); }

// ============================================================
// SEED VAULT
// ============================================================
const seedVault = [
  { name: 'CalendarGrid', archivedDate: '2024-09-15', reason: 'Insufficient adoption signal at time of review. Only 1 team had integrated.', context: 'Originated from Team Finance. Grid-based date display with keyboard nav. Pattern Librarian flagged for quarterly review.', revivable: true, reviveReason: 'Now 3 teams have expressed need. Cross-pollination with DatePicker detected.', agents: { pl: 'Cross-pollination candidate', ag: 'A11y pattern was sound', ca: 'Solid composition model' } },
  { name: 'ColorPicker', archivedDate: '2024-07-22', reason: 'Scope too broad for a primitive. Architectural review determined it should be a composite of Input + Popover + custom canvas.', context: 'Proposed by Product Liaison from Team Design Tools. Component Architect recommended decomposition into smaller primitives first.', revivable: true, reviveReason: 'Now that Popover is nearing Candidate, the prerequisite is almost met.', agents: { ca: 'Revisit after Popover reaches Stable', ts: 'Token integration plan was strong' } },
  { name: 'Carousel', archivedDate: '2024-05-10', reason: 'Accessibility Guardian exercised absolute veto. Carousels have fundamental a11y challenges: auto-advance conflicts with screen readers, touch swipe lacks keyboard equivalent.', context: 'Proposed by 2 product teams. Passed Nursery but AG vetoed in Workshop after full audit. Alternative: static grid with pagination.', revivable: false, reviveReason: '', agents: { ag: 'VETOED ‚Äî fundamental a11y barrier. Recommend paginated grid.', px: '2 teams redirected to grid+pagination pattern' } },
  { name: 'Breadcrumb', archivedDate: '2024-11-03', reason: 'Pattern Librarian identified overlap with existing Tab + Link primitives. Can be composed without a dedicated component.', context: 'Workshop review found that semantic HTML nav + ordered list + Link component covers all breadcrumb use cases.', revivable: false, reviveReason: '', agents: { pl: 'Composition covers use case', ca: 'No dedicated component needed' } },
  { name: 'Skeleton', archivedDate: '2024-08-18', reason: 'Stalled in Workshop past time-box (3 sprints). Token Steward flagged insufficient semantic token coverage for animation states.', context: 'Loading placeholder pattern. Strong functional need but token system needs animation token support first.', revivable: true, reviveReason: 'Animation token RFC is now in Workshop. When tokens land, Skeleton can re-enter.', agents: { ts: 'Blocked on animation tokens', ds: 'Revive when animation tokens reach Candidate' } }
];

function renderSeedVault() {
  const el = document.getElementById('seedVaultList');
  if (!el) return;
  el.innerHTML = seedVault.map((item, i) => {
    const agentNotes = Object.entries(item.agents).map(([a, note]) => `<span style="color:${AGENT_META[a]?.hex || '#888'};font-weight:600;">${AGENT_META[a]?.short || a}:</span> ${note}`).join('<br>');
    return `<div class="vault-item ${item.revivable ? 'vault-item--revivable' : ''}">
      <div class="vault-item__header">
        <div class="vault-item__name">${item.name}</div>
        <div style="display:flex;gap:4px;">
          ${item.revivable ? '<span class="t-badge t-badge--success" style="font-size:9px;">Revivable</span>' : '<span class="t-badge t-badge--neutral" style="font-size:9px;">Dormant</span>'}
          <span class="t-badge t-badge--neutral" style="font-size:9px;">Archived ${item.archivedDate}</span>
        </div>
      </div>
      <div class="vault-item__reason">${item.reason}</div>
      <div class="vault-item__context">${agentNotes}</div>
      ${item.revivable ? `<div style="margin-top:var(--t-space-2);"><div class="t-caption" style="color:var(--t-raw-green-600);margin-bottom:4px;">Revival conditions: ${item.reviveReason}</div><button class="t-btn t-btn--secondary t-btn--sm" style="font-size:11px;" onclick="reviveFromVault(${i})">Revive to Workshop</button></div>` : ''}
    </div>`;
  }).join('');
}

function reviveFromVault(index) {
  const item = seedVault[index];
  if (!item || !item.revivable) return;
  // Create a lifecycle proposal for revival
  const p = createProposal({
    type: 'lifecycle',
    agent: 'pl',
    targetId: item.name.toLowerCase(),
    zone: 'workshop',
    rationale: `Seed Vault revival: ${item.name}. ${item.reviveReason}`,
    changes: [{ component: item.name.toLowerCase(), from: 'seed-vault', to: 'draft' }],
    approvalsNeeded: ['pl', 'ds'],
    orpa: { observe: 'Conditions have changed since archival', reflect: 'Quarterly review supports revival', plan: 'Re-enter Workshop as Draft', act: 'Submit revival proposal' },
    citations: ['seed-vault-quarterly-review']
  });
  submitProposal(p);
  item.revivable = false;
  renderSeedVault();
  showToast('success', 'Revival Proposed', item.name + ' revival submitted to Approval Queue for your review.');
  gardenerIntervene('revive');
}

// ============================================================
// TOOLTIP ENGINE
// ============================================================
let tipEl = null;

function initTooltips() {
  tipEl = document.createElement('div');
  tipEl.className = 't-tip';
  document.body.appendChild(tipEl);

  document.addEventListener('mouseover', function(e) {
    const target = e.target.closest('[data-tip]');
    if (!target) { tipEl.classList.remove('t-tip--visible'); return; }
    const key = target.getAttribute('data-tip');
    const entry = WIKI[key];
    if (!entry) { tipEl.classList.remove('t-tip--visible'); return; }
    tipEl.innerHTML = `<div class="t-tip__title">${entry.term}</div>${entry.def}${entry.rule ? '<div class="t-tip__source">Rule: ' + entry.rule + '</div>' : ''}`;
    // Position near cursor
    const rect = target.getBoundingClientRect();
    let top = rect.bottom + 8;
    let left = rect.left;
    if (top + 200 > window.innerHeight) top = rect.top - 8 - tipEl.offsetHeight;
    if (left + 320 > window.innerWidth) left = window.innerWidth - 330;
    if (left < 10) left = 10;
    tipEl.style.top = top + 'px';
    tipEl.style.left = left + 'px';
    tipEl.classList.add('t-tip--visible');
  });

  document.addEventListener('mouseout', function(e) {
    const target = e.target.closest('[data-tip]');
    if (target) {
      const related = e.relatedTarget;
      if (!related || !related.closest || !related.closest('[data-tip]')) {
        tipEl.classList.remove('t-tip--visible');
      }
    }
  });
}

// ============================================================
// SIMULATION TRANSCRIPT LOGGER
// ============================================================
function logTranscript(html) {
  const el = document.getElementById('simTranscript');
  if (!el) return;
  el.innerHTML += html + '\n';
  el.scrollTop = el.scrollHeight;
}

function clearTranscript() {
  const el = document.getElementById('simTranscript');
  if (el) el.innerHTML = '';
}

// ============================================================
// EXPORT BUTTON
// ============================================================
document.getElementById('exportBtn').addEventListener('click', () => {
  nav(document.querySelector('[data-target="export"]'));
});

// ============================================================
// INIT
// ============================================================
updatePanel();
updateDynamicContent();
initTooltips();
renderWiki();
renderSeedVault();
renderPipeline();
// Render static canvases on first load
setTimeout(() => {
  renderColors();
  renderTypeScale();
  renderSpacing();
  renderElevation();
  renderButton();
  renderInput();
  renderBadge();
  renderThemeBuilder();
  renderExport();
}, 100);
</script>
</body>
</html>
